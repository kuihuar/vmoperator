# NMState å®˜æ–¹ç¤ºä¾‹å¯¹æ¯”åˆ†æ

## 1. ç½‘ç»œç¤ºä¾‹åˆ†æ

æ ¹æ® [NMState å®˜æ–¹æ–‡æ¡£](https://nmstate.io/examples.html) å’Œç”¨æˆ·æä¾›çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥å¯¹æ¯”åˆ†æä¸€ä¸‹ã€‚

### 1.1 ç”¨æˆ·æä¾›çš„ç¤ºä¾‹

```yaml
interfaces:
  - name: bridge0
    type: linux-bridge
    state: up
    ipv4:
      enabled: true
      address:
        - ip: 192.168.1.100
          prefix-length: 24
      gateway: 192.168.1.1  # ç½‘å…³
      dns:
        - 8.8.8.8           # DNS
    ipv6:
      enabled: false
    bridge:
      options:
        stp:
          enabled: true     # STP å¯ç”¨
      port:
        - name: enp1s0
  - name: enp1s0
    type: ethernet
    state: up
    ipv4:
      enabled: false        # ç¦ç”¨ IP
    ipv6:
      enabled: false
```

### 1.2 æˆ‘ä»¬å½“å‰çš„å®ç°

```yaml
interfaces:
  - name: br-external
    type: linux-bridge
    state: up
    ipv4:
      enabled: true
      dhcp: true            # æˆ–é™æ€ IP
      address:
        - ip: 192.168.0.105
          prefix-length: 24
    bridge:
      options:
        stp:
          enabled: false    # STP ç¦ç”¨ï¼ˆç®€åŒ–é…ç½®ï¼‰
      port:
        - name: ens192
  - name: ens192
    type: ethernet
    state: up
    ipv4:
      enabled: false        # ç¦ç”¨ IP
```

## 2. state å‚æ•°è¯´æ˜

æ ¹æ® [NMState å®˜æ–¹æ–‡æ¡£](https://nmstate.io/examples.html) çš„è¯´æ˜ï¼š

### 2.1 state å‚æ•°çš„ä½œç”¨

- **`state: up`**ï¼šå¯ç”¨æ¥å£ï¼ˆå¯¹äºè™šæ‹Ÿæ¥å£ï¼Œä¹Ÿä¼šåˆ›å»ºå®ƒï¼‰
- **`state: down`**ï¼šç¦ç”¨æ¥å£ï¼ˆå¯¹äºè™šæ‹Ÿæ¥å£ï¼Œä¼šç§»é™¤å®ƒï¼‰
- **`state: absent`**ï¼šåˆ é™¤æ¥å£é…ç½®ï¼ˆå¯¹äºç‰©ç†è®¾å¤‡ï¼Œåªæ˜¯ç§»é™¤é…ç½®ï¼Œä¸ä¼šç‰©ç†åˆ é™¤ï¼‰

### 2.2 ä¸ºä»€ä¹ˆæ¡¥æ¥å’Œç‰©ç†ç½‘å¡éƒ½è®¾ç½®ä¸º `state: up`ï¼Ÿ

**æ¡¥æ¥æ¥å£ (`state: up`)**ï¼š
- æ¡¥æ¥æ¥å£éœ€è¦å¤„äºå¯ç”¨çŠ¶æ€ï¼Œæ‰èƒ½æ­£å¸¸å·¥ä½œ
- `state: up` ç¡®ä¿æ¡¥æ¥æ¥å£è¢«åˆ›å»ºå¹¶å¯ç”¨

**ç‰©ç†ç½‘å¡ (`state: up`)**ï¼š
- ç‰©ç†ç½‘å¡å¿…é¡»ä¿æŒå¯ç”¨çŠ¶æ€ï¼Œæ‰èƒ½ä½œä¸ºæ¡¥æ¥çš„ç«¯å£
- å¦‚æœç‰©ç†ç½‘å¡è¢«ç¦ç”¨ï¼ˆ`state: down`ï¼‰ï¼Œæ¡¥æ¥æ— æ³•æ­£å¸¸å·¥ä½œ
- **å…³é”®ç‚¹**ï¼šè™½ç„¶ç‰©ç†ç½‘å¡ `state: up`ï¼Œä½† `ipv4.enabled: false`ï¼Œè¡¨ç¤ºç¦ç”¨ IP é…ç½®ï¼ˆIP åœ¨æ¡¥æ¥ä¸Šï¼‰

## 3. ç¤ºä¾‹çš„å‚è€ƒä»·å€¼

### 3.1 âœ… å®Œå…¨ä¸€è‡´çš„é…ç½®

1. **æ¡¥æ¥æ¥å£ `state: up`**
   - âœ… æˆ‘ä»¬çš„å®ç°ï¼š`state: "up"`
   - âœ… å®˜æ–¹ç¤ºä¾‹ï¼š`state: up`
   - **ç»“è®º**ï¼šæ­£ç¡®

2. **ç‰©ç†ç½‘å¡ `state: up` + `ipv4.enabled: false`**
   - âœ… æˆ‘ä»¬çš„å®ç°ï¼š`state: "up"` + `ipv4.enabled: false`
   - âœ… å®˜æ–¹ç¤ºä¾‹ï¼š`state: up` + `ipv4.enabled: false`
   - **ç»“è®º**ï¼šæ­£ç¡®ï¼Œè¿™æ˜¯æ ‡å‡†çš„é…ç½®æ–¹å¼

3. **æ¡¥æ¥é…ç½®ç‰©ç†ç½‘å¡ä½œä¸ºç«¯å£**
   - âœ… æˆ‘ä»¬çš„å®ç°ï¼š`bridge.port: [{name: ens192}]`
   - âœ… å®˜æ–¹ç¤ºä¾‹ï¼š`bridge.port: [{name: enp1s0}]`
   - **ç»“è®º**ï¼šæ­£ç¡®

### 3.2 âš ï¸ éœ€è¦æ³¨æ„çš„å·®å¼‚

#### å·®å¼‚ 1ï¼šSTP é…ç½®

**å®˜æ–¹ç¤ºä¾‹**ï¼š
```yaml
stp:
  enabled: true
```

**æˆ‘ä»¬çš„å®ç°**ï¼š
```yaml
stp:
  enabled: false
```

**è¯´æ˜**ï¼š
- å®˜æ–¹ç¤ºä¾‹å¯ç”¨äº† STPï¼ˆç”Ÿæˆæ ‘åè®®ï¼‰
- æˆ‘ä»¬çš„å®ç°ç¦ç”¨äº† STPï¼ˆç®€åŒ–é…ç½®ï¼‰
- **ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥**ï¼Œå–å†³äºç½‘ç»œç¯å¢ƒéœ€æ±‚
- STP ä¸»è¦ç”¨äºé˜²æ­¢æ¡¥æ¥ç¯è·¯ï¼Œåœ¨ç®€å•ç¯å¢ƒä¸­å¯ä»¥ç¦ç”¨

#### å·®å¼‚ 2ï¼šç½‘å…³å’Œ DNS é…ç½®ä½ç½®

**å®˜æ–¹ç¤ºä¾‹**ï¼š
```yaml
ipv4:
  address:
    - ip: 192.168.1.100
      prefix-length: 24
  gateway: 192.168.1.1      # åœ¨æ¥å£çº§åˆ«é…ç½®ç½‘å…³
  dns:
    - 8.8.8.8               # åœ¨æ¥å£çº§åˆ«é…ç½® DNS
```

**æˆ‘ä»¬çš„å®ç°**ï¼š
```yaml
ipv4:
  address:
    - ip: 192.168.0.105
      prefix-length: 24
  # æ²¡æœ‰ gateway å’Œ dns å­—æ®µ
```

**è¯´æ˜**ï¼š
- å®˜æ–¹ç¤ºä¾‹åœ¨æ¥å£çº§åˆ«é…ç½®äº† `gateway` å’Œ `dns`
- æ ¹æ® [NMState æ–‡æ¡£](https://nmstate.io/examples.html)ï¼Œç½‘å…³å’Œ DNS é€šå¸¸åº”è¯¥é€šè¿‡è·¯ç”±ï¼ˆroutesï¼‰å’Œ DNS è§£æå™¨ï¼ˆdns-resolverï¼‰é…ç½®ï¼Œè€Œä¸æ˜¯åœ¨æ¥å£çº§åˆ«
- **æˆ‘ä»¬çš„å®ç°æ˜¯æ­£ç¡®çš„**ï¼Œç½‘å…³å’Œ DNS ç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼ˆé€šè¿‡è·¯ç”±è¡¨å’Œ DNS é…ç½®ï¼‰
- å¦‚æœéœ€è¦åœ¨ç­–ç•¥çº§åˆ«é…ç½®è·¯ç”±å’Œ DNSï¼Œå¯ä»¥åœ¨ `desiredState` ä¸­æ·»åŠ  `routes` å’Œ `dns-resolver` å­—æ®µ

#### å·®å¼‚ 3ï¼šIPv6 é…ç½®

**å®˜æ–¹ç¤ºä¾‹**ï¼š
```yaml
ipv6:
  enabled: false
```

**æˆ‘ä»¬çš„å®ç°**ï¼š
```yaml
# æ²¡æœ‰é…ç½® ipv6
```

**è¯´æ˜**ï¼š
- å®˜æ–¹ç¤ºä¾‹æ˜ç¡®ç¦ç”¨äº† IPv6
- æˆ‘ä»¬çš„å®ç°æ²¡æœ‰é…ç½® IPv6ï¼ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼‰
- **ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥**ï¼Œå–å†³äºç½‘ç»œç¯å¢ƒéœ€æ±‚

## 4. å‚è€ƒä»·å€¼æ€»ç»“

### 4.1 âœ… éå¸¸æœ‰å‚è€ƒä»·å€¼çš„éƒ¨åˆ†

1. **`state: up` çš„ä½¿ç”¨**ï¼š
   - âœ… æ¡¥æ¥å’Œç‰©ç†ç½‘å¡éƒ½åº”è¯¥è®¾ç½®ä¸º `state: up`
   - âœ… è¿™éªŒè¯äº†æˆ‘ä»¬çš„å®ç°æ˜¯æ­£ç¡®çš„

2. **ç‰©ç†ç½‘å¡ IP ç¦ç”¨**ï¼š
   - âœ… `ipv4.enabled: false` ç”¨äºç¦ç”¨ç‰©ç†ç½‘å¡çš„ IP
   - âœ… è¿™æ˜¯æ ‡å‡†çš„æ¡¥æ¥é…ç½®æ–¹å¼

3. **æ¥å£é…ç½®é¡ºåº**ï¼š
   - âœ… å…ˆé…ç½®æ¡¥æ¥æ¥å£ï¼Œå†é…ç½®ç‰©ç†ç½‘å¡æ¥å£
   - âœ… è¿™ä¸æˆ‘ä»¬çš„å®ç°ä¸€è‡´

### 4.2 âš ï¸ éœ€è¦æ³¨æ„çš„å·®å¼‚

1. **STP é…ç½®**ï¼š
   - å®˜æ–¹ç¤ºä¾‹å¯ç”¨äº† STP
   - æˆ‘ä»¬çš„å®ç°ç¦ç”¨äº† STPï¼ˆç®€åŒ–é…ç½®ï¼‰
   - **å»ºè®®**ï¼šæ ¹æ®ç½‘ç»œç¯å¢ƒé€‰æ‹©ï¼Œç®€å•ç¯å¢ƒå¯ä»¥ç¦ç”¨

2. **ç½‘å…³å’Œ DNS**ï¼š
   - å®˜æ–¹ç¤ºä¾‹åœ¨æ¥å£çº§åˆ«é…ç½®ï¼ˆ**ä¸æ¨è**ï¼‰
   - åº”è¯¥åœ¨ `routes` å’Œ `dns-resolver` çº§åˆ«é…ç½®ï¼ˆå¦‚æœéœ€è¦åœ¨ç­–ç•¥ä¸­é…ç½®ï¼‰
   - æˆ‘ä»¬çš„å®ç°ä¾èµ–ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼ˆ**æ›´æ¨è**ï¼‰

### 4.3 ğŸ“ å®˜æ–¹æ¨èçš„é…ç½®æ–¹å¼

æ ¹æ® [NMState å®˜æ–¹æ–‡æ¡£](https://nmstate.io/examples.html)ï¼Œæ›´æ¨èçš„é…ç½®æ–¹å¼æ˜¯ï¼š

```yaml
interfaces:
  - name: bridge0
    type: linux-bridge
    state: up
    ipv4:
      enabled: true
      dhcp: true            # æˆ–é™æ€ IP
      address:
        - ip: 192.168.1.100
          prefix-length: 24
    bridge:
      options:
        stp:
          enabled: false    # æˆ– trueï¼Œå–å†³äºç¯å¢ƒ
      port:
        - name: enp1s0
  - name: enp1s0
    type: ethernet
    state: up
    ipv4:
      enabled: false        # å…³é”®ï¼šç¦ç”¨ç‰©ç†ç½‘å¡çš„ IP

routes:                     # è·¯ç”±é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  config:
    - destination: 0.0.0.0/0
      next-hop-address: 192.168.1.1
      next-hop-interface: bridge0

dns-resolver:               # DNS é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  config:
    server:
      - 8.8.8.8
```

## 5. ç»“è®º

ç”¨æˆ·æä¾›çš„ç¤ºä¾‹**éå¸¸æœ‰å‚è€ƒä»·å€¼**ï¼Œç‰¹åˆ«æ˜¯ï¼š

1. âœ… **éªŒè¯äº†æˆ‘ä»¬çš„å®ç°æ­£ç¡®æ€§**ï¼š
   - `state: up` çš„ä½¿ç”¨æ–¹å¼
   - `ipv4.enabled: false` ç”¨äºç¦ç”¨ç‰©ç†ç½‘å¡ IP
   - æ¥å£é…ç½®çš„ç»“æ„å’Œé¡ºåº

2. âœ… **æä¾›äº†æœ€ä½³å®è·µå‚è€ƒ**ï¼š
   - å±•ç¤ºäº†æ ‡å‡†çš„æ¡¥æ¥é…ç½®æ–¹å¼
   - å±•ç¤ºäº†å¦‚ä½•æ­£ç¡®å¤„ç†ç‰©ç†ç½‘å¡

3. âš ï¸ **éœ€è¦æ³¨æ„çš„å·®å¼‚**ï¼š
   - STP é…ç½®å¯ä»¥æ ¹æ®ç¯å¢ƒé€‰æ‹©
   - ç½‘å…³å’Œ DNS åº”è¯¥åœ¨ç³»ç»Ÿçº§åˆ«æˆ–ç­–ç•¥çš„è·¯ç”±/DNS é…ç½®ä¸­ç®¡ç†ï¼Œè€Œä¸æ˜¯åœ¨æ¥å£çº§åˆ«

**æ€»ç»“**ï¼šæˆ‘ä»¬çš„å®ç°ä¸å®˜æ–¹ç¤ºä¾‹åœ¨æ ¸å¿ƒé€»è¾‘ä¸Šå®Œå…¨ä¸€è‡´ï¼Œç¬¦åˆ NMState çš„æœ€ä½³å®è·µã€‚ä¸»è¦å·®å¼‚åœ¨äºä¸€äº›å¯é€‰é…ç½®ï¼ˆSTPã€IPv6ã€ç½‘å…³/DNSï¼‰ï¼Œè¿™äº›å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ã€‚

