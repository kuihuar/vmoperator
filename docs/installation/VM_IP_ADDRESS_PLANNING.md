# VM IP 地址规划指南

## 1. IP 地址选择依据

### 1.1 示例配置中的 IP 地址

在 `vm_v1alpha1_wukong_dual_network.yaml` 中使用的 IP 地址：

```yaml
# 管理网络
address: "192.168.100.10/24"  # 管理网络 IP
gateway: "192.168.100.1"      # 管理网络网关

# 外网网络
address: "192.168.1.200/24"   # 外网 IP
gateway: "192.168.1.1"       # 外网网关
```

**这些是示例 IP，不是固定的！** 需要根据你的实际网络环境调整。

### 1.2 为什么选择这些网段？

#### 192.168.100.x（管理网络）

- **用途**：管理网络，用于 SSH、监控、管理操作
- **选择依据**：
  - `192.168.100.x` 是常见的**管理网络网段**
  - 与业务网络（通常是 `192.168.1.x`）分离，便于管理
  - 避免与常见的家庭/办公网络（`192.168.1.x`）冲突
- **可替换为**：
  - `10.0.100.x`（企业内网常用）
  - `172.16.100.x`（私有网络）
  - 任何你网络中**未被使用**的网段

#### 192.168.1.x（外网网络）

- **用途**：外网访问，用于访问互联网
- **选择依据**：
  - `192.168.1.x` 是**最常见的家庭/办公网络网段**
  - 如果你的路由器/网关是 `192.168.1.1`，使用这个网段可以直接访问外网
- **可替换为**：
  - 根据你的实际网络环境选择
  - 检查你的路由器/网关 IP：
    ```bash
    ip route show default
    # 或
    route -n | grep "^0.0.0.0"
    ```

## 2. 如何选择合适的 IP 地址

### 2.1 检查现有网络环境

#### 步骤 1：查看节点网络配置

```bash
# 查看节点 IP 地址
ip addr show

# 查看路由表
ip route show

# 查看默认网关
ip route show default
```

**示例输出：**
```
default via 192.168.1.1 dev ens160
192.168.1.0/24 dev ens160 proto kernel scope link src 192.168.1.141
```

#### 步骤 2：检查 IP 地址是否被占用

```bash
# 检查 IP 是否被占用（ping）
ping -c 1 192.168.100.10
ping -c 1 192.168.1.200

# 如果 ping 不通，说明 IP 可能可用（但也要检查 ARP 表）
arp -a | grep 192.168.100.10
arp -a | grep 192.168.1.200

# 扫描网段（需要安装 nmap）
nmap -sn 192.168.100.0/24
nmap -sn 192.168.1.0/24
```

#### 步骤 3：检查 DHCP 范围

```bash
# 查看路由器 DHCP 配置（通常在路由器管理界面）
# 或检查 DHCP 服务器配置

# 例如，如果 DHCP 范围是 192.168.1.100-192.168.1.200
# 那么 192.168.1.200 可能被 DHCP 分配，应该避免使用
```

### 2.2 IP 地址选择原则

#### ✅ 推荐做法

1. **使用静态 IP 范围**：
   - 在 DHCP 范围之外选择 IP
   - 例如：DHCP 是 `192.168.1.100-199`，使用 `192.168.1.200+`

2. **使用专用管理网段**：
   - 管理网络使用独立的网段（如 `192.168.100.x`）
   - 避免与业务网络冲突

3. **记录 IP 分配**：
   - 维护一个 IP 分配表
   - 避免多个 VM 使用相同 IP

4. **使用 VLAN 隔离**：
   - 如果网络支持 VLAN，使用 VLAN 隔离不同网络
   - 例如：管理网络 VLAN 100，业务网络 VLAN 200

#### ❌ 避免的做法

1. **使用 DHCP 范围内的 IP**：
   - 可能导致 IP 冲突
   - DHCP 服务器可能分配相同的 IP

2. **使用网关 IP**：
   - 网关通常是 `.1`（如 `192.168.1.1`）
   - 不要使用网关 IP 作为 VM IP

3. **使用广播地址**：
   - 广播地址通常是 `.255`（如 `192.168.1.255`）
   - 不要使用广播地址

4. **使用网络地址**：
   - 网络地址通常是 `.0`（如 `192.168.1.0`）
   - 不要使用网络地址

## 3. 常见网络场景

### 3.1 场景 1：家庭/办公网络（单网段）

**网络环境：**
- 网关：`192.168.1.1`
- 网段：`192.168.1.0/24`
- DHCP 范围：`192.168.1.100-199`

**推荐配置：**

```yaml
networks:
  # 管理网络（使用独立网段，通过 VLAN 或物理隔离）
  - name: management
    type: bridge
    vlanId: 100  # 使用 VLAN 隔离
    ipConfig:
      mode: static
      address: "192.168.100.10/24"
      gateway: "192.168.100.1"
  
  # 外网网络（使用主网段，在 DHCP 范围外）
  - name: external
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.200/24"  # 在 DHCP 范围外
      gateway: "192.168.1.1"
```

### 3.2 场景 2：企业网络（多网段）

**网络环境：**
- 管理网络：`10.0.100.0/24`，网关 `10.0.100.1`
- 业务网络：`10.0.200.0/24`，网关 `10.0.200.1`
- 外网网络：`192.168.1.0/24`，网关 `192.168.1.1`

**推荐配置：**

```yaml
networks:
  # 管理网络
  - name: management
    type: bridge
    ipConfig:
      mode: static
      address: "10.0.100.10/24"
      gateway: "10.0.100.1"
  
  # 业务网络
  - name: business
    type: bridge
    ipConfig:
      mode: static
      address: "10.0.200.10/24"
      gateway: "10.0.200.1"
  
  # 外网网络
  - name: external
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.200/24"
      gateway: "192.168.1.1"
```

### 3.3 场景 3：测试环境（单网段，无 VLAN）

**网络环境：**
- 网关：`192.168.1.1`
- 网段：`192.168.1.0/24`
- 无 VLAN 支持

**推荐配置：**

```yaml
networks:
  # 只使用一个网络（外网网络）
  - name: default
  
  - name: external
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.200/24"  # 确保在 DHCP 范围外
      gateway: "192.168.1.1"
```

## 4. IP 地址规划表

### 4.1 创建 IP 分配表

建议维护一个 IP 分配表，避免冲突：

| VM 名称 | 管理网络 IP | 外网网络 IP | 用途 | 备注 |
|---------|------------|------------|------|------|
| ubuntu-vm-01 | 192.168.100.10 | 192.168.1.200 | 测试 | - |
| ubuntu-vm-02 | 192.168.100.11 | 192.168.1.201 | 测试 | - |
| prod-vm-01 | 10.0.100.10 | 10.0.200.10 | 生产 | - |

### 4.2 IP 地址范围规划

**管理网络（192.168.100.0/24）：**
- `.1`：网关（如果使用）
- `.2-.9`：保留
- `.10-.99`：VM 管理 IP
- `.100-.254`：其他设备

**外网网络（192.168.1.0/24）：**
- `.1`：网关
- `.2-.99`：其他设备
- `.100-.199`：DHCP 范围（避免使用）
- `.200-.254`：VM 静态 IP

## 5. 验证 IP 配置

### 5.1 创建前检查

```bash
# 1. 检查 IP 是否被占用
ping -c 1 192.168.100.10
ping -c 1 192.168.1.200

# 2. 检查网关是否可达
ping -c 1 192.168.100.1
ping -c 1 192.168.1.1

# 3. 检查路由
ip route get 192.168.100.10
ip route get 192.168.1.200
```

### 5.2 创建后验证

```bash
# 1. 查看 VM IP
kubectl get vmi ubuntu-vm-dual-network -o jsonpath='{.status.interfaces[*].ipAddress}'

# 2. 测试网络连接
ssh ubuntu@192.168.100.10
ssh ubuntu@192.168.1.200

# 3. 在 VM 内检查
ip addr show
ip route show
```

## 6. 常见问题

### Q1: 可以使用任意 IP 地址吗？

**A:** 不可以。需要：
1. 确保 IP 在正确的网段内（与网关在同一网段）
2. 确保 IP 未被占用
3. 确保 IP 不在 DHCP 范围内
4. 确保 IP 不是网关、广播或网络地址

### Q2: 如何知道我的网络网段？

**A:** 检查节点网络配置：
```bash
ip addr show
# 查看 inet 后面的 IP 和子网掩码
# 例如：inet 192.168.1.141/24 表示网段是 192.168.1.0/24
```

### Q3: 如果 IP 冲突了怎么办？

**A:** 
1. 检查是否有其他设备使用了相同 IP
2. 修改 VM 配置中的 IP 地址
3. 重新应用配置（VM 需要重启才能生效）

### Q4: 可以使用 DHCP 吗？

**A:** 可以。将 `mode` 设置为 `dhcp`：
```yaml
ipConfig:
  mode: dhcp
  # 不需要指定 address 和 gateway
```

### Q5: 多个 VM 可以使用相同的 IP 吗？

**A:** 不可以。每个 VM 的每个网络接口必须有唯一的 IP 地址。

## 7. 总结

**关键要点：**

1. ✅ **IP 地址不是固定的**，需要根据实际网络环境调整
2. ✅ **检查现有网络**：查看节点 IP、网关、DHCP 范围
3. ✅ **避免冲突**：确保 IP 未被占用，不在 DHCP 范围内
4. ✅ **使用规划表**：维护 IP 分配表，避免重复使用
5. ✅ **验证配置**：创建前后都要验证 IP 配置

**示例配置中的 IP 只是示例，必须根据你的实际网络环境修改！**

