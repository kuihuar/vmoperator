# VM 桥接网络配置说明

## 需求

1. **KubeVirt 创建的 VM 需要配置 IP**
2. **VM 需要通过 ens192 访问外网**

## 当前实现（已满足需求）

### 配置示例

```yaml
networks:
  - name: external
    type: bridge
    bridgeName: "br-external"
    physicalInterface: "ens192"
    nodeIP: "192.168.0.121/24"     # 节点 IP（在桥接上）
    ipConfig:
      mode: static
      address: "192.168.0.200/24"  # VM IP（在 VM 内部）
      gateway: "192.168.0.1"
      dnsServers:
        - "192.168.0.1"
```

### 两个 IP 的作用

1. **`nodeIP: "192.168.0.121/24"`** - **节点 IP**
   - 配置在桥接 `br-external` 上
   - 确保节点网络不中断
   - 节点通过桥接访问外网

2. **`ipConfig.address: "192.168.0.200/24"`** - **VM IP**
   - 通过 Cloud-Init 配置在 VM 内部
   - VM 通过桥接访问外网

## 工作流程

```
┌─────────────────────────────────────────────────┐
│                   节点                           │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │      Linux Bridge (br-external)          │  │
│  │      IP: 192.168.0.121/24  ← 节点 IP    │  │
│  │                                          │  │
│  │  ┌──────────┐      ┌──────────────┐    │  │
│  │  │  ens192  │      │  VM (tap)    │    │  │
│  │  │ (port)   │      │  IP: 192.168.│    │  │
│  │  │          │      │  0.200/24    │    │  │
│  │  └──────────┘      └──────────────┘    │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
└─────────────────────────────────────────────────┘
         │                    │
         └────────┬───────────┘
                  │
         ┌─────────▼─────────┐
         │   外网 (网关)      │
         │   192.168.0.1      │
         └────────────────────┘
```

### 步骤说明

1. **NMState 创建桥接**
   - 创建 `br-external` 桥接
   - 将 `ens192` 作为桥接端口
   - 在桥接上配置节点 IP `192.168.0.121/24`

2. **Multus 创建 NAD**
   - 创建 NetworkAttachmentDefinition
   - VM 通过 Multus 连接到桥接

3. **Cloud-Init 配置 VM IP**
   - 在 VM 内部配置 IP `192.168.0.200/24`
   - 配置网关和 DNS

4. **网络访问**
   - 节点通过桥接访问外网（IP: 192.168.0.121/24）
   - VM 通过桥接访问外网（IP: 192.168.0.200/24）

## 验证方法

### 1. 检查节点网络

```bash
# 桥接应该有节点 IP
ip addr show br-external
# 应该看到：inet 192.168.0.121/24

# 物理网卡作为桥接端口，无 IP
ip addr show ens192
# 应该看到：master br-external，但没有 inet
```

### 2. 检查 VM 网络（在 VM 内）

```bash
# VM 应该有配置的 IP
ip addr show
# 应该看到：inet 192.168.0.200/24

# VM 可以访问外网
ping 8.8.8.8
ping 192.168.0.1
```

### 3. 检查节点网络

```bash
# 节点可以访问外网
ping 8.8.8.8
```

## 重要说明

### 关于 ens192 的 IP 配置

**❌ 误解**：ens192 必须改成 DHCP

**✅ 事实**：
- **不需要改成 DHCP**
- IP 仍然是静态 IP `192.168.0.121/24`
- IP 从 ens192 迁移到桥接（这是 Linux Bridge 的标准做法）
- 节点通过桥接访问网络，功能完全正常

### 为什么 IP 要迁移到桥接？

这是 **Linux Bridge 的标准做法**：
- 桥接是 L2 设备，IP 应该配置在桥接上
- 物理网卡作为桥接端口，不应该有 IP
- 这样节点和 VM 都能通过桥接访问网络

### 两个 IP 的关系

- **节点 IP** (`nodeIP`): 确保节点网络不中断
- **VM IP** (`ipConfig.address`): VM 在桥接网络中的 IP
- **两者在同一个网段**：可以互相通信
- **都通过桥接访问外网**：共享同一个物理网卡

## 配置要点

1. **`nodeIP` 必须配置**：确保节点网络不中断
2. **`ipConfig.address` 必须配置**：VM 的 IP 地址
3. **两者必须在同一网段**：例如都是 `192.168.0.0/24`
4. **网关必须正确**：`192.168.0.1`

## 总结

✅ **当前实现已满足需求**：
- VM 可以配置 IP（通过 Cloud-Init）
- VM 可以通过 ens192 访问外网（通过桥接）
- 节点网络不中断（IP 在桥接上）
- 不需要改成 DHCP（仍然是静态 IP）

