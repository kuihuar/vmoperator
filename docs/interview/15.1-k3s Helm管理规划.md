# k3s Helm 管理规划

## 1. 概述

k3s 是轻量级 Kubernetes 发行版，通常通过官方安装脚本部署。但可以通过 Helm 管理配置和扩展。

## 2. 当前安装方式

### 2.1 脚本安装
```bash
# 使用官方脚本
curl -sfL https://get.k3s.io | sh -

# 或使用项目脚本
./docs/installation/install-k3s-only.sh
```

### 2.2 配置管理
- 配置文件: `/etc/rancher/k3s/config.yaml`
- systemd 服务: `/etc/systemd/system/k3s.service`
- kubeconfig: `/etc/rancher/k3s/k3s.yaml`

## 3. Helm 管理方案

### 3.1 方案一：配置管理 Chart

创建 `charts/k3s-config` Chart，用于管理 k3s 配置：

```yaml
# charts/k3s-config/values.yaml
config:
  # 集群配置
  cluster:
    cidr: "10.42.0.0/16"
    serviceCidr: "10.43.0.0/16"
    clusterDns: "10.43.0.10"
  
  # TLS 配置
  tls:
    san:
      - "192.168.1.141"
      - "k3s.example.com"
  
  # 禁用组件
  disable:
    - "servicelb"  # 可选
  
  # 数据目录
  dataDir: "/var/lib/rancher/k3s"
  
  # 网络配置
  flannel:
    backend: "vxlan"
  
  # 存储配置
  defaultLocalStoragePath: "/var/lib/rancher/k3s/storage"
```

### 3.2 方案二：使用 Helm 管理 Add-ons

k3s 支持通过 Helm Chart 安装 Add-ons：

```yaml
# charts/k3s-addons/values.yaml
addons:
  # Traefik Ingress
  traefik:
    enabled: true
    version: "latest"
  
  # Metrics Server
  metricsServer:
    enabled: true
  
  # Local Path Provisioner
  localPath:
    enabled: false  # 使用 Longhorn 替代
```

## 4. 实施建议

### 4.1 保持脚本安装
- k3s 核心仍使用官方脚本安装
- Helm Chart 仅管理配置和 Add-ons

### 4.2 配置管理
```bash
# 使用 Helm 管理配置
helm install k3s-config ./charts/k3s-config \
  --set config.cluster.cidr=10.42.0.0/16 \
  --set config.cluster.serviceCidr=10.43.0.0/16
```

### 4.3 配置更新
```bash
# 更新配置后重启 k3s
helm upgrade k3s-config ./charts/k3s-config
sudo systemctl restart k3s
```

## 5. Chart 结构

```
charts/k3s-config/
├── Chart.yaml
├── values.yaml
└── templates/
    ├── configmap.yaml      # k3s 配置
    └── addons/             # Add-ons 配置
        ├── traefik.yaml
        └── metrics-server.yaml
```

## 6. 注意事项

- k3s 核心安装仍依赖官方脚本
- Helm Chart 主要用于配置管理
- 配置变更需要重启 k3s 服务
- 生产环境建议使用配置文件而非 Helm

