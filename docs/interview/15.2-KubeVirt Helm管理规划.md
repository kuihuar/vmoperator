# KubeVirt Helm 管理规划

## 1. 概述

KubeVirt 是 Kubernetes 的虚拟机管理 Operator，提供官方 Helm Chart。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://kubevirt.io/charts`
- **Chart Name**: `kubevirt`
- **最新版本**: 1.0.0+

### 2.2 安装方式
```bash
# 添加仓库
helm repo add kubevirt https://kubevirt.io/charts
helm repo update

# 安装 KubeVirt
helm install kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --create-namespace \
  --version 1.0.0
```

## 3. Values 配置

### 3.1 基础配置
```yaml
# values-kubevirt.yaml
# KubeVirt Operator 配置
operator:
  image:
    repository: quay.io/kubevirt/virt-operator
    tag: v1.0.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# KubeVirt Controller 配置
controller:
  image:
    repository: quay.io/kubevirt/virt-controller
    tag: v1.0.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# KubeVirt Handler (DaemonSet) 配置
handler:
  image:
    repository: quay.io/kubevirt/virt-handler
    tag: v1.0.0
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# 功能开关
featureGates:
  # 启用实时迁移
  LiveMigration: true
  # 启用热插拔
  HotplugVolumes: true
  # 启用快照
  Snapshot: true
  # 启用克隆
  Clone: true

# 网络配置
network:
  # 默认网络类型
  defaultNetworkType: "bridge"
  
  # Multus 支持
  multus:
    enabled: true

# 存储配置
storage:
  # 默认存储类
  defaultStorageClass: "longhorn"
  
  # 数据卷支持
  dataVolume:
    enabled: true
```

### 3.2 生产环境配置
```yaml
# values-kubevirt-prod.yaml
operator:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

controller:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# 启用所有功能
featureGates:
  LiveMigration: true
  HotplugVolumes: true
  Snapshot: true
  Clone: true
  GPU: true
  HostDevices: true

# 节点选择器
nodeSelector:
  node-type: compute

# 容忍度
tolerations:
  - key: "kubevirt"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
```

## 4. 部署命令

### 4.1 开发环境
```bash
helm install kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --create-namespace \
  --version 1.0.0 \
  --set featureGates.LiveMigration=false
```

### 4.2 生产环境
```bash
helm install kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --create-namespace \
  --version 1.0.0 \
  -f values-kubevirt-prod.yaml
```

## 5. 验证安装

```bash
# 检查 Pod 状态
kubectl get pods -n kubevirt-system

# 检查 CRD
kubectl get crd | grep kubevirt.io

# 检查版本
kubectl get kubevirt kubevirt -n kubevirt-system -o yaml
```

## 6. 升级

```bash
# 升级 KubeVirt
helm upgrade kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --version 1.1.0 \
  -f values-kubevirt-prod.yaml
```

## 7. 卸载

```bash
# 卸载 KubeVirt（注意：会删除所有 VM）
helm uninstall kubevirt --namespace kubevirt-system
```

## 8. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加依赖：

```yaml
dependencies:
  - name: kubevirt
    version: "1.0.0"
    repository: "https://kubevirt.io/charts"
    condition: kubevirt.enabled
```

在 `values.yaml` 中配置：

```yaml
kubevirt:
  enabled: true
  operator:
    replicas: 2
  featureGates:
    LiveMigration: true
```

