# 开发环境配置

## 1. 禁用 Webhook（开发环境）

在开发环境中，可以禁用 Webhook 验证以简化部署和调试。

### 1.1 方法一：通过命令行参数

在 Manager Deployment 中添加 `--enable-webhook=false` 参数：

```yaml
# config/manager/manager.yaml
containers:
- name: manager
  args:
    - --leader-elect
    - --health-probe-bind-address=:8081
    - --enable-webhook=false  # 禁用 Webhook
```

### 1.2 方法二：使用 Kustomize Patch

创建 patch 文件 `config/default/manager_webhook_disable_patch.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller-manager
  namespace: system
spec:
  template:
    spec:
      containers:
      - name: manager
        args:
        - --enable-webhook=false
```

在 `config/default/kustomization.yaml` 中添加：

```yaml
patches:
- path: manager_webhook_disable_patch.yaml
  target:
    kind: Deployment
```

### 1.3 方法三：不部署 Webhook 资源

在 `config/default/kustomization.yaml` 中注释掉 webhook 资源：

```yaml
resources:
- ../crd
- ../rbac
- ../manager
# - ../webhook  # 注释掉，不部署 Webhook 配置
```

**注意**: 如果使用此方法，还需要注释掉 webhook patch：

```yaml
patches:
# - path: manager_webhook_patch.yaml  # 注释掉
#   target:
#     kind: Deployment
```

## 2. 环境变量控制

### 2.1 使用环境变量

可以通过环境变量控制：

```yaml
containers:
- name: manager
  env:
  - name: ENABLE_WEBHOOK
    value: "false"
  args:
    - --enable-webhook=$(ENABLE_WEBHOOK)
```

### 2.2 开发环境配置示例

创建 `config/development/kustomization.yaml`：

```yaml
namespace: novasphere-system
namePrefix: novasphere-

resources:
- ../crd
- ../rbac
- ../manager
# 不包含 webhook

patches:
- path: manager_webhook_disable_patch.yaml
  target:
    kind: Deployment
```

## 3. 验证方式对比

### 3.1 Webhook 启用时

```
用户创建/更新资源
    ↓
CRD Schema 验证
    ↓
Mutating Webhook（设置默认值）
    ↓
Validating Webhook（验证资源）
    ↓
资源创建/更新
    ↓
Controller Reconcile
```

### 3.2 Webhook 禁用时

```
用户创建/更新资源
    ↓
CRD Schema 验证
    ↓
资源创建/更新
    ↓
Controller Reconcile（包含验证和默认值设置）
```

## 4. 开发环境建议

### 4.1 推荐配置

1. **禁用 Webhook**: 简化部署，避免证书管理
2. **保留 CRD Schema 验证**: 基本验证仍然有效
3. **Controller 验证**: 业务逻辑验证在 Controller 中完成

### 4.2 配置文件

**开发环境** (`config/development/kustomization.yaml`):
```yaml
resources:
- ../crd
- ../rbac
- ../manager
# 不包含 webhook

patches:
- path: manager_webhook_disable_patch.yaml
  target:
    kind: Deployment
```

**生产环境** (`config/default/kustomization.yaml`):
```yaml
resources:
- ../crd
- ../rbac
- ../manager
- ../webhook  # 启用 Webhook

patches:
- path: manager_webhook_patch.yaml
  target:
    kind: Deployment
```

## 5. 部署命令

### 5.1 开发环境

```bash
# 禁用 Webhook 部署
kubectl apply -k config/development
```

### 5.2 生产环境

```bash
# 启用 Webhook 部署
kubectl apply -k config/default
```

## 6. 验证 Webhook 状态

### 6.1 检查 Manager 参数

```bash
kubectl get deployment -n novasphere-system novasphere-controller-manager -o jsonpath='{.spec.template.spec.containers[0].args}'
```

### 6.2 检查 Webhook 配置

```bash
# 如果 Webhook 启用，应该能看到配置
kubectl get mutatingwebhookconfiguration
kubectl get validatingwebhookconfiguration

# 如果 Webhook 禁用，应该看不到或配置为空
```

## 7. 注意事项

### 7.1 默认值设置

- **Webhook 启用**: 默认值在 Webhook 中设置
- **Webhook 禁用**: 需要在 Controller 中设置默认值（当前未实现）

### 7.2 验证时机

- **Webhook 启用**: 在资源创建前验证，立即拒绝无效请求
- **Webhook 禁用**: 在 Controller Reconcile 时验证，资源已创建但可能处于错误状态

### 7.3 证书管理

- **Webhook 启用**: 需要证书管理（cert-manager 或自签名证书）
- **Webhook 禁用**: 不需要证书管理

## 8. 面试要点

### 8.1 为什么在开发环境禁用 Webhook？

**答案**:
- 简化部署，避免证书管理
- 加快开发迭代速度
- 减少调试复杂度

### 8.2 禁用 Webhook 后验证如何工作？

**答案**:
- CRD Schema 验证仍然有效
- Controller 中的验证逻辑仍然执行
- 只是缺少了 API Server 层面的立即验证

### 8.3 如何切换开发/生产环境？

**答案**:
- 使用不同的 kustomization 配置
- 通过命令行参数控制
- 使用环境变量控制

