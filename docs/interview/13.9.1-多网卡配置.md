# 多网卡配置

## 1. 功能概述

### 1.1 多网卡配置
为 VM 配置多个网络接口，每个接口可以有不同的类型、VLAN、IP 配置等。

**使用场景**:
- 业务网络和管理网络分离
- 多租户网络隔离
- 不同业务使用不同网络
- 网络性能优化

### 1.2 网络类型
- **Bridge**: 桥接网络（默认）
- **Macvlan**: Macvlan 网络（直接连接到物理网络）
- **SR-IOV**: SR-IOV 网络（高性能）
- **OVS**: Open vSwitch 网络（软件定义网络）

## 2. 当前实现状态

### 2.1 已实现
- ✅ **多网卡支持**: 通过 `Networks` 数组支持多个网络接口
- ✅ **网络类型**: 支持 bridge、macvlan、sriov、ovs
- ✅ **VLAN支持**: 支持 VLAN 配置
- ✅ **Multus集成**: 支持 Multus CNI 多网络

### 2.2 待完善
- ⚠️ **网络优先级**: 主网络和辅助网络区分
- ⚠️ **路由配置**: 多网卡路由配置
- ⚠️ **网络状态查询**: 查询每个网络接口状态
- ⚠️ **网络绑定验证**: 验证网络配置有效性

## 3. 技术实现

### 3.1 当前实现

```go
// api/v1alpha1/wukong_types.go

type WukongSpec struct {
    // Networks 定义多个网络接口
    Networks []NetworkConfig `json:"networks,omitempty"`
}

type NetworkConfig struct {
    Name     string         `json:"name"`
    Type     string         `json:"type"`  // bridge, macvlan, sriov, ovs
    NADName  string         `json:"nadName,omitempty"`
    VLANID   *int           `json:"vlanId,omitempty"`
    IPConfig *IPConfigSpec  `json:"ipConfig,omitempty"`
}
```

### 3.2 多网卡配置示例

```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-nic-vm
spec:
  cpu: 2
  memory: 4Gi
  networks:
  # 主网络（管理网络）
  - name: eth0
    type: bridge
    ipConfig:
      mode: dhcp
  # 业务网络
  - name: eth1
    type: macvlan
    vlanId: 100
    ipConfig:
      mode: static
      address: "10.0.1.100/24"
      gateway: "10.0.1.1"
  # 存储网络
  - name: eth2
    type: bridge
    vlanId: 200
    ipConfig:
      mode: static
      address: "192.168.1.100/24"
```

## 4. API 设计扩展

### 4.1 网络优先级

```go
// api/v1alpha1/wukong_types.go

type NetworkConfig struct {
    // ... 现有字段 ...
    
    // Primary 是否为主网络（第一个网络默认为主网络）
    // +optional
    Primary bool `json:"primary,omitempty"`
    
    // Priority 网络优先级（数字越小优先级越高）
    // +optional
    Priority *int `json:"priority,omitempty"`
    
    // MTU 最大传输单元
    // +optional
    MTU *int `json:"mtu,omitempty"`
}
```

### 4.2 路由配置

```go
// api/v1alpha1/wukong_types.go

type NetworkConfig struct {
    // ... 现有字段 ...
    
    // Routes 静态路由配置
    // +optional
    Routes []RouteConfig `json:"routes,omitempty"`
}

type RouteConfig struct {
    // Destination 目标网络（CIDR格式）
    Destination string `json:"destination"`
    
    // Gateway 网关地址
    Gateway string `json:"gateway"`
    
    // Metric 路由优先级（数字越小优先级越高）
    // +optional
    Metric *int `json:"metric,omitempty"`
}
```

### 4.3 Status 扩展

```go
// api/v1alpha1/wukong_types.go

type NetworkStatus struct {
    // ... 现有字段 ...
    
    // InterfaceName VM 内的接口名称（如 eth0, eth1）
    // +optional
    InterfaceName string `json:"interfaceName,omitempty"`
    
    // MACAddress MAC 地址
    // +optional
    MACAddress string `json:"macAddress,omitempty"`
    
    // IPAddress 实际分配的 IP 地址
    // +optional
    IPAddress string `json:"ipAddress,omitempty"`
    
    // State 网络状态: Up, Down, Unknown
    // +optional
    State string `json:"state,omitempty"`
}
```

## 5. Controller 实现

### 5.1 多网卡处理

```go
// internal/controller/wukong_controller.go

func (r *WukongReconciler) reconcileNetworks(ctx context.Context, vmp *vmv1alpha1.Wukong) error {
    logger := log.FromContext(ctx)
    
    // 1. 验证网络配置
    if err := r.validateNetworks(ctx, vmp); err != nil {
        return err
    }
    
    // 2. 设置默认主网络
    if len(vmp.Spec.Networks) > 0 && !hasPrimaryNetwork(vmp.Spec.Networks) {
        vmp.Spec.Networks[0].Primary = true
    }
    
    // 3. 创建/更新 NAD
    networksStatus, err := network.ReconcileNetworks(ctx, r.Client, vmp)
    if err != nil {
        return err
    }
    
    // 4. 配置路由（如果需要）
    if err := r.configureRoutes(ctx, vmp, networksStatus); err != nil {
        logger.Error(err, "failed to configure routes")
        // 路由配置失败不影响网络创建
    }
    
    // 5. 更新状态
    vmp.Status.Networks = networksStatus
    return r.Status().Update(ctx, vmp)
}

func (r *WukongReconciler) validateNetworks(ctx context.Context, vmp *vmv1alpha1.Wukong) error {
    // 1. 检查网络名称唯一性
    names := make(map[string]bool)
    for _, net := range vmp.Spec.Networks {
        if names[net.Name] {
            return fmt.Errorf("duplicate network name: %s", net.Name)
        }
        names[net.Name] = true
    }
    
    // 2. 检查主网络数量（只能有一个主网络）
    primaryCount := 0
    for _, net := range vmp.Spec.Networks {
        if net.Primary {
            primaryCount++
        }
    }
    if primaryCount > 1 {
        return fmt.Errorf("only one primary network is allowed")
    }
    
    // 3. 验证网络配置
    for i, net := range vmp.Spec.Networks {
        if err := r.validateNetworkConfig(ctx, net, vmp.Namespace); err != nil {
            return fmt.Errorf("network[%d] %s: %w", i, net.Name, err)
        }
    }
    
    return nil
}
```

### 5.2 路由配置

```go
// pkg/network/routes.go

func ConfigureRoutes(ctx context.Context, c client.Client, vmp *vmv1alpha1.Wukong, networks []vmv1alpha1.NetworkStatus) error {
    // 构建路由配置（通过 Cloud-Init 或 NMState）
    routes := make([]RouteConfig, 0)
    
    for _, net := range vmp.Spec.Networks {
        if len(net.Routes) > 0 {
            routes = append(routes, net.Routes...)
        }
    }
    
    if len(routes) == 0 {
        return nil
    }
    
    // 通过 Cloud-Init 配置路由
    return configureRoutesViaCloudInit(ctx, c, vmp, routes)
}

func configureRoutesViaCloudInit(ctx context.Context, c client.Client, vmp *vmv1alpha1.Wukong, routes []RouteConfig) error {
    // 构建 Cloud-Init 路由配置
    cloudInitData := buildRoutesCloudInit(routes)
    
    // 更新 Cloud-Init 配置（需要重新生成 Cloud-Init 数据）
    // 这里简化处理，实际需要更新 VirtualMachine 的 Cloud-Init 配置
    
    return nil
}
```

## 6. 使用示例

### 6.1 基本多网卡配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-nic-vm
spec:
  cpu: 2
  memory: 4Gi
  networks:
  - name: eth0
    type: bridge
    primary: true
    ipConfig:
      mode: dhcp
  - name: eth1
    type: macvlan
    ipConfig:
      mode: static
      address: "10.0.1.100/24"
```

### 6.2 带路由的多网卡配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-nic-vm
spec:
  networks:
  - name: eth0
    type: bridge
    primary: true
    ipConfig:
      mode: dhcp
  - name: eth1
    type: macvlan
    ipConfig:
      mode: static
      address: "10.0.1.100/24"
    routes:
    - destination: "192.168.0.0/16"
      gateway: "10.0.1.1"
      metric: 100
```

### 6.3 多VLAN网络配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-vlan-vm
spec:
  networks:
  - name: eth0
    type: bridge
    primary: true
    ipConfig:
      mode: dhcp
  - name: eth1
    type: bridge
    vlanId: 100
    ipConfig:
      mode: static
      address: "192.168.100.100/24"
  - name: eth2
    type: bridge
    vlanId: 200
    ipConfig:
      mode: static
      address: "192.168.200.100/24"
```

## 7. 注意事项

### 7.1 网络配置
- 确保网络名称唯一
- 主网络通常用于默认路由
- 多网卡需要正确配置路由
- 验证网络配置有效性

### 7.2 性能考虑
- 多网卡可能影响性能
- 选择合适的网络类型
- 考虑网络带宽需求
- 监控网络性能

### 7.3 安全考虑
- 不同网络使用不同安全策略
- 管理网络和业务网络隔离
- 配置网络访问控制
- 定期审查网络配置

## 8. 面试要点

### 8.1 为什么需要多网卡配置？

**答案**:
- **网络隔离**: 不同业务使用不同网络，提高安全性
- **性能优化**: 分离数据流量和管理流量，提高性能
- **灵活配置**: 根据需求灵活配置网络
- **多租户支持**: 支持多租户网络隔离

### 8.2 如何配置多网卡的路由？

**答案**:
- 通过 Cloud-Init 配置静态路由
- 通过 NMState 配置路由
- 设置默认路由到主网络
- 为每个网络配置特定路由规则

### 8.3 多网卡的性能影响？

**答案**:
- 每个网卡占用资源
- 网络处理可能成为瓶颈
- 选择合适的网络类型（SR-IOV 性能更好）
- 监控网络性能指标

