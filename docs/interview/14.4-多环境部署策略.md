# 多环境部署策略

## 1. 环境划分

### 1.1 开发环境 (Development)
- **用途**: 本地开发、调试
- **特点**: 
  - Webhook 禁用
  - 资源要求低
  - 快速迭代

### 1.2 测试环境 (Testing)
- **用途**: 功能测试、集成测试
- **特点**:
  - Webhook 启用
  - 接近生产配置
  - 自动化测试

### 1.3 生产环境 (Production)
- **用途**: 正式运行环境
- **特点**:
  - 完整功能
  - 高可用配置
  - 安全加固

## 2. Values 文件组织

### 2.1 文件结构
```
charts/novasphere/
├── values.yaml          # 默认配置（基础配置）
├── values-dev.yaml      # 开发环境覆盖
├── values-test.yaml     # 测试环境覆盖
└── values-prod.yaml     # 生产环境覆盖
```

### 2.2 继承关系
```
values.yaml (基础)
    ├── values-dev.yaml (开发覆盖)
    ├── values-test.yaml (测试覆盖)
    └── values-prod.yaml (生产覆盖)
```

## 3. 开发环境配置

### 3.1 values-dev.yaml
```yaml
# 开发环境配置
image:
  repository: controller
  tag: latest
  pullPolicy: IfNotPresent

namespace:
  create: true
  name: novasphere-dev

webhook:
  enabled: false                    # 禁用 Webhook

manager:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 64Mi
    requests:
      cpu: 10m
      memory: 32Mi

metrics:
  enabled: false                    # 可选：禁用 Metrics

rbac:
  create: true
  wukongRoles:
    enabled: true
```

### 3.2 部署命令
```bash
# 方式 1: 使用 values-dev.yaml
helm install novasphere-dev ./charts/novasphere \
  -f charts/novasphere/values-dev.yaml \
  --namespace novasphere-dev \
  --create-namespace

# 方式 2: 使用 make deploy（保持兼容）
make deploy IMG=controller:latest
```

## 4. 测试环境配置

### 4.1 values-test.yaml
```yaml
# 测试环境配置
image:
  repository: myregistry/novasphere
  tag: v1.0.0-test
  pullPolicy: Always

namespace:
  create: true
  name: novasphere-test

webhook:
  enabled: true
  selfSigned:
    enabled: true

manager:
  replicas: 1
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

metrics:
  enabled: true

rbac:
  create: true
  wukongRoles:
    enabled: true
```

### 4.2 部署命令
```bash
helm install novasphere-test ./charts/novasphere \
  -f charts/novasphere/values-test.yaml \
  --namespace novasphere-test \
  --create-namespace
```

## 5. 生产环境配置

### 5.1 values-prod.yaml
```yaml
# 生产环境配置
image:
  repository: myregistry/novasphere
  tag: v1.0.0
  pullPolicy: Always

namespace:
  create: true
  name: novasphere-system

webhook:
  enabled: true
  certManager:
    enabled: true                    # 使用 cert-manager

manager:
  replicas: 2                        # 高可用
  resources:
    limits:
      cpu: 1000m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

metrics:
  enabled: true

rbac:
  create: true
  wukongRoles:
    enabled: true

# 节点选择器
nodeSelector:
  node-type: compute

# 容忍度
tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "novasphere"
    effect: "NoSchedule"

# 亲和性
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - novasphere
        topologyKey: kubernetes.io/hostname
```

### 5.2 部署命令
```bash
helm install novasphere ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml \
  --namespace novasphere-system \
  --create-namespace \
  --set image.tag=v1.0.0
```

## 6. 环境切换策略

### 6.1 使用 Helm Release 名称区分
```bash
# 开发环境
helm install novasphere-dev ./charts/novasphere \
  -f charts/novasphere/values-dev.yaml \
  --namespace novasphere-dev

# 测试环境
helm install novasphere-test ./charts/novasphere \
  -f charts/novasphere/values-test.yaml \
  --namespace novasphere-test

# 生产环境
helm install novasphere ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml \
  --namespace novasphere-system
```

### 6.2 使用命名空间隔离
- 每个环境使用独立的命名空间
- 避免资源冲突
- 便于权限管理

## 7. Makefile 集成

### 7.1 添加 Helm 目标
```makefile
# Helm 相关变量
HELM ?= helm
CHART_PATH ?= ./charts/novasphere
RELEASE_NAME ?= novasphere
NAMESPACE ?= novasphere-system

# Helm 部署（开发环境）
.PHONY: helm-deploy-dev
helm-deploy-dev: ## Deploy using Helm (development)
	$(HELM) install $(RELEASE_NAME)-dev $(CHART_PATH) \
		-f $(CHART_PATH)/values-dev.yaml \
		--namespace novasphere-dev \
		--create-namespace

# Helm 部署（生产环境）
.PHONY: helm-deploy-prod
helm-deploy-prod: ## Deploy using Helm (production)
	$(HELM) install $(RELEASE_NAME) $(CHART_PATH) \
		-f $(CHART_PATH)/values-prod.yaml \
		--namespace $(NAMESPACE) \
		--create-namespace \
		--set image.repository=$(IMG_REPO) \
		--set image.tag=$(IMG_TAG)

# Helm 卸载
.PHONY: helm-undeploy
helm-undeploy: ## Undeploy using Helm
	$(HELM) uninstall $(RELEASE_NAME) --namespace $(NAMESPACE)
```

## 8. CI/CD 集成

### 8.1 GitHub Actions 示例
```yaml
name: Deploy to Environments

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Dev
        run: |
          helm upgrade --install novasphere-dev ./charts/novasphere \
            -f ./charts/novasphere/values-dev.yaml \
            --namespace novasphere-dev \
            --create-namespace

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Prod
        run: |
          helm upgrade --install novasphere ./charts/novasphere \
            -f ./charts/novasphere/values-prod.yaml \
            --namespace novasphere-system \
            --create-namespace \
            --set image.tag=${{ github.sha }}
```

## 9. 最佳实践

### 9.1 配置管理
- ✅ 使用 Values 文件管理环境差异
- ✅ 避免在模板中硬编码环境特定配置
- ✅ 使用 `--set` 覆盖敏感配置

### 9.2 版本控制
- ✅ 每个环境使用独立的镜像标签
- ✅ 生产环境使用语义化版本
- ✅ 测试环境可以使用 commit SHA

### 9.3 安全
- ✅ 生产环境使用 cert-manager 管理证书
- ✅ 使用 Kubernetes Secrets 管理敏感信息
- ✅ 限制 RBAC 权限

### 9.4 监控
- ✅ 所有环境启用 Metrics
- ✅ 生产环境配置告警
- ✅ 记录部署历史

