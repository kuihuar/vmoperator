# 调度能力总览

## 1. 功能概述

调度能力允许控制 VM 在集群中的调度行为，包括节点选择、亲和性、污点容忍、资源分配等。

## 2. 功能列表

| 功能 | 优先级 | 复杂度 | 业务价值 | 当前状态 |
|------|--------|--------|----------|----------|
| **节点亲和性** | 高 | 中 | 高 | 部分实现 |
| **节点反亲和性** | 高 | 中 | 高 | 部分实现 |
| **污点/容忍度** | 高 | 低 | 高 | 部分实现 |
| **Pod 亲和性** | 中 | 中 | 中 | 待实现 |
| **Pod 反亲和性** | 中 | 中 | 中 | 部分实现 |
| **资源亲和性** | 中 | 中 | 中 | 待实现 |
| **调度策略** | 中 | 高 | 中 | 待实现 |
| **自定义调度器** | 低 | 高 | 低 | 待实现 |

## 3. 当前实现状态

### 3.1 已实现
- ✅ **NodeSelector**: 通过 `HighAvailability.NodeSelector` 支持
- ✅ **Tolerations**: 通过 `HighAvailability.Tolerations` 支持
- ✅ **AntiAffinity**: 通过 `HighAvailability.AntiAffinity` 支持（简单布尔值）

### 3.2 待实现
- ❌ **完整亲和性配置**: 支持 required/preferred 亲和性
- ❌ **Pod 亲和性**: Pod 之间的亲和性配置
- ❌ **资源亲和性**: 基于资源（CPU、内存、存储）的亲和性
- ❌ **调度策略**: 自定义调度规则和策略
- ❌ **调度器扩展**: 支持自定义调度器

## 4. 技术实现方式

### 4.1 Kubernetes 原生支持

#### Node Affinity
```yaml
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/arch
          operator: In
          values:
          - amd64
```

#### Pod Affinity
```yaml
affinity:
  podAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchLabels:
          app: database
      topologyKey: kubernetes.io/hostname
```

#### Tolerations
```yaml
tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoSchedule"
```

## 5. 功能分类

### 5.1 节点调度类
- **节点亲和性**: 调度到特定节点
- **节点反亲和性**: 避免调度到特定节点
- **污点/容忍度**: 处理节点污点

### 5.2 Pod 调度类
- **Pod 亲和性**: 与其他 Pod 一起调度
- **Pod 反亲和性**: 与其他 Pod 分开调度

### 5.3 资源调度类
- **资源亲和性**: 基于资源的调度
- **资源限制**: 资源请求和限制

### 5.4 策略调度类
- **调度策略**: 自定义调度规则
- **调度器扩展**: 支持自定义调度器

## 6. 实现优先级

### 第一阶段（核心功能）
1. **节点亲和性完善** - 支持完整亲和性配置
2. **节点反亲和性完善** - 支持完整反亲和性配置
3. **污点/容忍度完善** - 完善污点处理

### 第二阶段（增强功能）
4. **Pod 亲和性** - 实现 Pod 间亲和性
5. **Pod 反亲和性** - 实现 Pod 间反亲和性

### 第三阶段（高级特性）
6. **资源亲和性** - 基于资源的调度
7. **调度策略** - 自定义调度规则

## 7. 文档结构

- **[13.10.1-节点亲和性与反亲和性.md](./13.10.1-节点亲和性与反亲和性.md)** - 节点亲和性和反亲和性详解
- **[13.10.2-污点与容忍度.md](./13.10.2-污点与容忍度.md)** - 污点和容忍度详解
- **[13.10.3-Pod亲和性与反亲和性.md](./13.10.3-Pod亲和性与反亲和性.md)** - Pod 亲和性和反亲和性详解
- **[13.10.4-资源亲和性与调度策略.md](./13.10.4-资源亲和性与调度策略.md)** - 资源亲和性和调度策略详解

## 8. 使用示例

### 8.1 节点亲和性
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
spec:
  scheduling:
    nodeAffinity:
      required:
      - key: kubernetes.io/arch
        operator: In
        values: [amd64]
```

### 8.2 污点容忍度
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
spec:
  scheduling:
    tolerations:
    - key: "gpu"
      operator: "Equal"
      value: "true"
      effect: "NoSchedule"
```

## 9. 注意事项

### 9.1 调度约束
- 过多的调度约束可能导致无法调度
- 需要合理配置亲和性规则
- 提供调度失败诊断

### 9.2 性能影响
- 亲和性规则可能影响调度性能
- 需要优化调度规则
- 监控调度延迟

## 10. 面试要点

### 10.1 为什么需要调度能力？

**答案**:
- **资源优化**: 合理分配资源，提高利用率
- **高可用**: 通过反亲和性实现高可用
- **性能优化**: 将 VM 调度到合适的节点
- **成本控制**: 根据节点类型和成本调度

### 10.2 节点亲和性和节点选择器的区别？

**答案**:
- **节点选择器**: 简单键值匹配，必须满足
- **节点亲和性**: 更灵活，支持 required/preferred，支持复杂表达式

### 10.3 如何实现高可用部署？

**答案**:
- 使用 Pod 反亲和性，确保 VM 分布在不同节点
- 使用节点亲和性，选择稳定的节点
- 配置多个副本
- 使用健康检查确保服务可用

