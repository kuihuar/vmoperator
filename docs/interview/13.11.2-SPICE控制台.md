# SPICE 控制台

## 1. 功能概述

### 1.1 SPICE 控制台
通过 SPICE（Simple Protocol for Independent Computing Environments）协议提供高性能的 VM 图形界面远程访问。

**使用场景**:
- 高性能远程桌面
- 多媒体应用
- 需要音频的应用
- USB 设备重定向

### 1.2 SPICE 特点
- **高性能**: 比 VNC 性能更好
- **音频支持**: 支持音频重定向
- **USB 重定向**: 支持 USB 设备重定向
- **客户端要求**: 需要支持 SPICE 的客户端

## 2. 当前实现状态

### 2.1 已实现
- ❌ 无 SPICE 功能

### 2.2 待实现
- ❌ **SPICE 配置**: 启用和配置 SPICE
- ❌ **SPICE 访问**: 提供 SPICE 访问接口
- ❌ **音频支持**: 音频重定向配置
- ❌ **USB 重定向**: USB 设备重定向

## 3. 技术实现

### 3.1 KubeVirt 支持

KubeVirt 支持 SPICE，配置方式类似 VNC：

```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
spec:
  domain:
    devices:
      graphics:
      - type: SPICE
        autoAttach: true
        listen:
          address: "0.0.0.0"
          type: address
      sound:
        model: ac97
      inputs:
      - type: tablet
        bus: usb
```

### 3.2 实现方案

```go
// pkg/kubevirt/console.go

func buildSPICEGraphics(vmp *vmv1alpha1.Wukong) []kubevirtv1.Graphics {
    if vmp.Spec.Console == nil || 
       vmp.Spec.Console.SPICE == nil ||
       !vmp.Spec.Console.SPICE.Enabled {
        return nil
    }
    
    spice := kubevirtv1.Graphics{
        Type:       "SPICE",
        AutoAttach: true,
    }
    
    if vmp.Spec.Console.SPICE.Port != nil {
        spice.Port = vmp.Spec.Console.SPICE.Port
    }
    
    if vmp.Spec.Console.SPICE.ListenAddress != nil {
        spice.Listen = &kubevirtv1.Listener{
            Address: *vmp.Spec.Console.SPICE.ListenAddress,
            Type:    "address",
        }
    }
    
    return []kubevirtv1.Graphics{spice}
}

func buildSPICEDevices(vmp *vmv1alpha1.Wukong) ([]kubevirtv1.Sound, []kubevirtv1.Input) {
    if vmp.Spec.Console == nil || 
       vmp.Spec.Console.SPICE == nil ||
       !vmp.Spec.Console.SPICE.Enabled {
        return nil, nil
    }
    
    var sounds []kubevirtv1.Sound
    var inputs []kubevirtv1.Input
    
    // 音频支持
    if vmp.Spec.Console.SPICE.Audio != nil && vmp.Spec.Console.SPICE.Audio.Enabled {
        sounds = append(sounds, kubevirtv1.Sound{
            Model: vmp.Spec.Console.SPICE.Audio.Model,
        })
    }
    
    // USB 重定向
    if vmp.Spec.Console.SPICE.USB != nil && vmp.Spec.Console.SPICE.USB.Enabled {
        inputs = append(inputs, kubevirtv1.Input{
            Type: "tablet",
            Bus:  "usb",
        })
    }
    
    return sounds, inputs
}
```

## 4. API 设计

### 4.1 SPICEConfig 扩展

```go
// api/v1alpha1/wukong_types.go

type SPICEConfig struct {
    // Enabled 是否启用 SPICE
    Enabled bool `json:"enabled"`
    
    // Port SPICE 端口（默认 5900）
    // +optional
    Port *int32 `json:"port,omitempty"`
    
    // ListenAddress 监听地址
    // +optional
    ListenAddress *string `json:"listenAddress,omitempty"`
    
    // Audio 音频配置
    // +optional
    Audio *AudioConfig `json:"audio,omitempty"`
    
    // USB USB 重定向配置
    // +optional
    USB *USBConfig `json:"usb,omitempty"`
    
    // TLS TLS 加密配置
    // +optional
    TLS *TLSConfig `json:"tls,omitempty"`
}

type AudioConfig struct {
    // Enabled 是否启用音频
    Enabled bool `json:"enabled"`
    
    // Model 音频模型: ac97, ich9
    // +optional
    Model string `json:"model,omitempty"`
}

type USBConfig struct {
    // Enabled 是否启用 USB 重定向
    Enabled bool `json:"enabled"`
    
    // Redirect USB 重定向模式: all, specific
    // +optional
    Redirect string `json:"redirect,omitempty"`
}
```

## 5. 使用示例

### 5.1 基本 SPICE 配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: spice-vm
spec:
  console:
    spice:
      enabled: true
```

### 5.2 带音频的 SPICE
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: audio-vm
spec:
  console:
    spice:
      enabled: true
      audio:
        enabled: true
        model: ac97
```

### 5.3 带 USB 重定向的 SPICE
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: usb-vm
spec:
  console:
    spice:
      enabled: true
      usb:
        enabled: true
        redirect: all
```

## 6. 访问方式

### 6.1 通过 virtctl
```bash
# 启动 SPICE 代理
virtctl spice <vm-name> -n <namespace>
```

### 6.2 通过 SPICE 客户端
```bash
# 使用 remote-viewer 连接
remote-viewer spice://<host>:<port>
```

## 7. 注意事项

### 7.1 客户端要求
- 需要支持 SPICE 的客户端（如 remote-viewer）
- 某些功能需要客户端支持
- 检查客户端版本兼容性

### 7.2 性能优化
- SPICE 性能优于 VNC
- 支持压缩和优化
- 考虑网络带宽

### 7.3 USB 重定向
- 需要客户端支持
- 可能有安全风险
- 需要合理配置

## 8. 面试要点

### 8.1 SPICE 和 VNC 的区别？

**答案**:
- **SPICE**: 性能更好，支持音频和 USB，但需要专用客户端
- **VNC**: 简单兼容，但性能较低，不支持音频

### 8.2 如何选择 VNC 还是 SPICE？

**答案**:
- **VNC**: 简单场景，不需要音频/USB
- **SPICE**: 高性能需求，需要音频/USB 重定向

### 8.3 SPICE 的音频支持如何实现？

**答案**:
- 在 VirtualMachineInstance 中配置 Sound 设备
- 使用 ac97 或 ich9 音频模型
- 客户端需要支持音频重定向

