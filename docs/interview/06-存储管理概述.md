# 存储管理概述

## 1. 存储架构

VM Operator 支持两种存储方式：
- **PVC**: 直接创建 PersistentVolumeClaim（空磁盘）
- **DataVolume**: 使用 CDI 从容器镜像导入数据（带数据的磁盘）

### 1.1 存储组件

```
Wukong Spec
    ↓
DiskConfig (用户定义)
    ↓
PVC 或 DataVolume (存储资源)
    ↓
Longhorn StorageClass
    ↓
PersistentVolume (Longhorn Volume)
    ↓
KubeVirt VM (挂载磁盘)
```

### 1.2 存储流程

```
1. 用户定义 DiskConfig
   ↓
2. Controller 调用 storage.ReconcileDisks()
   ↓
3. 判断是否有 Image
   ├── 有 Image → 创建 DataVolume
   └── 无 Image → 创建 PVC
   ↓
4. 等待卷绑定
   ↓
5. 返回 VolumeStatus
   ↓
6. 在 KubeVirt VM 中挂载磁盘
```

## 2. 存储类型

### 2.1 PVC 方式

**适用场景**: 创建空磁盘

```yaml
disks:
  - name: data
    size: 500Gi
    storageClassName: longhorn
```

**特点**:
- 直接创建 PVC
- 快速创建
- 磁盘为空

### 2.2 DataVolume 方式

**适用场景**: 从容器镜像创建磁盘

```yaml
disks:
  - name: system
    size: 80Gi
    storageClassName: longhorn
    image: quay.io/containerdisks/ubuntu:22.04
```

**特点**:
- 使用 CDI 导入镜像
- 创建时间较长
- 磁盘包含操作系统

## 3. 关键代码位置

- **存储协调**: `pkg/storage/reconcile.go` - `ReconcileDisks()`
- **PVC 创建**: `pkg/storage/pvc.go` - `ReconcilePVC()`
- **DataVolume 创建**: `pkg/storage/datavolume.go` - `ReconcileDataVolume()`
- **磁盘扩展**: `pkg/storage/expand.go` - `ReconcileDiskExpansion()`

## 4. 存储状态

### 4.1 VolumeStatus

```go
type VolumeStatus struct {
    Name    string `json:"name"`              // 磁盘名称
    PVCName string `json:"pvcName,omitempty"` // PVC 名称
    Bound   bool   `json:"bound,omitempty"`   // 是否已绑定
    Size    string `json:"size,omitempty"`     // 磁盘大小
}
```

### 4.2 状态更新

- **创建时**: 记录 PVC 名称，Bound 为 false
- **绑定后**: Bound 更新为 true
- **扩展时**: Size 更新为新大小

## 5. 磁盘扩展

### 5.1 扩展流程

```
1. 用户修改 DiskConfig.Size
   ↓
2. Controller 检测到大小变化
   ↓
3. 调用 storage.ReconcileDiskExpansion()
   ↓
4. 更新 PVC 的 storage 字段
   ↓
5. 等待扩展完成
```

### 5.2 扩展限制

- 只能扩展，不能缩小
- 需要 StorageClass 支持扩展
- Longhorn 支持在线扩展

## 6. 存储示例

### 6.1 多磁盘配置

```yaml
disks:
  - name: system
    size: 80Gi
    storageClassName: longhorn
    image: quay.io/containerdisks/ubuntu:22.04
    boot: true
  - name: data
    size: 500Gi
    storageClassName: longhorn
```

### 6.2 不同 StorageClass

```yaml
disks:
  - name: system
    size: 80Gi
    storageClassName: longhorn-ssd
    boot: true
  - name: data
    size: 1Ti
    storageClassName: longhorn-hdd
```

## 7. 面试要点

### 7.1 PVC 和 DataVolume 的区别？

**答案**:
- **PVC**: 直接创建空磁盘，快速但需要手动安装系统
- **DataVolume**: 从容器镜像导入数据，慢但包含操作系统
- 选择依据：是否需要预装操作系统

### 7.2 如何判断使用哪种方式？

**答案**:
- 检查 `DiskConfig.Image` 字段
- 如果指定了 `image`，使用 DataVolume
- 如果未指定，使用 PVC

### 7.3 磁盘扩展的实现？

**答案**:
1. 检测 `DiskConfig.Size` 变化
2. 更新 PVC 的 `spec.resources.requests.storage`
3. 等待 StorageClass 完成扩展
4. 更新 VolumeStatus.Size

