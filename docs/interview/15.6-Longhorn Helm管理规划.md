# Longhorn Helm 管理规划

## 1. 概述

Longhorn 是分布式块存储系统，提供官方 Helm Chart。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://charts.longhorn.io`
- **Chart Name**: `longhorn`
- **最新版本**: 1.8.1+

### 2.2 安装方式
```bash
# 添加仓库
helm repo add longhorn https://charts.longhorn.io
helm repo update

# 安装 Longhorn
helm install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace \
  --version 1.8.1
```

## 3. Values 配置

### 3.1 基础配置
```yaml
# values-longhorn.yaml
# 持久化配置
persistence:
  # 数据路径（默认 /var/lib/longhorn）
  defaultDataPath: "/var/lib/longhorn"
  
  # 自定义数据路径（用于数据盘）
  defaultDataPath: "/data/longhorn"

# Manager 配置
longhornManager:
  image:
    repository: longhornio/longhorn-manager
    tag: v1.8.1
  
  replicas: 1  # DaemonSet，每个节点一个
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi

# UI 配置
longhornUI:
  image:
    repository: longhornio/longhorn-ui
    tag: v1.8.1
  
  replicas: 2
  
  resources:
    limits:
      cpu: 200m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Engine 配置
longhornEngine:
  image:
    repository: longhornio/longhorn-engine
    tag: v1.8.1

# Instance Manager 配置
longhornInstanceManager:
  image:
    repository: longhornio/longhorn-instance-manager
    tag: v1.8.1

# CSI Driver 配置
csi:
  attacher:
    image: longhornio/csi-attacher
    tag: v4.0.0
  
  provisioner:
    image: longhornio/csi-provisioner
    tag: v3.5.0
  
  resizer:
    image: longhornio/csi-resizer
    tag: v1.8.0
  
  snapshotter:
    image: longhornio/csi-snapshotter
    tag: v6.2.0

# 默认设置
defaultSettings:
  # 禁用 revision counter（v1.8.1 不支持）
  disableRevisionCounter: "false"
  
  # 默认副本数
  defaultReplicaCount: "3"
  
  # 默认数据位置
  defaultDataLocality: "disabled"
  
  # 存储类名称
  defaultLonghornStaticStorageClass: "longhorn-static"

# 存储类配置
defaultClass:
  enabled: true
  isDefaultClass: true
  reclaimPolicy: Delete
  allowVolumeExpansion: true
  volumeBindingMode: Immediate
```

### 3.2 数据盘配置
```yaml
# values-longhorn-datadisk.yaml
persistence:
  # 使用数据盘
  defaultDataPath: "/data/longhorn"

# 节点配置（通过 Node 标签）
nodeSelector:
  storage: "longhorn"

# 容忍度
tolerations:
  - key: "storage"
    operator: "Equal"
    value: "longhorn"
    effect: "NoSchedule"
```

### 3.3 生产环境配置
```yaml
# values-longhorn-prod.yaml
longhornManager:
  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 512Mi

longhornUI:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# 高可用配置
defaultSettings:
  defaultReplicaCount: "3"
  defaultDataLocality: "disabled"
  staleReplicaTimeout: "2880"  # 48 小时

# 备份配置
backup:
  enabled: true
  s3:
    endpoint: "s3.example.com"
    bucketName: "longhorn-backup"
    accessKey: ""  # 使用 Secret
    secretKey: ""  # 使用 Secret
```

## 4. 部署命令

### 4.1 开发环境
```bash
helm install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace \
  --version 1.8.1
```

### 4.2 生产环境（使用数据盘）
```bash
helm install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace \
  --version 1.8.1 \
  -f values-longhorn-prod.yaml \
  --set persistence.defaultDataPath=/data/longhorn
```

## 5. 验证安装

```bash
# 检查 Pod 状态
kubectl get pods -n longhorn-system

# 检查 StorageClass
kubectl get storageclass longhorn

# 检查 Longhorn UI
kubectl get svc -n longhorn-system longhorn-frontend

# 访问 UI（端口转发）
kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80
```

## 6. 配置数据盘

### 6.1 通过节点标签
```bash
# 标记节点
kubectl label node <node-name> storage=longhorn

# 配置数据路径
kubectl patch node <node-name> --type merge \
  -p '{"metadata":{"annotations":{"longhorn.io/default-data-path":"/data/longhorn"}}}'
```

### 6.2 通过 Helm Values
```yaml
persistence:
  defaultDataPath: "/data/longhorn"
```

## 7. 升级

```bash
# 升级 Longhorn
helm upgrade longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --version 1.8.2 \
  -f values-longhorn-prod.yaml
```

## 8. 卸载

```bash
# 卸载 Longhorn（注意：会删除所有数据）
helm uninstall longhorn --namespace longhorn-system
```

## 9. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加依赖：

```yaml
dependencies:
  - name: longhorn
    version: "1.8.1"
    repository: "https://charts.longhorn.io"
    condition: longhorn.enabled
```

在 `values.yaml` 中配置：

```yaml
longhorn:
  enabled: true
  persistence:
    defaultDataPath: "/data/longhorn"
  defaultSettings:
    disableRevisionCounter: "false"
    defaultReplicaCount: "3"
```

## 10. 依赖关系

- **依赖**: 无（独立组件）
- **被依赖**: Novasphere Operator（使用 Longhorn 存储）

**部署顺序**:
1. Longhorn
2. Novasphere Operator

