# 串行控制台

## 1. 功能概述

### 1.1 串行控制台
通过串行接口提供 VM 的文本界面访问，类似于物理服务器的串口控制台。

**使用场景**:
- 命令行管理
- 故障排查
- 系统启动调试
- 无图形界面系统

### 1.2 串行控制台特点
- **简单**: 文本界面，资源占用少
- **稳定**: 不依赖网络图形协议
- **通用**: 所有系统都支持
- **高效**: 带宽需求低

## 2. 当前实现状态

### 2.1 已实现
- ❌ 无串行控制台功能

### 2.2 待实现
- ❌ **串行控制台配置**: 启用和配置串行控制台
- ❌ **串行控制台访问**: 提供访问接口
- ❌ **多串口支持**: 支持多个串口
- ❌ **日志重定向**: 串口日志重定向

## 3. 技术实现

### 3.1 KubeVirt 支持

KubeVirt 原生支持串行控制台：

```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
spec:
  domain:
    devices:
      consoles:
      - type: serial
        targetPort: 0
      - type: serial
        targetPort: 1
```

### 3.2 实现方案

```go
// pkg/kubevirt/console.go

func buildConsoles(vmp *vmv1alpha1.Wukong) []kubevirtv1.Console {
    if vmp.Spec.Console == nil || 
       vmp.Spec.Console.Serial == nil ||
       !vmp.Spec.Console.Serial.Enabled {
        // 默认启用一个串行控制台
        return []kubevirtv1.Console{
            {
                Type: "serial",
            },
        }
    }
    
    consoles := make([]kubevirtv1.Console, 0)
    
    // 主串行控制台
    consoles = append(consoles, kubevirtv1.Console{
        Type: "serial",
    })
    
    // 额外的串行控制台
    if vmp.Spec.Console.Serial.AdditionalPorts > 0 {
        for i := int32(1); i <= vmp.Spec.Console.Serial.AdditionalPorts; i++ {
            consoles = append(consoles, kubevirtv1.Console{
                Type:       "serial",
                TargetPort: i,
            })
        }
    }
    
    return consoles
}
```

### 3.3 访问实现

#### 方案一：使用 virtctl
```bash
# 访问串行控制台
virtctl console <vm-name> -n <namespace>

# 访问指定串口
virtctl console <vm-name> -n <namespace> --serial
```

#### 方案二：通过 kubectl
```bash
# 通过 kubectl exec 访问
kubectl exec -it <vmi-pod> -n <namespace> -- /bin/sh
```

## 4. API 设计

### 4.1 SerialConfig 扩展

```go
// api/v1alpha1/wukong_types.go

type SerialConfig struct {
    // Enabled 是否启用串行控制台
    Enabled bool `json:"enabled"`
    
    // AdditionalPorts 额外串口数量（默认 0，只有主串口）
    // +optional
    AdditionalPorts int32 `json:"additionalPorts,omitempty"`
    
    // LogToFile 是否将串口输出重定向到文件
    // +optional
    LogToFile bool `json:"logToFile,omitempty"`
    
    // LogFilePath 日志文件路径（如果 LogToFile 为 true）
    // +optional
    LogFilePath string `json:"logFilePath,omitempty"`
}
```

## 5. 使用示例

### 5.1 基本串行控制台
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: serial-vm
spec:
  console:
    serial:
      enabled: true
```

### 5.2 多串口配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-serial-vm
spec:
  console:
    serial:
      enabled: true
      additionalPorts: 2  # 总共 3 个串口（0, 1, 2）
```

### 5.3 串口日志重定向
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: logged-vm
spec:
  console:
    serial:
      enabled: true
      logToFile: true
      logFilePath: "/var/log/vm-serial.log"
```

## 6. 访问方式

### 6.1 通过 virtctl
```bash
# 访问主串行控制台
virtctl console <vm-name> -n <namespace>

# 访问指定串口
virtctl console <vm-name> -n <namespace> --serial 1
```

### 6.2 通过 kubectl
```bash
# 获取 VMI Pod
kubectl get pods -n <namespace> -l kubevirt.io=virt-launcher

# 访问串行控制台
kubectl exec -it <pod-name> -n <namespace> -- /bin/sh
```

## 7. 注意事项

### 7.1 系统配置
- 确保 VM 内系统配置了串行控制台
- Linux 需要配置 console=ttyS0
- Windows 需要启用串行控制台

### 7.2 多串口使用
- 主串口（0）通常用于系统控制台
- 其他串口可用于应用日志
- 合理分配串口用途

### 7.3 日志管理
- 串口日志可能很大
- 需要日志轮转
- 考虑日志存储位置

## 8. 面试要点

### 8.1 串行控制台的使用场景？

**答案**:
- 命令行管理（不需要图形界面）
- 故障排查（系统启动问题）
- 无图形界面系统（服务器系统）
- 远程管理（类似物理服务器串口）

### 8.2 如何配置 Linux 系统使用串行控制台？

**答案**:
- 在 GRUB 配置中添加 `console=ttyS0`
- 在 systemd 中配置串行控制台
- 确保内核支持串行控制台
- 测试串行控制台连接

### 8.3 串行控制台和 SSH 的区别？

**答案**:
- **串行控制台**: 底层访问，不依赖网络，适合系统启动阶段
- **SSH**: 网络访问，需要系统运行，适合正常运行阶段

