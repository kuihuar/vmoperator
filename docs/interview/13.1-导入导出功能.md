# 导入导出功能规划

## 1. 功能概述

### 1.1 导入功能
将外部镜像或文件导入到 PVC，用于创建 VM。

**使用场景**:
- 从容器镜像仓库导入系统镜像
- 从 HTTP/HTTPS URL 下载镜像
- 从 S3 对象存储导入
- 从本地文件导入（通过 PVC）

### 1.2 导出功能
将 VM 磁盘导出为容器镜像或文件。

**使用场景**:
- 将 VM 磁盘导出为容器镜像（OCI 格式）
- 导出为 RAW/QCOW2 格式文件
- 上传到对象存储
- 备份到外部存储

## 2. 当前实现状态

### 2.1 已实现
- ✅ 通过 `DataVolume` 从容器镜像导入（`disk.image` 字段）
- ✅ 支持 `docker://`、`registry://` 协议

### 2.2 待实现
- ❌ 从 HTTP/HTTPS URL 导入
- ❌ 从 S3 对象存储导入
- ❌ 导出为容器镜像
- ❌ 导出为文件格式
- ❌ 导入/导出进度查询
- ❌ 导入/导出状态管理

## 3. 技术实现

### 3.1 导入功能实现

#### 方案一：扩展 DataVolume 支持
```yaml
# Wukong CRD 扩展
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
spec:
  disks:
  - name: system
    size: 20Gi
    importSource:
      type: http          # http, https, s3, registry
      url: https://example.com/image.qcow2
      # 或
      type: s3
      endpoint: https://s3.example.com
      bucket: images
      key: ubuntu.qcow2
      credentials:
        secretName: s3-credentials
```

#### 方案二：使用 CDI DataSource
```yaml
# 创建 DataSource
apiVersion: cdi.kubevirt.io/v1beta1
kind: DataSource
metadata:
  name: ubuntu-datasource
spec:
  source:
    http:
      url: https://example.com/ubuntu.qcow2
---
# Wukong 引用 DataSource
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
spec:
  disks:
  - name: system
    size: 20Gi
    dataSource:
      name: ubuntu-datasource
```

### 3.2 导出功能实现

#### 方案一：使用 DataVolume 导出
```yaml
# Wukong CRD 扩展
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
spec:
  disks:
  - name: system
    exportTarget:
      type: registry      # registry, s3, http
      url: registry.example.com/vms/ubuntu:latest
      # 或
      type: s3
      endpoint: https://s3.example.com
      bucket: backups
      key: vm-backup.qcow2
```

#### 方案二：使用 CDI DataVolume 导出
```yaml
apiVersion: cdi.kubevirt.io/v1beta1
kind: DataVolume
metadata:
  name: export-vm-disk
spec:
  source:
    pvc:
      name: vm-system-disk
      namespace: default
  pvc:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 20Gi
```

### 3.3 Controller 实现

```go
// pkg/storage/import.go
func ReconcileImport(ctx context.Context, c client.Client, disk DiskConfig, namespace string) error {
    // 1. 根据 importSource 类型创建 DataVolume
    // 2. 监控导入进度
    // 3. 更新状态
}

// pkg/storage/export.go
func ReconcileExport(ctx context.Context, c client.Client, disk DiskConfig, namespace string) error {
    // 1. 创建导出 DataVolume
    // 2. 监控导出进度
    // 3. 更新状态
}
```

## 4. API 设计

### 4.1 WukongSpec 扩展

```go
// api/v1alpha1/wukong_types.go

type DiskConfig struct {
    // ... 现有字段 ...
    
    // ImportSource 定义导入源（可选）
    // +optional
    ImportSource *ImportSourceSpec `json:"importSource,omitempty"`
    
    // ExportTarget 定义导出目标（可选）
    // +optional
    ExportTarget *ExportTargetSpec `json:"exportTarget,omitempty"`
}

type ImportSourceSpec struct {
    // Type 导入源类型: http, https, s3, registry, pvc
    Type string `json:"type"`
    
    // URL 导入源 URL（用于 http/https）
    // +optional
    URL string `json:"url,omitempty"`
    
    // S3Config S3 配置（用于 s3）
    // +optional
    S3Config *S3Config `json:"s3Config,omitempty"`
    
    // RegistryConfig 镜像仓库配置（用于 registry）
    // +optional
    RegistryConfig *RegistryConfig `json:"registryConfig,omitempty"`
    
    // PVCConfig PVC 配置（用于 pvc）
    // +optional
    PVCConfig *PVCConfig `json:"pvcConfig,omitempty"`
}

type ExportTargetSpec struct {
    // Type 导出目标类型: registry, s3, http
    Type string `json:"type"`
    
    // URL 导出目标 URL
    URL string `json:"url"`
    
    // Format 导出格式: raw, qcow2, oci
    // +optional
    Format string `json:"format,omitempty"`
    
    // S3Config S3 配置（用于 s3）
    // +optional
    S3Config *S3Config `json:"s3Config,omitempty"`
    
    // RegistryConfig 镜像仓库配置（用于 registry）
    // +optional
    RegistryConfig *RegistryConfig `json:"registryConfig,omitempty"`
}
```

### 4.2 Status 扩展

```go
// api/v1alpha1/wukong_types.go

type VolumeStatus struct {
    // ... 现有字段 ...
    
    // ImportStatus 导入状态
    // +optional
    ImportStatus *ImportStatus `json:"importStatus,omitempty"`
    
    // ExportStatus 导出状态
    // +optional
    ExportStatus *ExportStatus `json:"exportStatus,omitempty"`
}

type ImportStatus struct {
    Phase      string `json:"phase"`      // Pending, Importing, Succeeded, Failed
    Progress   string `json:"progress"`  // 0-100%
    Message    string `json:"message,omitempty"`
}

type ExportStatus struct {
    Phase      string `json:"phase"`      // Pending, Exporting, Succeeded, Failed
    Progress   string `json:"progress"`  // 0-100%
    Message    string `json:"message,omitempty"`
}
```

## 5. 实现步骤

### 5.1 第一阶段：基础导入
1. 支持 HTTP/HTTPS URL 导入
2. 支持容器镜像导入（已有）
3. 实现进度查询

### 5.2 第二阶段：扩展导入源
1. 支持 S3 对象存储导入
2. 支持 PVC 克隆导入
3. 支持认证配置

### 5.3 第三阶段：导出功能
1. 支持导出为容器镜像
2. 支持导出为 RAW/QCOW2 格式
3. 实现导出进度查询

### 5.4 第四阶段：高级特性
1. 支持增量导入/导出
2. 支持断点续传
3. 支持并行导入/导出

## 6. 使用示例

### 6.1 从 HTTP URL 导入
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: ubuntu-vm
spec:
  cpu: 2
  memory: 4Gi
  disks:
  - name: system
    size: 20Gi
    importSource:
      type: https
      url: https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img
```

### 6.2 从 S3 导入
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: custom-vm
spec:
  cpu: 2
  memory: 4Gi
  disks:
  - name: system
    size: 20Gi
    importSource:
      type: s3
      s3Config:
        endpoint: https://s3.example.com
        bucket: vm-images
        key: custom-os.qcow2
        credentials:
          secretName: s3-credentials
```

### 6.3 导出为容器镜像
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: ubuntu-vm
spec:
  cpu: 2
  memory: 4Gi
  disks:
  - name: system
    size: 20Gi
    exportTarget:
      type: registry
      url: registry.example.com/vms/ubuntu:custom
      registryConfig:
        secretName: registry-credentials
```

## 7. 注意事项

### 7.1 性能考虑
- 大文件导入/导出可能耗时较长
- 需要实现进度查询和状态反馈
- 考虑使用压缩格式减少传输时间

### 7.2 安全性
- 支持认证配置（Secret）
- 验证导入源的可信度
- 防止恶意镜像注入

### 7.3 错误处理
- 网络中断处理
- 存储空间不足处理
- 格式不兼容处理

## 8. 面试要点

### 8.1 为什么需要导入/导出功能？

**答案**:
- **多云迁移**: 在不同云平台间迁移 VM
- **镜像管理**: 统一管理 VM 镜像
- **备份恢复**: 导出 VM 作为备份，需要时导入恢复
- **镜像分发**: 将自定义镜像分发给其他用户

### 8.2 如何实现大文件导入的性能优化？

**答案**:
- 使用压缩格式（gzip、xz）
- 支持断点续传
- 使用 CDN 加速下载
- 并行导入多个磁盘
- 使用增量导入（如果支持）

### 8.3 导入过程中如何保证数据完整性？

**答案**:
- 使用校验和（MD5、SHA256）验证
- 支持数据完整性检查
- 实现重试机制
- 记录导入日志

