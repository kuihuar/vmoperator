# CDI Helm 管理规划

## 1. 概述

CDI (Containerized Data Importer) 是 KubeVirt 的数据导入工具，用于从镜像创建虚拟机磁盘。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://kubevirt.io/charts`
- **Chart Name**: `cdi`
- **最新版本**: 1.57.0+

### 2.2 安装方式
```bash
# 添加仓库
helm repo add kubevirt https://kubevirt.io/charts
helm repo update

# 安装 CDI
helm install cdi kubevirt/cdi \
  --namespace cdi-system \
  --create-namespace \
  --version 1.57.0
```

## 3. Values 配置

### 3.1 基础配置
```yaml
# values-cdi.yaml
# CDI Controller 配置
controller:
  image:
    repository: quay.io/cdi-controller/cdi-controller
    tag: v1.57.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# CDI API Server 配置
apiServer:
  image:
    repository: quay.io/cdi-controller/cdi-apiserver
    tag: v1.57.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# CDI Upload Server 配置
uploadServer:
  image:
    repository: quay.io/cdi-controller/cdi-uploadserver
    tag: v1.57.0
  
  resources:
    limits:
      cpu: 200m
      memory: 150Mi
    requests:
      cpu: 10m
      memory: 50Mi

# CDI Importer 配置
importer:
  image:
    repository: quay.io/cdi-controller/cdi-importer
    tag: v1.57.0

# 功能配置
config:
  # 数据卷配置
  dataVolume:
    # 默认存储类
    defaultStorageClass: "longhorn"
    
    # 临时存储类（用于导入）
    scratchStorageClass: "longhorn"
  
  # 上传配置
  upload:
    # 上传代理 URL
    proxyURL: ""
    
    # 上传服务端口
    port: 8443
  
  # 导入配置
  import:
    # 支持的镜像格式
    imageFormats:
      - "qcow2"
      - "raw"
      - "tar"
    
    # 默认镜像格式
    defaultImageFormat: "qcow2"
```

### 3.2 生产环境配置
```yaml
# values-cdi-prod.yaml
controller:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

apiServer:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# 节点选择器
nodeSelector:
  node-type: compute

# 容忍度
tolerations:
  - key: "cdi"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

# 存储配置
config:
  dataVolume:
    defaultStorageClass: "longhorn"
    scratchStorageClass: "longhorn"
```

## 4. 部署命令

### 4.1 开发环境
```bash
helm install cdi kubevirt/cdi \
  --namespace cdi-system \
  --create-namespace \
  --version 1.57.0
```

### 4.2 生产环境
```bash
helm install cdi kubevirt/cdi \
  --namespace cdi-system \
  --create-namespace \
  --version 1.57.0 \
  -f values-cdi-prod.yaml
```

## 5. 验证安装

```bash
# 检查 Pod 状态
kubectl get pods -n cdi-system

# 检查 CRD
kubectl get crd | grep cdi.kubevirt.io

# 检查 DataVolume CRD
kubectl get crd datavolumes.cdi.kubevirt.io
```

## 6. 配置存储类

CDI 需要配置默认存储类：

```bash
# 设置默认存储类
kubectl patch cdi cdi -n cdi-system --type merge \
  -p '{"spec":{"config":{"dataVolumeTTLSeconds":0,"defaultStorageClass":"longhorn"}}}'
```

## 7. 升级

```bash
# 升级 CDI
helm upgrade cdi kubevirt/cdi \
  --namespace cdi-system \
  --version 1.58.0 \
  -f values-cdi-prod.yaml
```

## 8. 卸载

```bash
# 卸载 CDI（注意：会删除所有 DataVolume）
helm uninstall cdi --namespace cdi-system
```

## 9. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加依赖：

```yaml
dependencies:
  - name: cdi
    version: "1.57.0"
    repository: "https://kubevirt.io/charts"
    condition: cdi.enabled
```

在 `values.yaml` 中配置：

```yaml
cdi:
  enabled: true
  controller:
    replicas: 2
  config:
    dataVolume:
      defaultStorageClass: "longhorn"
```

## 10. 依赖关系

- **依赖**: KubeVirt（CDI 需要 KubeVirt CRD）
- **被依赖**: Novasphere Operator（使用 CDI 导入镜像）

**部署顺序**:
1. KubeVirt
2. CDI
3. Novasphere Operator

