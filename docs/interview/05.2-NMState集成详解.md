# NMState 集成详解

## 1. NMState 概述

NMState 是用于管理节点网络配置的 Operator，当前在 VM Operator 中作为占位实现。

### 1.1 当前状态

```go
func ReconcileNMState(ctx context.Context, c client.Client, vmp *vmv1alpha1.Wukong) error {
    // 当前为 no-op，占位
    // 后续可以用于自动配置节点网络（VLAN、桥接等）
    return nil
}
```

### 1.2 设计目标

- **自动配置节点网络**: 根据 NetworkConfig 自动创建桥接、VLAN 等
- **网络策略管理**: 统一管理集群节点的网络配置
- **与 Multus 配合**: Multus 使用 NAD，NMState 配置底层网络

## 2. NMState 工作原理

### 2.1 NodeNetworkConfigurationPolicy

NMState 使用 `NodeNetworkConfigurationPolicy` CRD 来定义节点网络配置：

```yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: bridge-policy
spec:
  desiredState:
    interfaces:
      - name: br-mgmt
        type: linux-bridge
        state: up
        bridge:
          options:
            stp:
              enabled: false
          port:
            - name: eth0
```

### 2.2 与 Multus 的关系

```
用户定义 NetworkConfig
    ↓
NMState 配置节点网络（桥接、VLAN）
    ↓
Multus 创建 NAD（引用已配置的网络）
    ↓
KubeVirt VM 使用网络接口
```

## 3. 未来实现方向

### 3.1 自动桥接创建

```go
func ReconcileNMState(ctx context.Context, c client.Client, vmp *vmv1alpha1.Wukong) error {
    for _, netCfg := range vmp.Spec.Networks {
        if netCfg.Type == "bridge" {
            // 创建 NodeNetworkConfigurationPolicy
            // 自动配置桥接和 VLAN
        }
    }
    return nil
}
```

### 3.2 网络策略管理

- 根据 NetworkConfig 自动创建网络策略
- 确保节点网络配置一致
- 支持网络配置的更新和回滚

## 4. 面试要点

### 4.1 为什么需要 NMState？

**答案**:
- Multus 只负责创建网络接口，不配置底层网络
- NMState 用于自动配置节点网络（桥接、VLAN 等）
- 两者配合实现完整的网络管理

### 4.2 当前实现状态？

**答案**:
- 当前为占位实现（no-op）
- 预留了接口，便于后续扩展
- 可以手动配置节点网络，然后使用 Multus

### 4.3 如何扩展 NMState 功能？

**答案**:
1. 实现 `ReconcileNMState` 函数
2. 根据 NetworkConfig 创建 `NodeNetworkConfigurationPolicy`
3. 监控策略状态，确保配置生效

