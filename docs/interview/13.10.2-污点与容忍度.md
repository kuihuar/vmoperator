# 污点与容忍度

## 1. 功能概述

### 1.1 污点（Taint）
节点上的标记，用于拒绝不符合条件的 Pod/VM 调度到该节点。

**使用场景**:
- 专用节点（如 GPU 节点）
- 维护中的节点
- 资源受限的节点
- 特殊用途节点

### 1.2 容忍度（Toleration）
Pod/VM 上的标记，允许调度到有特定污点的节点。

**使用场景**:
- 允许调度到专用节点
- 允许调度到维护中的节点
- 处理节点污点
- 特殊调度需求

## 2. 当前实现状态

### 2.1 已实现
- ✅ **Tolerations**: 通过 `HighAvailability.Tolerations` 支持基本容忍度配置

### 2.2 待完善
- ⚠️ **容忍度验证**: 验证容忍度配置有效性
- ⚠️ **自动容忍度**: 根据节点污点自动添加容忍度
- ⚠️ **容忍度策略**: 容忍度管理策略

## 3. 技术实现

### 3.1 当前实现

```go
// api/v1alpha1/wukong_types.go

type HighAvailabilitySpec struct {
    // Tolerations 容忍度列表
    Tolerations []TolerationSpec `json:"tolerations,omitempty"`
}

type TolerationSpec struct {
    Key      string `json:"key"`
    Operator string `json:"operator"`  // Equal, Exists
    Value    string `json:"value,omitempty"`
    Effect   string `json:"effect"`    // NoSchedule, PreferNoSchedule, NoExecute
}
```

### 3.2 污点类型

#### NoSchedule
- 不允许新 Pod/VM 调度到该节点
- 已运行的 Pod/VM 不受影响

#### PreferNoSchedule
- 尽量不调度到该节点
- 如果没有其他节点可选，仍可调度

#### NoExecute
- 不允许新 Pod/VM 调度
- 已运行的 Pod/VM 会被驱逐（如果没有对应容忍度）

### 3.3 实现方案

```go
// pkg/kubevirt/scheduling.go

func buildTolerations(vmp *vmv1alpha1.Wukong) []corev1.Toleration {
    tolerations := make([]corev1.Toleration, 0)
    
    // 从 HighAvailability 获取（向后兼容）
    if vmp.Spec.HighAvailability != nil {
        for _, tol := range vmp.Spec.HighAvailability.Tolerations {
            tolerations = append(tolerations, corev1.Toleration{
                Key:      tol.Key,
                Operator: corev1.TolerationOperator(tol.Operator),
                Value:    tol.Value,
                Effect:   corev1.TaintEffect(tol.Effect),
            })
        }
    }
    
    // 从 Scheduling 获取（新方式）
    if vmp.Spec.Scheduling != nil && len(vmp.Spec.Scheduling.Tolerations) > 0 {
        for _, tol := range vmp.Spec.Scheduling.Tolerations {
            tolerations = append(tolerations, corev1.Toleration{
                Key:      tol.Key,
                Operator: corev1.TolerationOperator(tol.Operator),
                Value:    tol.Value,
                Effect:   corev1.TaintEffect(tol.Effect),
                TolerationSeconds: tol.TolerationSeconds,
            })
        }
    }
    
    return tolerations
}
```

## 4. API 设计扩展

### 4.1 SchedulingSpec 扩展

```go
// api/v1alpha1/wukong_types.go

type SchedulingSpec struct {
    // ... 现有字段 ...
    
    // Tolerations 容忍度列表
    // +optional
    Tolerations []TolerationSpec `json:"tolerations,omitempty"`
    
    // AutoTolerations 自动容忍度（根据节点污点自动添加）
    // +optional
    AutoTolerations *AutoTolerationsSpec `json:"autoTolerations,omitempty"`
}

type TolerationSpec struct {
    // Key 污点键
    Key string `json:"key"`
    
    // Operator 操作符: Equal, Exists
    Operator string `json:"operator"`
    
    // Value 污点值（Equal 操作符需要）
    // +optional
    Value string `json:"value,omitempty"`
    
    // Effect 污点效果: NoSchedule, PreferNoSchedule, NoExecute
    Effect string `json:"effect"`
    
    // TolerationSeconds 容忍时间（秒，NoExecute 效果）
    // +optional
    TolerationSeconds *int64 `json:"tolerationSeconds,omitempty"`
}

type AutoTolerationsSpec struct {
    // Enabled 是否启用自动容忍度
    Enabled bool `json:"enabled"`
    
    // Patterns 匹配模式（如果匹配，自动添加容忍度）
    // +optional
    Patterns []TolerationPattern `json:"patterns,omitempty"`
}

type TolerationPattern struct {
    // KeyPattern 键匹配模式（支持通配符）
    KeyPattern string `json:"keyPattern"`
    
    // Effect 污点效果
    Effect string `json:"effect"`
}
```

## 5. 使用示例

### 5.1 基本容忍度
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: gpu-vm
spec:
  cpu: 4
  memory: 8Gi
  scheduling:
    tolerations:
    - key: "gpu"
      operator: "Equal"
      value: "true"
      effect: "NoSchedule"
```

### 5.2 多个容忍度
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: special-vm
spec:
  scheduling:
    tolerations:
    - key: "gpu"
      operator: "Equal"
      value: "nvidia"
      effect: "NoSchedule"
    - key: "maintenance"
      operator: "Exists"
      effect: "PreferNoSchedule"
```

### 5.3 带容忍时间的容忍度
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: temporary-vm
spec:
  scheduling:
    tolerations:
    - key: "maintenance"
      operator: "Equal"
      value: "true"
      effect: "NoExecute"
      tolerationSeconds: 3600  # 1小时后被驱逐
```

### 5.4 自动容忍度
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: auto-toleration-vm
spec:
  scheduling:
    autoTolerations:
      enabled: true
      patterns:
      - keyPattern: "gpu-*"
        effect: "NoSchedule"
      - keyPattern: "zone-*"
        effect: "PreferNoSchedule"
```

## 6. Controller 实现

### 6.1 自动容忍度处理

```go
// internal/controller/wukong_controller.go

func (r *WukongReconciler) reconcileAutoTolerations(ctx context.Context, vmp *vmv1alpha1.Wukong) error {
    if vmp.Spec.Scheduling == nil || 
       vmp.Spec.Scheduling.AutoTolerations == nil ||
       !vmp.Spec.Scheduling.AutoTolerations.Enabled {
        return nil
    }
    
    // 1. 获取所有节点
    nodes := &corev1.NodeList{}
    if err := r.List(ctx, nodes); err != nil {
        return err
    }
    
    // 2. 收集所有污点
    allTaints := make(map[string]corev1.Taint)
    for _, node := range nodes.Items {
        for _, taint := range node.Spec.Taints {
            allTaints[fmt.Sprintf("%s:%s", taint.Key, string(taint.Effect))] = taint
        }
    }
    
    // 3. 根据模式匹配并添加容忍度
    autoTols := vmp.Spec.Scheduling.AutoTolerations
    newTolerations := make([]vmv1alpha1.TolerationSpec, 0)
    
    // 添加现有的手动配置的容忍度
    newTolerations = append(newTolerations, vmp.Spec.Scheduling.Tolerations...)
    
    // 根据模式添加自动容忍度
    for _, pattern := range autoTols.Patterns {
        for _, taint := range allTaints {
            if matchesPattern(taint.Key, pattern.KeyPattern) &&
               taint.Effect == corev1.TaintEffect(pattern.Effect) {
                // 检查是否已存在
                exists := false
                for _, existing := range newTolerations {
                    if existing.Key == taint.Key && existing.Effect == string(taint.Effect) {
                        exists = true
                        break
                    }
                }
                if !exists {
                    newTolerations = append(newTolerations, vmv1alpha1.TolerationSpec{
                        Key:      taint.Key,
                        Operator: "Exists",
                        Effect:   string(taint.Effect),
                    })
                }
            }
        }
    }
    
    // 4. 更新容忍度
    vmp.Spec.Scheduling.Tolerations = newTolerations
    return r.Update(ctx, vmp)
}

func matchesPattern(key, pattern string) bool {
    // 简单的通配符匹配（支持 *）
    matched, _ := filepath.Match(pattern, key)
    return matched
}
```

## 7. 注意事项

### 7.1 污点效果
- **NoSchedule**: 不允许新调度，已运行的不受影响
- **PreferNoSchedule**: 尽量不调度，但可以调度
- **NoExecute**: 不允许新调度，已运行的会被驱逐

### 7.2 容忍度匹配
- 容忍度必须完全匹配污点才能调度
- 空的容忍度（key 存在，operator=Exists）匹配所有该键的污点
- TolerationSeconds 只对 NoExecute 有效

### 7.3 自动容忍度
- 需要定期检查节点污点
- 可能产生大量容忍度
- 需要合理配置匹配模式

## 8. 面试要点

### 8.1 污点的三种效果有什么区别？

**答案**:
- **NoSchedule**: 阻止新 Pod/VM 调度，已运行的不受影响
- **PreferNoSchedule**: 尽量不调度，但没有其他节点时仍可调度
- **NoExecute**: 阻止新调度，并驱逐已运行但没有容忍度的 Pod/VM

### 8.2 如何实现自动容忍度？

**答案**:
- 定期检查所有节点的污点
- 根据配置的模式匹配污点
- 自动添加对应的容忍度
- 避免重复添加

### 8.3 容忍度和节点选择器的区别？

**答案**:
- **节点选择器**: 选择特定节点（正向选择）
- **容忍度**: 允许调度到有污点的节点（反向处理）
- 两者可以结合使用，实现精确调度

