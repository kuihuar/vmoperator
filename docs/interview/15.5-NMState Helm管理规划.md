# NMState Helm 管理规划

## 1. 概述

NMState Operator 用于管理 Kubernetes 节点的网络配置（VLAN、桥接、SR-IOV 等）。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://nmstate.github.io/nmstate-operator`
- **Chart Name**: `nmstate-operator`
- **最新版本**: 0.73.0+

### 2.2 安装方式
```bash
# 添加仓库
helm repo add nmstate https://nmstate.github.io/nmstate-operator
helm repo update

# 安装 NMState Operator
helm install nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --create-namespace \
  --version 0.73.0
```

## 3. Values 配置

### 3.1 基础配置
```yaml
# values-nmstate.yaml
# NMState Operator 配置
operator:
  image:
    repository: quay.io/nmstate/nmstate-operator
    tag: v0.73.0
  
  replicas: 1
  
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

# NMState Webhook 配置
webhook:
  image:
    repository: quay.io/nmstate/nmstate-operator-webhook
    tag: v0.73.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

# Handler (DaemonSet) 配置
handler:
  image:
    repository: quay.io/nmstate/kubernetes-nmstate-handler
    tag: v0.73.0
  
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# 功能配置
config:
  # 节点选择器（哪些节点需要网络配置）
  nodeSelector:
    node-type: compute
  
  # 网络策略
  policy:
    # 允许的接口类型
    allowedInterfaces:
      - "eth0"
      - "eth1"
      - "bond0"
      - "br0"
```

### 3.2 生产环境配置
```yaml
# values-nmstate-prod.yaml
operator:
  replicas: 2
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

webhook:
  replicas: 2
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

handler:
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

# 节点选择器
nodeSelector:
  node-type: compute

# 容忍度
tolerations:
  - key: "nmstate"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
```

## 4. 部署命令

### 4.1 开发环境
```bash
helm install nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --create-namespace \
  --version 0.73.0
```

### 4.2 生产环境
```bash
helm install nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --create-namespace \
  --version 0.73.0 \
  -f values-nmstate-prod.yaml
```

## 5. 验证安装

```bash
# 检查 Pod 状态
kubectl get pods -n nmstate-system

# 检查 CRD
kubectl get crd | grep nmstate.io

# 检查 NodeNetworkState
kubectl get nnstate

# 查看节点网络状态
kubectl get nnstate <node-name> -o yaml
```

## 6. 网络配置示例

创建 `NodeNetworkConfigurationPolicy`：

```yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: bridge-policy
spec:
  nodeSelector:
    node-type: compute
  desiredState:
    interfaces:
    - name: br0
      type: linux-bridge
      state: up
      bridge:
        options:
          stp:
            enabled: false
        port:
        - name: eth1
```

## 7. 升级

```bash
# 升级 NMState
helm upgrade nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --version 0.74.0 \
  -f values-nmstate-prod.yaml
```

## 8. 卸载

```bash
# 卸载 NMState（注意：不会删除网络配置）
helm uninstall nmstate --namespace nmstate-system
```

## 9. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加依赖：

```yaml
dependencies:
  - name: nmstate-operator
    version: "0.73.0"
    repository: "https://nmstate.github.io/nmstate-operator"
    condition: nmstate.enabled
```

在 `values.yaml` 中配置：

```yaml
nmstate:
  enabled: true
  operator:
    replicas: 2
  config:
    nodeSelector:
      node-type: compute
```

## 10. 依赖关系

- **依赖**: 无（独立组件）
- **被依赖**: Novasphere Operator（用于网络配置）

**部署顺序**:
1. NMState Operator
2. Novasphere Operator

