# Helm Chart 结构设计

## 1. Chart 目录结构

```
charts/novasphere/
├── Chart.yaml              # Chart 元数据
├── values.yaml             # 默认 Values
├── values-dev.yaml         # 开发环境 Values
├── values-prod.yaml        # 生产环境 Values
├── templates/              # 模板目录
│   ├── _helpers.tpl        # 模板辅助函数
│   ├── namespace.yaml      # Namespace
│   ├── crd/                # CRD 模板
│   │   └── wukong.yaml
│   ├── rbac/               # RBAC 模板
│   │   ├── serviceaccount.yaml
│   │   ├── clusterrole.yaml
│   │   ├── clusterrolebinding.yaml
│   │   └── wukong-roles.yaml
│   ├── manager/            # Manager 模板
│   │   └── deployment.yaml
│   ├── webhook/            # Webhook 模板
│   │   ├── service.yaml
│   │   ├── mutatingwebhook.yaml
│   │   └── validatingwebhook.yaml
│   └── metrics/           # Metrics 模板
│       └── service.yaml
└── charts/                 # 子 Chart（依赖）
```

## 2. Chart.yaml

```yaml
apiVersion: v2
name: novasphere
description: A Helm chart for Novasphere VM Operator
type: application
version: 0.1.0
appVersion: "1.0.0"
keywords:
  - kubernetes
  - kubevirt
  - virtual-machine
  - operator
home: https://github.com/kuihuar/novasphere
sources:
  - https://github.com/kuihuar/novasphere
maintainers:
  - name: Novasphere Team
dependencies:
  # 可选：cert-manager（如果使用 cert-manager 管理证书）
  # - name: cert-manager
  #   version: "v1.13.0"
  #   repository: "https://charts.jetstack.io"
  #   condition: certManager.enabled
```

## 3. 模板文件设计

### 3.1 _helpers.tpl

```yaml
{{/*
Expand the name of the chart.
*/}}
{{- define "novasphere.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
*/}}
{{- define "novasphere.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "novasphere.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "novasphere.labels" -}}
helm.sh/chart: {{ include "novasphere.chart" . }}
{{ include "novasphere.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "novasphere.selectorLabels" -}}
app.kubernetes.io/name: {{ include "novasphere.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
control-plane: controller-manager
{{- end }}

{{/*
Namespace
*/}}
{{- define "novasphere.namespace" -}}
{{- default .Release.Namespace .Values.namespace }}
{{- end }}
```

### 3.2 namespace.yaml

```yaml
{{- if .Values.namespace.create }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ include "novasphere.namespace" . }}
  labels:
    {{- include "novasphere.labels" . | nindent 4 }}
{{- end }}
```

### 3.3 templates/crd/wukong.yaml

```yaml
{{- if .Values.crd.install }}
{{- $files := .Files.Glob "crds/*.yaml" }}
{{- range $path, $file := $files }}
{{ $file.Content }}
---
{{- end }}
{{- end }}
```

**注意**: CRD 文件需要放在 `charts/novasphere/crds/` 目录。

### 3.4 templates/manager/deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "novasphere.fullname" . }}-controller-manager
  namespace: {{ include "novasphere.namespace" . }}
  labels:
    {{- include "novasphere.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.manager.replicas }}
  selector:
    matchLabels:
      {{- include "novasphere.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
      labels:
        {{- include "novasphere.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: manager
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command:
        - /manager
        args:
        - --leader-elect
        - --health-probe-bind-address=:8081
        {{- if .Values.webhook.enabled }}
        - --enable-webhook=true
        {{- else }}
        - --enable-webhook=false
        {{- end }}
        ports:
        {{- if .Values.metrics.enabled }}
        - containerPort: 8443
          name: https
          protocol: TCP
        {{- end }}
        {{- if .Values.webhook.enabled }}
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        {{- end }}
        securityContext:
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - "ALL"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: {{ .Values.manager.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.manager.livenessProbe.periodSeconds }}
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: {{ .Values.manager.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.manager.readinessProbe.periodSeconds }}
        resources:
          {{- toYaml .Values.manager.resources | nindent 10 }}
        volumeMounts:
        {{- if .Values.webhook.enabled }}
        - name: webhook-cert
          mountPath: /tmp/k8s-webhook-server/serving-certs
          readOnly: true
        {{- end }}
      volumes:
      {{- if .Values.webhook.enabled }}
      - name: webhook-cert
        secret:
          secretName: {{ include "novasphere.fullname" . }}-webhook-cert
      {{- end }}
      serviceAccountName: {{ include "novasphere.fullname" . }}-controller-manager
      terminationGracePeriodSeconds: {{ .Values.manager.terminationGracePeriodSeconds }}
```

## 4. 从 Kustomize 迁移

### 4.1 资源映射

| Kustomize 资源 | Helm 模板位置 |
|---------------|--------------|
| `config/crd/bases/*.yaml` | `charts/novasphere/crds/*.yaml` |
| `config/rbac/*.yaml` | `templates/rbac/*.yaml` |
| `config/manager/manager.yaml` | `templates/manager/deployment.yaml` |
| `config/webhook/*.yaml` | `templates/webhook/*.yaml` |
| `config/default/metrics_service.yaml` | `templates/metrics/service.yaml` |

### 4.2 转换步骤

1. **创建 Chart 目录结构**
2. **复制 CRD 到 crds/ 目录**
3. **转换 RBAC 资源为模板**
4. **转换 Manager Deployment 为模板**
5. **转换 Webhook 配置为模板**
6. **定义 Values.yaml**

## 5. 最佳实践

### 5.1 模板组织
- 使用 `_helpers.tpl` 定义通用函数
- 按资源类型组织模板文件
- 使用命名空间隔离

### 5.2 条件渲染
- 使用 `{{- if .Values.feature.enabled }}` 控制功能开关
- Webhook、Metrics 等可选功能使用条件渲染

### 5.3 标签和选择器
- 使用统一的标签模板
- 确保选择器与标签一致

### 5.4 命名规范
- 使用 `fullname` 模板确保名称唯一
- 遵循 Kubernetes 命名规范

