# 资源弹性伸缩功能总览

## 1. 功能概述

资源弹性伸缩功能允许在 VM 运行过程中动态调整资源，包括 CPU、内存、磁盘、网络等，无需重启 VM（热扩容）或最小化停机时间。

## 2. 功能列表

| 功能 | 优先级 | 复杂度 | 业务价值 | 当前状态 |
|------|--------|--------|----------|----------|
| **CPU 扩缩容** | 高 | 中 | 高 | 部分支持（需重启） |
| **内存扩缩容** | 高 | 中 | 高 | 部分支持（需重启） |
| **磁盘热扩容** | 高 | 高 | 高 | 待实现 |
| **动态挂载磁盘** | 中 | 中 | 中 | 待实现 |
| **动态卸载磁盘** | 中 | 中 | 中 | 待实现 |
| **网络扩缩容** | 中 | 中 | 中 | 待实现 |

## 3. 当前实现状态

### 3.1 已实现
- ✅ **静态配置**: 创建时配置 CPU、内存、磁盘、网络
- ✅ **更新支持**: 修改 Spec 可以更新配置（但需要重启）

### 3.2 待实现
- ❌ **热扩容**: CPU/内存/磁盘无需重启扩容
- ❌ **动态挂载**: 运行时添加磁盘
- ❌ **动态卸载**: 运行时移除磁盘
- ❌ **网络动态调整**: 运行时添加/删除网络接口
- ❌ **扩容策略**: 自动扩容策略

## 4. 技术实现方式

### 4.1 KubeVirt 支持

#### CPU/内存热扩容
- KubeVirt 支持 CPU 和内存热扩容（需要 VM 内操作系统支持）
- 通过修改 VirtualMachineInstance 的 Domain 配置
- 需要 VM 内安装 QEMU Guest Agent

#### 磁盘热扩容
- 需要存储后端支持（Longhorn、Ceph 等）
- 通过 PVC 扩容 + VM 内文件系统扩容
- 需要 VM 内操作系统支持

#### 动态挂载/卸载磁盘
- 通过修改 VirtualMachineInstance 的 Volumes 和 Disks
- 需要 VM 内操作系统支持热插拔

### 4.2 实现方案

#### 方案一：直接更新 Spec
```go
// 更新 CPU
vmp.Spec.CPU = newCPU
c.Update(ctx, vmp)

// 更新内存
vmp.Spec.Memory = newMemory
c.Update(ctx, vmp)
```

#### 方案二：热扩容（无需重启）
```go
// 直接更新 VMI（如果支持热扩容）
vmi.Spec.Domain.CPU.Cores = newCPU
vmi.Spec.Domain.Memory.Guest = newMemory
c.Update(ctx, vmi)
```

## 5. 功能分类

### 5.1 计算资源类
- **CPU 扩缩容**: 增加/减少 CPU 核心数
- **内存扩缩容**: 增加/减少内存大小

### 5.2 存储资源类
- **磁盘热扩容**: 扩容现有磁盘
- **动态挂载磁盘**: 运行时添加新磁盘
- **动态卸载磁盘**: 运行时移除磁盘

### 5.3 网络资源类
- **网络扩缩容**: 添加/删除网络接口
- **网络配置更新**: 更新网络配置

## 6. 实现优先级

### 第一阶段（核心功能）
1. **CPU 热扩容** - 支持运行时增加 CPU
2. **内存热扩容** - 支持运行时增加内存
3. **磁盘热扩容** - 支持运行时扩容磁盘

### 第二阶段（增强功能）
4. **动态挂载磁盘** - 运行时添加磁盘
5. **动态卸载磁盘** - 运行时移除磁盘

### 第三阶段（高级特性）
6. **网络扩缩容** - 动态添加/删除网络接口
7. **自动扩容策略** - 基于指标自动扩容

## 7. 文档结构

- **[13.8.1-CPU内存扩缩容.md](./13.8.1-CPU内存扩缩容.md)** - CPU 和内存扩缩容详解
- **[13.8.2-磁盘热扩容.md](./13.8.2-磁盘热扩容.md)** - 磁盘热扩容详解
- **[13.8.3-动态挂载卸载磁盘.md](./13.8.3-动态挂载卸载磁盘.md)** - 动态挂载/卸载磁盘详解
- **[13.8.4-网络扩缩容.md](./13.8.4-网络扩缩容.md)** - 网络扩缩容详解

## 8. 使用示例

### 8.1 CPU 扩容
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  cpu: 4  # 从 2 扩容到 4
  memory: 8Gi
```

### 8.2 磁盘热扩容
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  disks:
  - name: system
    size: 50Gi  # 从 20Gi 扩容到 50Gi
```

### 8.3 动态挂载磁盘
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  disks:
  - name: system
    size: 20Gi
  - name: data  # 新添加的磁盘
    size: 100Gi
```

## 9. 注意事项

### 9.1 热扩容限制
- 需要 VM 内操作系统支持
- 需要安装 QEMU Guest Agent
- 某些资源可能不支持热扩容

### 9.2 数据安全
- 扩容前建议备份数据
- 确保存储后端支持扩容
- 验证扩容后的数据完整性

### 9.3 性能影响
- 扩容过程可能影响性能
- 需要监控扩容进度
- 提供回滚机制

## 10. 面试要点

### 10.1 为什么需要资源弹性伸缩？

**答案**:
- **资源优化**: 根据实际需求动态调整资源
- **成本控制**: 按需分配，避免资源浪费
- **业务连续性**: 热扩容无需停机
- **灵活性**: 快速响应业务变化

### 10.2 热扩容和冷扩容的区别？

**答案**:
- **热扩容**: 无需重启 VM，业务不中断，但需要操作系统支持
- **冷扩容**: 需要重启 VM，业务中断，但所有系统都支持

### 10.3 如何实现磁盘热扩容？

**答案**:
- 先扩容 PVC（存储后端支持）
- 然后扩容 VM 内的文件系统
- 需要 VM 内操作系统支持（如 resize2fs）
- 通过 QEMU Guest Agent 或 SSH 执行命令

