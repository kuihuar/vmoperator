# 配置文件管理

## 1. 概述

管理 ISO 中的配置文件，包括各组件的 Helm Values 和系统配置。

## 2. 配置文件结构

```
/opt/novasphere/configs/
├── k3s-config.yaml          # k3s 配置
├── longhorn-values.yaml     # Longhorn Helm Values
├── kubevirt-values.yaml     # KubeVirt Helm Values
├── cdi-values.yaml          # CDI Helm Values
├── multus-config.yaml       # Multus 配置
├── nmstate-values.yaml      # NMState Helm Values
├── novasphere-values.yaml   # Novasphere Helm Values
└── system-config.yaml       # 系统配置
```

## 3. k3s 配置

```yaml
# k3s-config.yaml
cluster:
  cidr: "10.42.0.0/16"
  serviceCidr: "10.43.0.0/16"
  clusterDns: "10.43.0.10"

tls:
  san:
    - "192.168.1.141"
    - "k3s.example.com"

disable:
  servicelb: false

dataDir: "/data/k3s"  # 可选，如果数据盘存在
```

## 4. Longhorn 配置

```yaml
# longhorn-values.yaml
persistence:
  defaultDataPath: "/data/longhorn"  # 或 "/var/lib/longhorn"

defaultSettings:
  disableRevisionCounter: "false"
  defaultReplicaCount: "3"
  defaultDataLocality: "disabled"

defaultClass:
  enabled: true
  isDefaultClass: true
  reclaimPolicy: Delete
  allowVolumeExpansion: true
```

## 5. KubeVirt 配置

```yaml
# kubevirt-values.yaml
operator:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi

controller:
  replicas: 2

featureGates:
  LiveMigration: true
  HotplugVolumes: true
  Snapshot: true
  Clone: true
```

## 6. CDI 配置

```yaml
# cdi-values.yaml
controller:
  replicas: 2

apiServer:
  replicas: 2

config:
  dataVolume:
    defaultStorageClass: "longhorn"
    scratchStorageClass: "longhorn"
```

## 7. NMState 配置

```yaml
# nmstate-values.yaml
operator:
  replicas: 2

webhook:
  replicas: 2

handler:
  resources:
    limits:
      cpu: 500m
      memory: 512Mi

config:
  nodeSelector:
    node-type: compute
```

## 8. Novasphere 配置

```yaml
# novasphere-values.yaml
image:
  repository: controller
  tag: latest
  pullPolicy: IfNotPresent

namespace:
  create: true
  name: novasphere-system

manager:
  replicas: 1
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

webhook:
  enabled: true
  certManager:
    enabled: false

metrics:
  enabled: true
```

## 9. 系统配置

```yaml
# system-config.yaml
network:
  interface: "eth0"
  dhcp: true
  static:
    ip: ""
    netmask: ""
    gateway: ""
    dns: []

storage:
  dataDisk: "/dev/sdb"
  dataPath: "/data"

timezone: "UTC"

kernel:
  parameters:
    - "net.ipv4.ip_forward=1"
    - "net.bridge.bridge-nf-call-iptables=1"
```

## 10. 配置模板

使用模板变量支持动态配置：

```bash
# 在脚本中替换变量
sed -i "s|{{DATA_PATH}}|${DATA_PATH}|g" ${CONFIG_FILE}
sed -i "s|{{SERVER_IP}}|${SERVER_IP}|g" ${CONFIG_FILE}
```

## 11. 配置验证

```bash
#!/bin/bash
# scripts/validate-configs.sh

CONFIG_DIR="/opt/novasphere/configs"

for config in ${CONFIG_DIR}/*.yaml; do
    if [ -f "${config}" ]; then
        echo "验证: ${config}"
        yq eval . "${config}" > /dev/null || echo "❌ ${config} 格式错误"
    fi
done
```

## 12. 配置优先级

1. 命令行参数（最高优先级）
2. 环境变量
3. 配置文件
4. 默认值（最低优先级）

