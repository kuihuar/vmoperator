# 依赖包管理

## 1. 概述

管理离线依赖包，支持离线安装。

## 2. 依赖包分类

### 2.1 系统包
- Ubuntu 软件包（.deb）
- 内核模块
- 系统工具

### 2.2 容器镜像
- Docker 镜像（.tar）
- Helm Charts
- 应用二进制

### 2.3 配置文件
- Helm Values
- 系统配置
- 安装脚本

## 3. 包目录结构

```
/opt/novasphere/packages/
├── system/                 # 系统包
│   ├── k3s.deb
│   ├── kubectl.deb
│   └── helm.deb
├── images/                 # 容器镜像
│   ├── k3s-images.tar
│   ├── longhorn-images.tar
│   └── kubevirt-images.tar
└── charts/                 # Helm Charts
    ├── longhorn-1.8.1.tgz
    ├── kubevirt-1.0.0.tgz
    └── novasphere-0.1.0.tgz
```

## 4. 镜像打包

### 4.1 导出镜像
```bash
#!/bin/bash
# scripts/export-images.sh

IMAGES=(
    "longhornio/longhorn-manager:v1.8.1"
    "longhornio/longhorn-ui:v1.8.1"
    "quay.io/kubevirt/virt-operator:v1.0.0"
    "quay.io/kubevirt/virt-controller:v1.0.0"
    "quay.io/cdi-controller/cdi-controller:v1.57.0"
)

OUTPUT_DIR="/opt/novasphere/packages/images"
mkdir -p ${OUTPUT_DIR}

for image in "${IMAGES[@]}"; do
    echo "导出镜像: ${image}"
    docker pull ${image}
    docker save ${image} -o ${OUTPUT_DIR}/$(echo ${image} | tr '/:' '_').tar
done

# 打包所有镜像
tar -czf ${OUTPUT_DIR}/all-images.tar.gz ${OUTPUT_DIR}/*.tar
```

### 4.2 导入镜像
```bash
#!/bin/bash
# scripts/import-images.sh

IMAGES_DIR="/opt/novasphere/packages/images"

for image_tar in ${IMAGES_DIR}/*.tar; do
    echo "导入镜像: ${image_tar}"
    docker load -i ${image_tar}
done
```

## 5. Helm Chart 打包

### 5.1 下载 Charts
```bash
#!/bin/bash
# scripts/download-charts.sh

CHARTS_DIR="/opt/novasphere/packages/charts"
mkdir -p ${CHARTS_DIR}

# 添加仓库
helm repo add longhorn https://charts.longhorn.io
helm repo add kubevirt https://kubevirt.io/charts
helm repo update

# 下载 Charts
helm pull longhorn/longhorn --version 1.8.1 -d ${CHARTS_DIR}
helm pull kubevirt/kubevirt --version 1.0.0 -d ${CHARTS_DIR}
helm pull kubevirt/cdi --version 1.57.0 -d ${CHARTS_DIR}
```

### 5.2 使用本地 Charts
```bash
# 安装时使用本地 Chart
helm install longhorn ./packages/charts/longhorn-1.8.1.tgz
```

## 6. 离线安装支持

### 6.1 镜像仓库配置
```bash
# 配置本地镜像仓库
# /etc/rancher/k3s/registries.yaml
mirrors:
  "docker.io":
    endpoint:
      - "http://local-registry:5000"
```

### 6.2 使用本地包
```bash
# 安装脚本检查本地包
if [ -f "/opt/novasphere/packages/images/all-images.tar.gz" ]; then
    echo "使用本地镜像包"
    tar -xzf /opt/novasphere/packages/images/all-images.tar.gz
    # 导入镜像
    ./scripts/import-images.sh
fi
```

## 7. 包验证

```bash
#!/bin/bash
# scripts/verify-packages.sh

PACKAGES_DIR="/opt/novasphere/packages"

# 检查系统包
for deb in ${PACKAGES_DIR}/system/*.deb; do
    dpkg-deb -I ${deb} > /dev/null || echo "❌ ${deb} 损坏"
done

# 检查镜像
for tar in ${PACKAGES_DIR}/images/*.tar; do
    docker load -i ${tar} > /dev/null 2>&1 || echo "❌ ${tar} 损坏"
done

# 检查 Charts
for tgz in ${PACKAGES_DIR}/charts/*.tgz; do
    helm show chart ${tgz} > /dev/null || echo "❌ ${tgz} 损坏"
done
```

## 8. 包更新

```bash
#!/bin/bash
# scripts/update-packages.sh

# 更新镜像列表
./scripts/export-images.sh

# 更新 Charts
./scripts/download-charts.sh

# 验证
./scripts/verify-packages.sh
```

## 9. 注意事项

- 确保包完整性（MD5 校验）
- 定期更新包版本
- 测试离线安装流程
- 记录包版本信息

