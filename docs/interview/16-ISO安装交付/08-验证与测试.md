# 验证与测试

## 1. 安装验证

### 1.1 自动验证脚本
参考 [03.7-主安装脚本.md](./03.7-主安装脚本.md) 中的验证脚本。

### 1.2 手动验证
```bash
# 执行验证脚本
/opt/novasphere/scripts/verify-installation.sh
```

## 2. 功能测试

### 2.1 k3s 测试
```bash
# 检查节点
kubectl get nodes

# 检查系统 Pod
kubectl get pods -A

# 测试 API
kubectl version
```

### 2.2 Longhorn 测试
```bash
# 创建测试 PVC
kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 1Gi
EOF

# 检查 PVC
kubectl get pvc test-pvc

# 检查 Longhorn Volume
kubectl get volumes.longhorn.io -n longhorn-system
```

### 2.3 KubeVirt 测试
```bash
# 检查 KubeVirt
kubectl get kubevirt -n kubevirt-system

# 创建测试 VM
kubectl apply -f examples/test-vm.yaml

# 检查 VM
kubectl get vm
kubectl get vmi
```

### 2.4 Novasphere 测试
```bash
# 检查 CRD
kubectl get crd wukongs.vm.novasphere.dev

# 创建测试 Wukong
kubectl apply -f examples/wukong-test.yaml

# 检查 Wukong
kubectl get wukong
kubectl describe wukong test-wukong
```

## 3. 性能测试

### 3.1 资源使用
```bash
# 检查节点资源
kubectl top nodes

# 检查 Pod 资源
kubectl top pods -A
```

### 3.2 存储性能
```bash
# 测试存储 I/O
kubectl run storage-test --image=busybox --rm -it -- \
  sh -c "dd if=/dev/zero of=/tmp/test bs=1M count=100"
```

## 4. 集成测试

### 4.1 端到端测试
```bash
# 创建完整的 Wukong
kubectl apply -f examples/wukong-complete.yaml

# 等待 VM 启动
kubectl wait --for=condition=Ready vmi/test-vm --timeout=5m

# 测试 VM 连接
kubectl get vmi test-vm -o yaml
```

## 5. ISO 测试

### 5.1 虚拟机测试
- 在虚拟机中测试 ISO 安装
- 验证所有功能
- 记录问题

### 5.2 物理机测试
- 在实际硬件上测试
- 验证硬件兼容性
- 测试性能

## 6. 测试清单

- [ ] k3s 安装成功
- [ ] Longhorn 安装成功
- [ ] Multus 安装成功
- [ ] NMState 安装成功
- [ ] KubeVirt 安装成功
- [ ] CDI 安装成功
- [ ] Novasphere 安装成功
- [ ] 所有 Pod 运行正常
- [ ] 存储功能正常
- [ ] 网络功能正常
- [ ] VM 创建成功
- [ ] 性能满足要求

## 7. 问题排查

### 7.1 日志检查
```bash
# 检查安装日志
journalctl -u novasphere-install

# 检查组件日志
kubectl logs -n longhorn-system -l app=longhorn-manager
kubectl logs -n kubevirt-system -l kubevirt.io=virt-operator
```

### 7.2 常见问题
- 网络连接问题
- 镜像下载失败
- 资源不足
- 配置错误

