# 系统镜像定制

## 1. 概述

定制 Ubuntu 系统镜像，预安装必要的工具和配置。

## 2. 基础镜像选择

### 2.1 Ubuntu Server 22.04 LTS
- **版本**: 22.04.3 LTS
- **架构**: amd64
- **类型**: Live Server ISO
- **优势**: 长期支持，稳定可靠

### 2.2 最小化镜像
- 使用 Ubuntu Minimal ISO
- 减少镜像大小
- 加快安装速度

## 3. 预安装软件包

### 3.1 系统工具
```bash
# 基础工具
apt-get install -y \
  curl \
  wget \
  git \
  vim \
  htop \
  net-tools \
  iputils-ping \
  dnsutils \
  jq \
  yq \
  unzip \
  tar \
  gzip
```

### 3.2 容器工具
```bash
# Docker (可选，k3s 内置 containerd)
apt-get install -y \
  containerd \
  runc
```

### 3.3 Kubernetes 工具
```bash
# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

### 3.4 k3s
```bash
# k3s 二进制（预下载）
wget https://github.com/k3s-io/k3s/releases/download/v1.28.0+k3s1/k3s
chmod +x k3s
mv k3s /usr/local/bin/
```

## 4. 系统配置

### 4.1 网络配置
```bash
# /etc/netplan/00-novasphere.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: true
      optional: true
```

### 4.2 时区配置
```bash
timedatectl set-timezone UTC
```

### 4.3 系统服务
```bash
# 禁用不必要的服务
systemctl disable snapd
systemctl disable unattended-upgrades
```

### 4.4 内核参数
```bash
# /etc/sysctl.d/99-novasphere.conf
# 网络参数
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# 虚拟化参数
vm.swappiness = 10
vm.overcommit_memory = 1
```

### 4.5 用户配置
```bash
# 创建 novasphere 用户
useradd -m -s /bin/bash novasphere
usermod -aG sudo novasphere
echo "novasphere:novasphere" | chpasswd

# 配置 sudo 免密
echo "novasphere ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/novasphere
```

## 5. 文件系统定制

### 5.1 目录结构
```bash
# 创建应用目录
mkdir -p /opt/novasphere/{scripts,configs,charts,packages,logs}

# 设置权限
chown -R novasphere:novasphere /opt/novasphere
chmod -R 755 /opt/novasphere
```

### 5.2 安装脚本
```bash
# 复制安装脚本
cp -r scripts/* /opt/novasphere/scripts/
chmod +x /opt/novasphere/scripts/*.sh
```

### 5.3 配置文件
```bash
# 复制配置文件
cp -r configs/* /opt/novasphere/configs/
```

### 5.4 Helm Charts
```bash
# 复制 Helm Charts
cp -r charts/* /opt/novasphere/charts/
```

## 6. 自动启动配置

### 6.1 systemd 服务
```bash
# /etc/systemd/system/novasphere-install.service
[Unit]
Description=Novasphere Installation Service
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/opt/novasphere/scripts/install.sh
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 6.2 启用服务
```bash
systemctl enable novasphere-install.service
```

## 7. 定制脚本

### 7.1 文件系统定制脚本
```bash
#!/bin/bash
# scripts/customize-filesystem.sh

set -e

CHROOT_DIR=$1

if [ -z "$CHROOT_DIR" ]; then
  echo "Usage: $0 <chroot_directory>"
  exit 1
fi

echo "定制文件系统: ${CHROOT_DIR}"

# 挂载必要的文件系统
sudo mount --bind /dev ${CHROOT_DIR}/dev
sudo mount --bind /proc ${CHROOT_DIR}/proc
sudo mount --bind /sys ${CHROOT_DIR}/sys

# 进入 chroot
sudo chroot ${CHROOT_DIR} /bin/bash <<EOF
# 更新包列表
apt-get update

# 安装基础工具
apt-get install -y curl wget git vim htop net-tools

# 安装 kubectl
curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# 安装 Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# 创建目录
mkdir -p /opt/novasphere/{scripts,configs,charts,packages,logs}

# 配置内核参数
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.d/99-novasphere.conf
echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.d/99-novasphere.conf

# 清理
apt-get clean
rm -rf /var/lib/apt/lists/*
EOF

# 卸载文件系统
sudo umount ${CHROOT_DIR}/dev
sudo umount ${CHROOT_DIR}/proc
sudo umount ${CHROOT_DIR}/sys

echo "文件系统定制完成"
```

## 8. 镜像优化

### 8.1 减小镜像大小
```bash
# 清理缓存
apt-get clean
rm -rf /var/lib/apt/lists/*
rm -rf /tmp/*
rm -rf /var/tmp/*

# 清理日志
journalctl --vacuum-time=1d
```

### 8.2 压缩文件系统
```bash
# 使用更高的压缩比
mksquashfs /mnt filesystem.squashfs -comp xz -b 1M
```

## 9. 验证定制

### 9.1 验证脚本
```bash
#!/bin/bash
# scripts/verify-customization.sh

CHROOT_DIR=$1

echo "验证定制内容..."

# 检查工具
sudo chroot ${CHROOT_DIR} which kubectl || echo "❌ kubectl 未安装"
sudo chroot ${CHROOT_DIR} which helm || echo "❌ helm 未安装"

# 检查目录
[ -d "${CHROOT_DIR}/opt/novasphere" ] || echo "❌ 应用目录不存在"

# 检查脚本
[ -f "${CHROOT_DIR}/opt/novasphere/scripts/install.sh" ] || echo "❌ 安装脚本不存在"

echo "验证完成"
```

## 10. 注意事项

- 确保所有路径使用绝对路径
- 测试 chroot 环境中的命令
- 验证网络连接（如果需要）
- 检查磁盘空间
- 测试自动启动服务

