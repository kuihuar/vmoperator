# 应用安装脚本

## 1. 概述

安装 Novasphere Operator。

## 2. 脚本内容

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-novasphere.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-novasphere.log"
VALUES_FILE="/opt/novasphere/configs/novasphere-values.yaml"
CHART_PATH="/opt/novasphere/charts/novasphere"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 Novasphere Operator..."

# 1. 检查依赖
log "检查依赖..."

# 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 检查 Longhorn
if ! kubectl get storageclass longhorn &> /dev/null; then
    log "错误: Longhorn 未安装"
    exit 1
fi

# 检查 KubeVirt
if ! kubectl get crd virtualmachines.kubevirt.io &> /dev/null; then
    log "错误: KubeVirt 未安装"
    exit 1
fi

# 检查 CDI
if ! kubectl get crd datavolumes.cdi.kubevirt.io &> /dev/null; then
    log "错误: CDI 未安装"
    exit 1
fi

log "所有依赖检查通过"

# 2. 检查 Helm
if ! command -v helm &> /dev/null; then
    log "错误: Helm 未安装"
    exit 1
fi

# 3. 准备镜像（如果使用本地镜像）
IMAGE_REPO="${NOVASPHERE_IMAGE_REPO:-controller}"
IMAGE_TAG="${NOVASPHERE_IMAGE_TAG:-latest}"
log "使用镜像: ${IMAGE_REPO}:${IMAGE_TAG}"

# 4. 准备 Values 文件
if [ -f "${VALUES_FILE}" ]; then
    log "使用配置文件: ${VALUES_FILE}"
    HELM_VALUES="-f ${VALUES_FILE}"
else
    log "使用默认配置"
    HELM_VALUES=""
fi

# 5. 更新 Helm 依赖（如果使用 Chart）
if [ -d "${CHART_PATH}" ]; then
    log "更新 Helm 依赖..."
    cd ${CHART_PATH}
    helm dependency update
    cd -
fi

# 6. 安装 Novasphere
log "安装 Novasphere Operator..."
if [ -d "${CHART_PATH}" ]; then
    # 使用本地 Chart
    helm install novasphere ${CHART_PATH} \
        --namespace novasphere-system \
        --create-namespace \
        --set image.repository=${IMAGE_REPO} \
        --set image.tag=${IMAGE_TAG} \
        ${HELM_VALUES} \
        --wait \
        --timeout 10m
else
    # 使用远程 Chart（如果发布到仓库）
    helm repo add novasphere https://charts.novasphere.io
    helm repo update
    helm install novasphere novasphere/novasphere \
        --namespace novasphere-system \
        --create-namespace \
        --version ${IMAGE_TAG} \
        ${HELM_VALUES} \
        --wait \
        --timeout 10m
fi

# 7. 等待 Novasphere 就绪
log "等待 Novasphere 就绪..."
kubectl wait --for=condition=ready pod \
    -l control-plane=controller-manager \
    -n novasphere-system \
    --timeout=10m

# 8. 验证安装
log "验证 Novasphere 安装..."
kubectl get pods -n novasphere-system
kubectl get crd | grep novasphere

# 9. 检查 CRD
log "检查 CRD..."
kubectl get crd wukongs.vm.novasphere.dev

log "Novasphere Operator 安装完成"
```

## 3. 配置文件示例

```yaml
# /opt/novasphere/configs/novasphere-values.yaml
image:
  repository: controller
  tag: latest
  pullPolicy: IfNotPresent

namespace:
  create: true
  name: novasphere-system

manager:
  replicas: 1
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

webhook:
  enabled: true
  certManager:
    enabled: false

metrics:
  enabled: true

rbac:
  create: true
  wukongRoles:
    enabled: true
```

## 4. 执行方式

```bash
# 手动执行
sudo /opt/novasphere/scripts/install-novasphere.sh

# 指定镜像
NOVASPHERE_IMAGE_REPO=myregistry/novasphere \
NOVASPHERE_IMAGE_TAG=v1.0.0 \
sudo /opt/novasphere/scripts/install-novasphere.sh
```

## 5. 验证

```bash
# 检查 Pod
kubectl get pods -n novasphere-system

# 检查 CRD
kubectl get crd | grep novasphere

# 检查 Wukong CRD
kubectl get crd wukongs.vm.novasphere.dev

# 测试创建 Wukong
kubectl apply -f examples/wukong.yaml
```

## 6. 卸载

```bash
# 卸载 Novasphere
helm uninstall novasphere --namespace novasphere-system
```

## 7. 注意事项

- 需要所有依赖组件已安装
- 确保镜像可访问（本地或远程）
- 配置文件路径需要正确
- 安装需要较长时间（下载镜像）

