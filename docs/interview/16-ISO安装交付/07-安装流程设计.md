# 安装流程设计

## 1. 完整安装流程

```
ISO 启动
    ↓
Ubuntu 安装（自动/手动）
    ↓
系统首次启动
    ↓
systemd 服务启动
    ↓
执行主安装脚本
    ↓
1. 系统环境准备
    ├── 内核参数配置
    ├── 网络配置
    └── 存储配置
    ↓
2. k3s 安装
    ├── 下载 k3s
    ├── 配置 k3s
    └── 启动 k3s
    ↓
3. Longhorn 安装
    ├── 添加 Helm 仓库
    ├── 安装 Longhorn
    └── 配置存储类
    ↓
4. 网络组件安装
    ├── Multus 安装
    └── NMState 安装
    ↓
5. 虚拟化平台安装
    ├── KubeVirt 安装
    └── CDI 安装
    ↓
6. Novasphere 安装
    ├── 安装 Operator
    └── 验证 CRD
    ↓
7. 验证安装
    ├── 检查所有组件
    └── 生成访问信息
    ↓
安装完成
```

## 2. 安装模式

### 2.1 自动安装
- 无人值守安装
- 使用默认配置
- 适合生产环境

### 2.2 交互式安装
- 用户选择配置
- 自定义安装选项
- 适合开发环境

## 3. 安装脚本执行

### 3.1 systemd 服务
```ini
# /etc/systemd/system/novasphere-install.service
[Unit]
Description=Novasphere Installation
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/opt/novasphere/scripts/install.sh
StandardOutput=journal
StandardError=journal
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

### 3.2 启用服务
```bash
systemctl enable novasphere-install.service
systemctl start novasphere-install.service
```

## 4. 进度跟踪

### 4.1 进度文件
```bash
# /opt/novasphere/logs/install-progress.txt
1/7: 系统环境准备 - 完成
2/7: k3s 安装 - 进行中
3/7: Longhorn 安装 - 等待
...
```

### 4.2 进度查询
```bash
cat /opt/novasphere/logs/install-progress.txt
```

## 5. 错误处理

### 5.1 错误记录
- 记录到日志文件
- 记录到 systemd journal
- 生成错误报告

### 5.2 重试机制
```bash
# 重试失败的步骤
MAX_RETRIES=3
RETRY_COUNT=0

while [ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]; do
    if ${SCRIPT}; then
        break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    sleep 10
done
```

### 5.3 回滚功能
```bash
# 回滚到上一个成功步骤
./scripts/rollback.sh
```

## 6. 安装验证

### 6.1 自动验证
安装完成后自动执行验证脚本。

### 6.2 手动验证
```bash
/opt/novasphere/scripts/verify-installation.sh
```

## 7. 安装时间估算

| 步骤 | 预计时间 |
|------|---------|
| 系统环境准备 | 2-5 分钟 |
| k3s 安装 | 5-10 分钟 |
| Longhorn 安装 | 10-15 分钟 |
| 网络组件安装 | 5-10 分钟 |
| 虚拟化平台安装 | 15-20 分钟 |
| Novasphere 安装 | 5-10 分钟 |
| 验证 | 2-5 分钟 |
| **总计** | **45-75 分钟** |

## 8. 安装后配置

### 8.1 访问信息
安装完成后显示：
- k3s API 地址
- Longhorn UI 地址
- Novasphere 状态

### 8.2 初始配置
- 创建示例 Wukong
- 配置网络策略
- 设置监控

## 9. 注意事项

- 确保网络连接稳定
- 预留足够磁盘空间
- 检查硬件兼容性
- 记录安装日志

