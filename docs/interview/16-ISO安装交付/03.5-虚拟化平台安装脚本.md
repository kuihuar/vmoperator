# 虚拟化平台安装脚本

## 1. 概述

安装 KubeVirt 和 CDI（Containerized Data Importer）。

## 2. KubeVirt 安装脚本

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-kubevirt.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-kubevirt.log"
VALUES_FILE="/opt/novasphere/configs/kubevirt-values.yaml"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 KubeVirt..."

# 1. 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 2. 检查 Helm
if ! command -v helm &> /dev/null; then
    log "错误: Helm 未安装"
    exit 1
fi

# 3. 添加 KubeVirt 仓库
log "添加 KubeVirt Helm 仓库..."
helm repo add kubevirt https://kubevirt.io/charts
helm repo update

# 4. 准备 Values 文件
if [ -f "${VALUES_FILE}" ]; then
    log "使用配置文件: ${VALUES_FILE}"
    HELM_VALUES="-f ${VALUES_FILE}"
else
    log "使用默认配置"
    HELM_VALUES="--set featureGates.LiveMigration=true"
fi

# 5. 安装 KubeVirt
log "安装 KubeVirt..."
helm install kubevirt kubevirt/kubevirt \
    --namespace kubevirt-system \
    --create-namespace \
    --version 1.0.0 \
    ${HELM_VALUES} \
    --wait \
    --timeout 15m

# 6. 等待 KubeVirt 就绪
log "等待 KubeVirt 就绪..."
kubectl wait --for=condition=ready pod \
    -l kubevirt.io=virt-operator \
    -n kubevirt-system \
    --timeout=15m

# 7. 验证安装
log "验证 KubeVirt 安装..."
kubectl get pods -n kubevirt-system
kubectl get crd | grep kubevirt.io

log "KubeVirt 安装完成"
```

## 3. CDI 安装脚本

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-cdi.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-cdi.log"
VALUES_FILE="/opt/novasphere/configs/cdi-values.yaml"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 CDI..."

# 1. 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 2. 检查 KubeVirt
if ! kubectl get crd virtualmachines.kubevirt.io &> /dev/null; then
    log "错误: KubeVirt 未安装"
    exit 1
fi

# 3. 检查 Helm
if ! command -v helm &> /dev/null; then
    log "错误: Helm 未安装"
    exit 1
fi

# 4. 添加 KubeVirt 仓库（CDI 在同一仓库）
log "添加 KubeVirt Helm 仓库..."
helm repo add kubevirt https://kubevirt.io/charts
helm repo update

# 5. 获取默认存储类
DEFAULT_STORAGE_CLASS=$(kubectl get storageclass -o jsonpath='{.items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")].metadata.name}')
if [ -z "${DEFAULT_STORAGE_CLASS}" ]; then
    DEFAULT_STORAGE_CLASS="longhorn"
fi
log "默认存储类: ${DEFAULT_STORAGE_CLASS}"

# 6. 准备 Values 文件
if [ -f "${VALUES_FILE}" ]; then
    log "使用配置文件: ${VALUES_FILE}"
    HELM_VALUES="-f ${VALUES_FILE}"
else
    log "使用默认配置"
    HELM_VALUES="--set config.dataVolume.defaultStorageClass=${DEFAULT_STORAGE_CLASS}"
fi

# 7. 安装 CDI
log "安装 CDI..."
helm install cdi kubevirt/cdi \
    --namespace cdi-system \
    --create-namespace \
    --version 1.57.0 \
    ${HELM_VALUES} \
    --wait \
    --timeout 15m

# 8. 等待 CDI 就绪
log "等待 CDI 就绪..."
kubectl wait --for=condition=ready pod \
    -l cdi.kubevirt.io \
    -n cdi-system \
    --timeout=15m

# 9. 验证安装
log "验证 CDI 安装..."
kubectl get pods -n cdi-system
kubectl get crd | grep cdi.kubevirt.io

log "CDI 安装完成"
```

## 4. 配置文件示例

### 4.1 KubeVirt Values
```yaml
# /opt/novasphere/configs/kubevirt-values.yaml
operator:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 256Mi

controller:
  replicas: 2

featureGates:
  LiveMigration: true
  HotplugVolumes: true
  Snapshot: true
  Clone: true
```

### 4.2 CDI Values
```yaml
# /opt/novasphere/configs/cdi-values.yaml
controller:
  replicas: 2

apiServer:
  replicas: 2

config:
  dataVolume:
    defaultStorageClass: "longhorn"
    scratchStorageClass: "longhorn"
```

## 5. 执行方式

```bash
# 安装 KubeVirt
sudo /opt/novasphere/scripts/install-kubevirt.sh

# 安装 CDI
sudo /opt/novasphere/scripts/install-cdi.sh
```

## 6. 验证

```bash
# 验证 KubeVirt
kubectl get pods -n kubevirt-system
kubectl get crd | grep kubevirt.io
kubectl get kubevirt -n kubevirt-system

# 验证 CDI
kubectl get pods -n cdi-system
kubectl get crd | grep cdi.kubevirt.io
```

## 7. 注意事项

- CDI 依赖 KubeVirt，需要先安装 KubeVirt
- 需要配置正确的存储类
- 安装需要较长时间（下载镜像）
- 确保节点资源充足

