# 主安装脚本

## 1. 概述

主安装脚本编排所有组件的安装流程。

## 2. 脚本内容

```bash
#!/bin/bash
# /opt/novasphere/scripts/install.sh

set -e

LOG_FILE="/opt/novasphere/logs/install.log"
SCRIPT_DIR="/opt/novasphere/scripts"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1" | tee -a ${LOG_FILE}
    exit 1
}

# 创建日志目录
mkdir -p /opt/novasphere/logs

log "=========================================="
log "开始 Novasphere 安装流程"
log "=========================================="

# 1. 系统环境准备
log "步骤 1/7: 系统环境准备"
if ! ${SCRIPT_DIR}/prepare-system.sh; then
    error "系统环境准备失败"
fi

# 2. 安装 k3s
log "步骤 2/7: 安装 k3s"
if ! ${SCRIPT_DIR}/install-k3s.sh; then
    error "k3s 安装失败"
fi

# 等待 k3s 稳定
log "等待 k3s 稳定..."
sleep 30

# 3. 安装 Longhorn
log "步骤 3/7: 安装 Longhorn"
if ! ${SCRIPT_DIR}/install-longhorn.sh; then
    error "Longhorn 安装失败"
fi

# 4. 安装网络组件
log "步骤 4/7: 安装网络组件"

# 4.1 安装 Multus
log "安装 Multus..."
if ! ${SCRIPT_DIR}/install-multus.sh; then
    error "Multus 安装失败"
fi

# 4.2 安装 NMState
log "安装 NMState..."
if ! ${SCRIPT_DIR}/install-nmstate.sh; then
    error "NMState 安装失败"
fi

# 5. 安装虚拟化平台
log "步骤 5/7: 安装虚拟化平台"

# 5.1 安装 KubeVirt
log "安装 KubeVirt..."
if ! ${SCRIPT_DIR}/install-kubevirt.sh; then
    error "KubeVirt 安装失败"
fi

# 5.2 安装 CDI
log "安装 CDI..."
if ! ${SCRIPT_DIR}/install-cdi.sh; then
    error "CDI 安装失败"
fi

# 6. 安装 Novasphere Operator
log "步骤 6/7: 安装 Novasphere Operator"
if ! ${SCRIPT_DIR}/install-novasphere.sh; then
    error "Novasphere 安装失败"
fi

# 7. 验证安装
log "步骤 7/7: 验证安装"
if ! ${SCRIPT_DIR}/verify-installation.sh; then
    error "安装验证失败"
fi

log "=========================================="
log "Novasphere 安装完成！"
log "=========================================="

# 显示访问信息
log ""
log "访问信息:"
log "  - k3s API: kubectl get nodes"
log "  - Longhorn UI: kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80"
log "  - Novasphere: kubectl get pods -n novasphere-system"
log ""
log "安装日志: ${LOG_FILE}"
log ""
```

## 3. 验证脚本

```bash
#!/bin/bash
# /opt/novasphere/scripts/verify-installation.sh

set -e

LOG_FILE="/opt/novasphere/logs/verify-installation.log"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1" | tee -a ${LOG_FILE}
    return 1
}

log "开始验证安装..."

# 1. 检查 k3s
log "检查 k3s..."
if ! kubectl get nodes &> /dev/null; then
    error "k3s 未就绪"
    exit 1
fi
log "✓ k3s 就绪"

# 2. 检查 Longhorn
log "检查 Longhorn..."
if ! kubectl get storageclass longhorn &> /dev/null; then
    error "Longhorn 未安装"
    exit 1
fi
if ! kubectl get pods -n longhorn-system | grep -q Running; then
    error "Longhorn Pod 未运行"
    exit 1
fi
log "✓ Longhorn 就绪"

# 3. 检查 Multus
log "检查 Multus..."
if ! kubectl get daemonset -n kube-system | grep -q multus; then
    error "Multus 未安装"
    exit 1
fi
log "✓ Multus 就绪"

# 4. 检查 NMState
log "检查 NMState..."
if ! kubectl get pods -n nmstate-system | grep -q Running; then
    error "NMState 未就绪"
    exit 1
fi
log "✓ NMState 就绪"

# 5. 检查 KubeVirt
log "检查 KubeVirt..."
if ! kubectl get crd virtualmachines.kubevirt.io &> /dev/null; then
    error "KubeVirt 未安装"
    exit 1
fi
if ! kubectl get pods -n kubevirt-system | grep -q Running; then
    error "KubeVirt Pod 未运行"
    exit 1
fi
log "✓ KubeVirt 就绪"

# 6. 检查 CDI
log "检查 CDI..."
if ! kubectl get crd datavolumes.cdi.kubevirt.io &> /dev/null; then
    error "CDI 未安装"
    exit 1
fi
if ! kubectl get pods -n cdi-system | grep -q Running; then
    error "CDI Pod 未运行"
    exit 1
fi
log "✓ CDI 就绪"

# 7. 检查 Novasphere
log "检查 Novasphere..."
if ! kubectl get crd wukongs.vm.novasphere.dev &> /dev/null; then
    error "Novasphere CRD 不存在"
    exit 1
fi
if ! kubectl get pods -n novasphere-system | grep -q Running; then
    error "Novasphere Pod 未运行"
    exit 1
fi
log "✓ Novasphere 就绪"

log "所有组件验证通过！"
```

## 4. systemd 服务配置

```ini
# /etc/systemd/system/novasphere-install.service
[Unit]
Description=Novasphere Installation Service
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/opt/novasphere/scripts/install.sh
StandardOutput=journal
StandardError=journal
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

## 5. 执行方式

### 5.1 自动执行
系统安装完成后自动执行（通过 systemd 服务）

### 5.2 手动执行
```bash
sudo /opt/novasphere/scripts/install.sh
```

## 6. 日志查看

```bash
# 查看安装日志
tail -f /opt/novasphere/logs/install.log

# 查看 systemd 日志
journalctl -u novasphere-install -f
```

## 7. 错误处理

- 每个步骤都有错误检查
- 失败时记录详细错误信息
- 支持从失败步骤重新开始
- 提供回滚功能

## 8. 注意事项

- 需要网络连接（下载镜像）
- 安装需要较长时间（30-60 分钟）
- 确保磁盘空间充足
- 建议在稳定网络环境下安装

