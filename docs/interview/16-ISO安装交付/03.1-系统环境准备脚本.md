# 系统环境准备脚本

## 1. 概述

准备系统环境，包括网络、存储、内核参数等配置。

## 2. 脚本内容

```bash
#!/bin/bash
# /opt/novasphere/scripts/prepare-system.sh

set -e

LOG_FILE="/opt/novasphere/logs/prepare-system.log"
mkdir -p /opt/novasphere/logs

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始系统环境准备..."

# 1. 配置内核参数
log "配置内核参数..."
cat >> /etc/sysctl.d/99-novasphere.conf <<EOF
# 网络转发
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Bridge 网络
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-arptables = 1

# 虚拟化优化
vm.swappiness = 10
vm.overcommit_memory = 1
vm.max_map_count = 262144

# 网络优化
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 8192
EOF

sysctl -p /etc/sysctl.d/99-novasphere.conf

# 2. 加载内核模块
log "加载内核模块..."
modprobe br_netfilter
modprobe overlay
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh

# 持久化模块加载
cat >> /etc/modules-load.d/novasphere.conf <<EOF
br_netfilter
overlay
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
EOF

# 3. 配置防火墙（如果启用）
log "配置防火墙..."
if systemctl is-active --quiet ufw; then
    ufw allow 6443/tcp  # k3s API
    ufw allow 10250/tcp # kubelet
    ufw allow 8472/udp # Flannel VXLAN
    ufw allow 51820/udp # Flannel WireGuard
    ufw allow 9500/tcp # Longhorn Manager
    ufw allow 9501/tcp # Longhorn Manager
    ufw allow 32607/tcp # Longhorn UI
fi

# 4. 配置时区
log "配置时区..."
timedatectl set-timezone UTC

# 5. 配置 DNS
log "配置 DNS..."
if [ ! -f /etc/systemd/resolved.conf.bak ]; then
    cp /etc/systemd/resolved.conf /etc/systemd/resolved.conf.bak
fi

cat > /etc/systemd/resolved.conf <<EOF
[Resolve]
DNS=8.8.8.8 1.1.1.1
FallbackDNS=8.8.4.4 1.0.0.1
Domains=~.
EOF

systemctl restart systemd-resolved

# 6. 配置 swap（可选，建议禁用）
log "配置 swap..."
if [ -f /etc/fstab ]; then
    sed -i '/swap/d' /etc/fstab
fi
swapoff -a

# 7. 配置数据盘（如果存在）
log "检查数据盘..."
if [ -b /dev/sdb ]; then
    log "发现数据盘 /dev/sdb"
    
    # 检查是否已格式化
    if ! blkid /dev/sdb > /dev/null 2>&1; then
        log "格式化数据盘..."
        mkfs.ext4 -F /dev/sdb
    fi
    
    # 挂载数据盘
    if ! grep -q "/data" /etc/fstab; then
        log "配置数据盘挂载..."
        mkdir -p /data
        echo "/dev/sdb /data ext4 defaults 0 2" >> /etc/fstab
        mount -a
    fi
fi

# 8. 创建必要的目录
log "创建必要的目录..."
mkdir -p /opt/novasphere/{configs,charts,packages,logs}
mkdir -p /var/lib/rancher/k3s
mkdir -p /etc/rancher/k3s

# 9. 配置日志轮转
log "配置日志轮转..."
cat > /etc/logrotate.d/novasphere <<EOF
/opt/novasphere/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
EOF

# 10. 配置系统服务
log "配置系统服务..."
# 禁用不必要的服务
systemctl disable snapd 2>/dev/null || true
systemctl disable unattended-upgrades 2>/dev/null || true

log "系统环境准备完成"
```

## 3. 执行方式

```bash
# 手动执行
sudo /opt/novasphere/scripts/prepare-system.sh

# 查看日志
tail -f /opt/novasphere/logs/prepare-system.log
```

## 4. 验证

```bash
# 检查内核参数
sysctl net.ipv4.ip_forward
sysctl net.bridge.bridge-nf-call-iptables

# 检查内核模块
lsmod | grep br_netfilter
lsmod | grep overlay

# 检查数据盘
df -h /data
```

## 5. 注意事项

- 需要 root 权限
- 某些操作需要重启生效
- 数据盘挂载需要确保设备存在
- 防火墙规则根据实际需求调整

