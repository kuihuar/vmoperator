# 网络组件安装脚本

## 1. 概述

安装 Multus CNI 和 NMState Operator。

## 2. Multus 安装脚本

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-multus.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-multus.log"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 Multus CNI..."

# 1. 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 2. 检查是否已安装
if kubectl get daemonset -n kube-system | grep -q multus; then
    log "Multus 已安装，跳过"
    exit 0
fi

# 3. 安装 Multus
log "安装 Multus CNI..."
kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml

# 4. 等待 Multus 就绪
log "等待 Multus 就绪..."
kubectl wait --for=condition=ready pod \
    -l app=multus \
    -n kube-system \
    --timeout=5m

# 5. 验证安装
log "验证 Multus 安装..."
kubectl get daemonset -n kube-system | grep multus
kubectl get pods -n kube-system | grep multus

log "Multus 安装完成"
```

## 3. NMState 安装脚本

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-nmstate.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-nmstate.log"
VALUES_FILE="/opt/novasphere/configs/nmstate-values.yaml"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 NMState Operator..."

# 1. 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 2. 检查 Helm
if ! command -v helm &> /dev/null; then
    log "错误: Helm 未安装"
    exit 1
fi

# 3. 添加 NMState 仓库
log "添加 NMState Helm 仓库..."
helm repo add nmstate https://nmstate.github.io/nmstate-operator
helm repo update

# 4. 准备 Values 文件
if [ -f "${VALUES_FILE}" ]; then
    log "使用配置文件: ${VALUES_FILE}"
    HELM_VALUES="-f ${VALUES_FILE}"
else
    log "使用默认配置"
    HELM_VALUES=""
fi

# 5. 安装 NMState
log "安装 NMState Operator..."
helm install nmstate nmstate/nmstate-operator \
    --namespace nmstate-system \
    --create-namespace \
    --version 0.73.0 \
    ${HELM_VALUES} \
    --wait \
    --timeout 10m

# 6. 等待 NMState 就绪
log "等待 NMState 就绪..."
kubectl wait --for=condition=ready pod \
    -l app.kubernetes.io/name=nmstate-operator \
    -n nmstate-system \
    --timeout=10m

# 7. 验证安装
log "验证 NMState 安装..."
kubectl get pods -n nmstate-system
kubectl get crd | grep nmstate.io

log "NMState 安装完成"
```

## 4. 配置文件示例

```yaml
# /opt/novasphere/configs/nmstate-values.yaml
operator:
  replicas: 2
  resources:
    limits:
      cpu: 200m
      memory: 256Mi

webhook:
  replicas: 2

handler:
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
```

## 5. 执行方式

```bash
# 安装 Multus
sudo /opt/novasphere/scripts/install-multus.sh

# 安装 NMState
sudo /opt/novasphere/scripts/install-nmstate.sh
```

## 6. 验证

```bash
# 验证 Multus
kubectl get daemonset -n kube-system | grep multus
kubectl get pods -n kube-system | grep multus

# 验证 NMState
kubectl get pods -n nmstate-system
kubectl get crd | grep nmstate.io
kubectl get nnstate
```

## 7. 注意事项

- Multus 是 DaemonSet，需要在所有节点运行
- NMState 需要节点网络配置权限
- 确保网络连通性（下载镜像）
- k3s 需要特殊配置路径

