# 存储安装脚本

## 1. 概述

安装和配置 Longhorn 分布式存储。

## 2. 脚本内容

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-longhorn.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-longhorn.log"
VALUES_FILE="/opt/novasphere/configs/longhorn-values.yaml"
CHART_PATH="/opt/novasphere/charts/longhorn"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 Longhorn..."

# 1. 检查 k3s
if ! kubectl get nodes &> /dev/null; then
    log "错误: k3s 未就绪"
    exit 1
fi

# 2. 检查 Helm
if ! command -v helm &> /dev/null; then
    log "错误: Helm 未安装"
    exit 1
fi

# 3. 添加 Longhorn 仓库
log "添加 Longhorn Helm 仓库..."
helm repo add longhorn https://charts.longhorn.io
helm repo update

# 4. 配置数据路径
if [ -d "/data" ]; then
    DATA_PATH="/data/longhorn"
    log "使用数据盘: ${DATA_PATH}"
    
    # 创建数据目录
    mkdir -p ${DATA_PATH}
    chmod 755 ${DATA_PATH}
else
    DATA_PATH="/var/lib/longhorn"
    log "使用默认路径: ${DATA_PATH}"
fi

# 5. 准备 Values 文件
if [ -f "${VALUES_FILE}" ]; then
    log "使用配置文件: ${VALUES_FILE}"
    # 替换数据路径
    sed -i "s|/var/lib/longhorn|${DATA_PATH}|g" ${VALUES_FILE}
    HELM_VALUES="-f ${VALUES_FILE}"
else
    log "使用默认配置"
    HELM_VALUES="--set persistence.defaultDataPath=${DATA_PATH}"
fi

# 6. 安装 Longhorn
log "安装 Longhorn..."
helm install longhorn longhorn/longhorn \
    --namespace longhorn-system \
    --create-namespace \
    --version 1.8.1 \
    ${HELM_VALUES} \
    --wait \
    --timeout 10m

# 7. 等待 Longhorn 就绪
log "等待 Longhorn 就绪..."
kubectl wait --for=condition=ready pod \
    -l app=longhorn-manager \
    -n longhorn-system \
    --timeout=10m

# 8. 配置默认存储类
log "配置默认存储类..."
kubectl patch storageclass longhorn \
    -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

# 9. 验证安装
log "验证 Longhorn 安装..."
kubectl get pods -n longhorn-system
kubectl get storageclass longhorn

# 10. 获取 UI 访问信息
log "Longhorn UI 访问信息:"
kubectl get svc -n longhorn-system longhorn-frontend

log "Longhorn 安装完成"
```

## 3. 配置文件示例

```yaml
# /opt/novasphere/configs/longhorn-values.yaml
persistence:
  defaultDataPath: "/data/longhorn"

defaultSettings:
  disableRevisionCounter: "false"
  defaultReplicaCount: "3"
  defaultDataLocality: "disabled"

defaultClass:
  enabled: true
  isDefaultClass: true
  reclaimPolicy: Delete
  allowVolumeExpansion: true
```

## 4. 执行方式

```bash
# 手动执行
sudo /opt/novasphere/scripts/install-longhorn.sh

# 查看日志
tail -f /opt/novasphere/logs/install-longhorn.log
```

## 5. 验证

```bash
# 检查 Pod
kubectl get pods -n longhorn-system

# 检查 StorageClass
kubectl get storageclass

# 检查 Longhorn UI
kubectl get svc -n longhorn-system longhorn-frontend

# 端口转发访问 UI
kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80
```

## 6. 卸载

```bash
# 卸载 Longhorn
helm uninstall longhorn --namespace longhorn-system
```

## 7. 注意事项

- 需要 k3s 和 Helm 已安装
- 数据盘需要提前挂载
- 安装需要较长时间（下载镜像）
- 确保节点有足够存储空间

