# 预安装脚本概述

## 1. 概述

预安装脚本在系统安装完成后自动执行，用于安装和配置 Novasphere 应用栈。

## 2. 脚本分类

1. **[03.1-系统环境准备脚本.md](./03.1-系统环境准备脚本.md)** - 系统环境准备
2. **[03.2-k3s安装脚本.md](./03.2-k3s安装脚本.md)** - k3s 安装和配置
3. **[03.3-存储安装脚本.md](./03.3-存储安装脚本.md)** - Longhorn 安装
4. **[03.4-网络组件安装脚本.md](./03.4-网络组件安装脚本.md)** - Multus 和 NMState 安装
5. **[03.5-虚拟化平台安装脚本.md](./03.5-虚拟化平台安装脚本.md)** - KubeVirt 和 CDI 安装
6. **[03.6-应用安装脚本.md](./03.6-应用安装脚本.md)** - Novasphere Operator 安装
7. **[03.7-主安装脚本.md](./03.7-主安装脚本.md)** - 主安装流程编排

## 3. 执行顺序

```
系统安装完成
    ↓
系统环境准备
    ↓
k3s 安装
    ↓
存储安装 (Longhorn)
    ↓
网络组件安装 (Multus, NMState)
    ↓
虚拟化平台安装 (KubeVirt, CDI)
    ↓
应用安装 (Novasphere Operator)
    ↓
验证和启动
```

## 4. 脚本位置

所有脚本位于 ISO 中的 `/opt/novasphere/scripts/` 目录：

```
/opt/novasphere/scripts/
├── install.sh              # 主安装脚本
├── prepare-system.sh       # 系统环境准备
├── install-k3s.sh         # k3s 安装
├── install-longhorn.sh     # Longhorn 安装
├── install-multus.sh       # Multus 安装
├── install-nmstate.sh      # NMState 安装
├── install-kubevirt.sh    # KubeVirt 安装
├── install-cdi.sh          # CDI 安装
├── install-novasphere.sh   # Novasphere 安装
└── verify-installation.sh  # 验证脚本
```

## 5. 执行方式

### 5.1 自动执行
通过 systemd 服务在系统启动后自动执行：

```bash
# /etc/systemd/system/novasphere-install.service
[Unit]
Description=Novasphere Installation
After=network-online.target

[Service]
Type=oneshot
ExecStart=/opt/novasphere/scripts/install.sh
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 5.2 手动执行
```bash
sudo /opt/novasphere/scripts/install.sh
```

## 6. 日志管理

所有脚本输出日志到：
- systemd journal: `journalctl -u novasphere-install`
- 文件日志: `/opt/novasphere/logs/install.log`

## 7. 错误处理

- 每个脚本都有错误检查
- 失败时记录错误日志
- 支持重试机制
- 提供回滚功能

## 8. 配置管理

脚本从 `/opt/novasphere/configs/` 读取配置：
- `k3s-config.yaml` - k3s 配置
- `longhorn-values.yaml` - Longhorn 配置
- `novasphere-values.yaml` - Novasphere 配置

