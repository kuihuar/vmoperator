# k3s 安装脚本

## 1. 概述

安装和配置 k3s Kubernetes 集群。

## 2. 脚本内容

```bash
#!/bin/bash
# /opt/novasphere/scripts/install-k3s.sh

set -e

LOG_FILE="/opt/novasphere/logs/install-k3s.log"
CONFIG_FILE="/opt/novasphere/configs/k3s-config.yaml"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

log "开始安装 k3s..."

# 1. 检查是否已安装
if command -v k3s &> /dev/null; then
    log "k3s 已安装，跳过"
    exit 0
fi

# 2. 获取服务器 IP
SERVER_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
log "服务器 IP: ${SERVER_IP}"

# 3. 读取配置文件（如果存在）
if [ -f "${CONFIG_FILE}" ]; then
    log "读取配置文件: ${CONFIG_FILE}"
    CLUSTER_CIDR=$(yq eval '.cluster.cidr' ${CONFIG_FILE} || echo "10.42.0.0/16")
    SERVICE_CIDR=$(yq eval '.cluster.serviceCidr' ${CONFIG_FILE} || echo "10.43.0.0/16")
    DISABLE_SERVICELB=$(yq eval '.disable.servicelb' ${CONFIG_FILE} || echo "false")
else
    CLUSTER_CIDR="10.42.0.0/16"
    SERVICE_CIDR="10.43.0.0/16"
    DISABLE_SERVICELB="false"
fi

log "集群 CIDR: ${CLUSTER_CIDR}"
log "服务 CIDR: ${SERVICE_CIDR}"

# 4. 构建安装参数
K3S_ARGS="server"
K3S_ARGS="${K3S_ARGS} --tls-san ${SERVER_IP}"
K3S_ARGS="${K3S_ARGS} --cluster-cidr ${CLUSTER_CIDR}"
K3S_ARGS="${K3S_ARGS} --service-cidr ${SERVICE_CIDR}"

if [ "${DISABLE_SERVICELB}" = "true" ]; then
    K3S_ARGS="${K3S_ARGS} --disable servicelb"
fi

# 5. 配置数据路径（如果数据盘存在）
if [ -d "/data" ]; then
    K3S_ARGS="${K3S_ARGS} --data-dir /data/k3s"
    log "使用数据盘: /data/k3s"
fi

# 6. 安装 k3s
log "安装 k3s..."
export INSTALL_K3S_EXEC="${K3S_ARGS}"
curl -sfL https://get.k3s.io | sh -

# 7. 等待 k3s 就绪
log "等待 k3s 就绪..."
for i in {1..60}; do
    if kubectl get nodes &> /dev/null; then
        log "k3s 就绪"
        break
    fi
    sleep 2
done

# 8. 验证安装
log "验证 k3s 安装..."
kubectl get nodes
kubectl get pods -A

# 9. 配置 kubectl
log "配置 kubectl..."
mkdir -p ~/.kube
cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
chmod 600 ~/.kube/config

# 10. 保存配置
log "保存配置..."
mkdir -p /etc/rancher/k3s
cat > /etc/rancher/k3s/config.yaml <<EOF
cluster-cidr: ${CLUSTER_CIDR}
service-cidr: ${SERVICE_CIDR}
tls-san:
  - ${SERVER_IP}
EOF

log "k3s 安装完成"
```

## 3. 配置文件示例

```yaml
# /opt/novasphere/configs/k3s-config.yaml
cluster:
  cidr: "10.42.0.0/16"
  serviceCidr: "10.43.0.0/16"
  clusterDns: "10.43.0.10"

tls:
  san:
    - "192.168.1.141"
    - "k3s.example.com"

disable:
  servicelb: false  # 是否禁用 ServiceLB

dataDir: "/data/k3s"  # 数据目录（可选）
```

## 4. 执行方式

```bash
# 手动执行
sudo /opt/novasphere/scripts/install-k3s.sh

# 查看日志
tail -f /opt/novasphere/logs/install-k3s.log
```

## 5. 验证

```bash
# 检查 k3s 服务
systemctl status k3s

# 检查节点
kubectl get nodes

# 检查 Pod
kubectl get pods -A

# 检查 kubeconfig
kubectl config view
```

## 6. 卸载

```bash
# 卸载 k3s
/usr/local/bin/k3s-uninstall.sh
```

## 7. 注意事项

- 需要网络连接下载 k3s
- 确保端口 6443、10250 等未被占用
- 数据盘挂载需要提前完成
- 配置文件使用 yq 解析（需要预安装）

