# 当前部署方式详解

## 1. 概述

当前项目使用 **Kustomize** 进行部署，通过 `make deploy` 命令执行。

## 2. Makefile 部署命令

### 2.1 deploy 目标
```makefile
.PHONY: deploy
deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.
	cd config/manager && "$(KUSTOMIZE)" edit set image controller=${IMG}
	"$(KUSTOMIZE)" build config/default | "$(KUBECTL)" apply -f -
```

**执行流程**:
1. 生成 manifests（CRD、RBAC、Webhook）
2. 下载/使用 kustomize
3. 设置镜像为 `${IMG}`
4. 构建并应用配置

### 2.2 使用示例
```bash
# 使用默认镜像
make deploy

# 指定镜像
make deploy IMG=myregistry/novasphere:v1.0.0
```

## 3. Kustomize 配置结构

### 3.1 目录结构
```
config/
├── crd/              # CRD 定义
├── rbac/             # RBAC 配置
├── manager/          # Manager Deployment
├── webhook/          # Webhook 配置
├── default/          # 默认环境（生产）
└── development/      # 开发环境
```

### 3.2 default 环境配置

**config/default/kustomization.yaml**:
```yaml
namespace: novasphere-system
namePrefix: novasphere-

resources:
- ../crd
- ../rbac
- ../manager
- ../webhook
- metrics_service.yaml

patches:
- path: manager_metrics_patch.yaml
  target:
    kind: Deployment
- path: manager_webhook_patch.yaml
  target:
    kind: Deployment
```

### 3.3 development 环境配置

**config/development/kustomization.yaml**:
```yaml
namespace: novasphere-system
namePrefix: novasphere-

resources:
- ../crd
- ../rbac
- ../manager
# Webhook 在开发环境禁用
# - ../webhook

patches:
- path: manager_webhook_disable_patch.yaml
  target:
    kind: Deployment
```

## 4. 部署的资源

### 4.1 CRD
- `Wukong` CustomResourceDefinition

### 4.2 RBAC
- ServiceAccount: `controller-manager`
- ClusterRole: `manager-role`
- ClusterRoleBinding: `manager-rolebinding`
- 额外的 Wukong 管理角色（admin, editor, viewer）

### 4.3 Manager Deployment
- Deployment: `controller-manager`
- 命名空间: `novasphere-system`
- 镜像: `controller:latest`（可通过 IMG 覆盖）

### 4.4 Webhook
- MutatingWebhookConfiguration
- ValidatingWebhookConfiguration
- Service: `webhook-service`

### 4.5 Metrics
- Service: `controller-manager-metrics-service`
- 端口: 8443（HTTPS）

## 5. 开发环境特性

### 5.1 Webhook 禁用
开发环境默认禁用 Webhook，避免本地开发时的证书问题。

**config/development/manager_webhook_disable_patch.yaml**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller-manager
  namespace: system
spec:
  template:
    spec:
      containers:
      - name: manager
        args:
        - --enable-webhook=false
```

### 5.2 使用开发环境部署
```bash
# 需要手动指定 development 目录
kustomize build config/development | kubectl apply -f -
```

## 6. 优势与限制

### 6.1 优势
- ✅ 简单直接，适合开发测试
- ✅ 与 Kubebuilder 集成良好
- ✅ 支持多环境（通过不同 kustomization）
- ✅ 无需额外工具（kustomize 已集成）

### 6.2 限制
- ❌ 参数化能力有限
- ❌ 无版本管理
- ❌ 无依赖管理
- ❌ 回滚需要手动操作
- ❌ 不适合生产环境复杂配置

## 7. 迁移到 Helm 的必要性

### 7.1 生产环境需求
- 需要灵活的配置管理
- 需要版本控制和回滚
- 需要依赖管理（如 cert-manager）
- 需要标准化的发布流程

### 7.2 保持兼容性
- 继续支持 `make deploy` 用于开发
- Helm Chart 用于生产部署
- 两者并存

