# 构建与发布流程

## 1. 构建流程概述

```
代码变更
    ↓
构建镜像
    ↓
构建 Helm Chart
    ↓
测试验证
    ↓
发布到 Registry/Repository
    ↓
部署到环境
```

## 2. Makefile 扩展

### 2.1 添加 Helm 相关目标

```makefile
# Helm 相关变量
HELM ?= helm
CHART_PATH ?= ./charts/novasphere
CHART_NAME ?= novasphere
CHART_VERSION ?= $(shell git describe --tags --always --dirty | sed 's/^v//')
APP_VERSION ?= $(shell git describe --tags --always --dirty | sed 's/^v//')

# 构建 Helm Chart
.PHONY: helm-build
helm-build: ## Build Helm chart package
	@echo "Building Helm chart..."
	cd $(CHART_PATH) && \
	$(HELM) package . --version $(CHART_VERSION) --app-version $(APP_VERSION)
	@echo "Chart built: $(CHART_PATH)/$(CHART_NAME)-$(CHART_VERSION).tgz"

# 验证 Helm Chart
.PHONY: helm-lint
helm-lint: ## Lint Helm chart
	$(HELM) lint $(CHART_PATH)

# 渲染 Helm 模板（用于测试）
.PHONY: helm-template
helm-template: ## Render Helm templates
	$(HELM) template $(CHART_NAME) $(CHART_PATH) \
		-f $(CHART_PATH)/values-dev.yaml

# 打包 Chart（包含依赖）
.PHONY: helm-package
helm-package: helm-lint ## Package Helm chart with dependencies
	cd $(CHART_PATH) && \
	$(HELM) dependency update && \
	$(HELM) package . --version $(CHART_VERSION) --app-version $(APP_VERSION)

# 安装 Chart（开发环境）
.PHONY: helm-install-dev
helm-install-dev: helm-lint ## Install Helm chart (development)
	$(HELM) install $(CHART_NAME)-dev $(CHART_PATH) \
		-f $(CHART_PATH)/values-dev.yaml \
		--namespace novasphere-dev \
		--create-namespace \
		--set image.repository=$(IMG) \
		--set image.tag=latest

# 升级 Chart
.PHONY: helm-upgrade
helm-upgrade: helm-lint ## Upgrade Helm chart
	$(HELM) upgrade $(CHART_NAME) $(CHART_PATH) \
		-f $(CHART_PATH)/values-prod.yaml \
		--namespace novasphere-system \
		--set image.repository=$(IMG) \
		--set image.tag=$(APP_VERSION)

# 卸载 Chart
.PHONY: helm-uninstall
helm-uninstall: ## Uninstall Helm chart
	$(HELM) uninstall $(CHART_NAME) --namespace novasphere-system

# 构建完整发布包
.PHONY: build-release
build-release: docker-build helm-package ## Build complete release (image + chart)
	@echo "Release built:"
	@echo "  Image: $(IMG)"
	@echo "  Chart: $(CHART_PATH)/$(CHART_NAME)-$(CHART_VERSION).tgz"
```

## 3. Chart 版本管理

### 3.1 版本策略
- **Chart 版本**: 遵循语义化版本 (SemVer)
- **App 版本**: 与代码版本一致
- **开发版本**: 使用 `-dev` 后缀

### 3.2 Chart.yaml 版本
```yaml
apiVersion: v2
name: novasphere
version: 0.1.0          # Chart 版本
appVersion: "1.0.0"     # 应用版本
```

### 3.3 自动版本更新脚本
```bash
#!/bin/bash
# scripts/update-chart-version.sh

CHART_PATH="./charts/novasphere"
CHART_VERSION=$(git describe --tags --always --dirty | sed 's/^v//')
APP_VERSION=$(git describe --tags --always --dirty | sed 's/^v//')

# 更新 Chart.yaml
sed -i.bak "s/^version:.*/version: ${CHART_VERSION}/" ${CHART_PATH}/Chart.yaml
sed -i.bak "s/^appVersion:.*/appVersion: \"${APP_VERSION}\"/" ${CHART_PATH}/Chart.yaml

echo "Updated Chart version to ${CHART_VERSION}"
echo "Updated App version to ${APP_VERSION}"
```

## 4. 发布流程

### 4.1 本地构建和测试
```bash
# 1. 构建镜像
make docker-build IMG=myregistry/novasphere:v1.0.0

# 2. 推送镜像
make docker-push IMG=myregistry/novasphere:v1.0.0

# 3. 构建 Chart
make helm-package

# 4. 验证 Chart
make helm-lint

# 5. 测试渲染
make helm-template
```

### 4.2 发布到 Helm Repository

#### 4.2.1 使用 GitHub Pages
```bash
# 1. 创建 charts 目录
mkdir -p docs/charts

# 2. 生成 index.yaml
helm repo index docs/charts --url https://github.com/kuihuar/novasphere/releases/download/charts/

# 3. 复制 Chart 包
cp charts/novasphere/novasphere-*.tgz docs/charts/

# 4. 提交到 Git
git add docs/charts/
git commit -m "Release Helm chart v1.0.0"
git push
```

#### 4.2.2 使用 OCI Registry
```bash
# 1. 登录 Registry
helm registry login myregistry.com

# 2. 推送 Chart
helm push charts/novasphere/novasphere-*.tgz oci://myregistry.com/charts
```

### 4.3 发布脚本
```bash
#!/bin/bash
# scripts/release.sh

set -e

VERSION=${1:-$(git describe --tags --always --dirty | sed 's/^v//')}
IMG_REPO=${IMG_REPO:-myregistry/novasphere}
CHART_PATH="./charts/novasphere"

echo "Releasing version: ${VERSION}"

# 1. 构建镜像
echo "Building image..."
make docker-build IMG=${IMG_REPO}:${VERSION}

# 2. 推送镜像
echo "Pushing image..."
make docker-push IMG=${IMG_REPO}:${VERSION}

# 3. 更新 Chart 版本
echo "Updating chart version..."
./scripts/update-chart-version.sh

# 4. 构建 Chart
echo "Building chart..."
make helm-package

# 5. 验证
echo "Linting chart..."
make helm-lint

# 6. 发布 Chart（示例：GitHub Releases）
echo "Creating GitHub release..."
gh release create v${VERSION} \
  charts/novasphere/novasphere-${VERSION}.tgz \
  --title "Release v${VERSION}" \
  --notes "Release notes for v${VERSION}"

echo "Release complete: v${VERSION}"
```

## 5. CI/CD 集成

### 5.1 GitHub Actions 完整流程

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-chart:
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      
      - name: Build Chart
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          make helm-package CHART_VERSION=${VERSION} APP_VERSION=${VERSION}
      
      - name: Upload Chart
        uses: actions/upload-artifact@v3
        with:
          name: helm-chart
          path: charts/novasphere/*.tgz

  release:
    runs-on: ubuntu-latest
    needs: [build-image, build-chart]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Chart
        uses: actions/download-artifact@v3
        with:
          name: helm-chart
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            charts/novasphere/*.tgz
          draft: false
          prerelease: false
```

## 6. 使用发布的 Chart

### 6.1 从 GitHub Releases
```bash
# 添加仓库
helm repo add novasphere https://github.com/kuihuar/novasphere/releases/download/charts/

# 安装
helm install novasphere novasphere/novasphere \
  --version 1.0.0 \
  --namespace novasphere-system \
  --create-namespace
```

### 6.2 从 OCI Registry
```bash
# 安装
helm install novasphere oci://myregistry.com/charts/novasphere \
  --version 1.0.0 \
  --namespace novasphere-system \
  --create-namespace
```

## 7. 最佳实践

### 7.1 版本管理
- ✅ 使用语义化版本
- ✅ Chart 版本与 App 版本分离
- ✅ 使用 Git 标签管理版本

### 7.2 构建流程
- ✅ 自动化构建和测试
- ✅ 在 CI/CD 中验证 Chart
- ✅ 使用多阶段构建优化镜像

### 7.3 发布流程
- ✅ 自动化发布流程
- ✅ 发布前进行完整测试
- ✅ 提供清晰的发布说明

### 7.4 文档
- ✅ 维护 Chart README
- ✅ 提供 Values 说明
- ✅ 记录升级路径

