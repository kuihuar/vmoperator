# VM 快照功能规划

## 1. 功能概述

### 1.1 快照功能
创建 VM 磁盘的时间点快照，支持回滚和恢复。

**使用场景**:
- 系统升级前创建快照
- 定期备份
- 快速回滚到之前状态
- 基于快照创建新 VM

### 1.2 快照类型

#### 在线快照（Online Snapshot）
- VM 运行状态下创建快照
- 需要存储后端支持（如 Longhorn、Ceph）
- 对业务影响小

#### 离线快照（Offline Snapshot）
- 停止 VM 后创建快照
- 所有存储后端都支持
- 数据一致性更好

## 2. 当前实现状态

### 2.1 已实现
- ❌ 无快照功能

### 2.2 待实现
- ❌ 创建快照
- ❌ 恢复快照
- ❌ 删除快照
- ❌ 快照列表查询
- ❌ 基于快照创建 VM

## 3. 技术实现

### 3.1 KubeVirt 原生支持

KubeVirt 提供 `VirtualMachineSnapshot` API：

```yaml
apiVersion: snapshot.kubevirt.io/v1alpha1
kind: VirtualMachineSnapshot
metadata:
  name: vm-snapshot
spec:
  source:
    apiGroup: kubevirt.io
    kind: VirtualMachine
    name: my-vm
```

### 3.2 实现方案

#### 方案一：使用 VirtualMachineSnapshot
```go
// pkg/kubevirt/snapshot.go
func CreateSnapshot(ctx context.Context, c client.Client, vmName, snapshotName, namespace string) error {
    snapshot := &snapshotv1alpha1.VirtualMachineSnapshot{
        ObjectMeta: metav1.ObjectMeta{
            Name:      snapshotName,
            Namespace:  namespace,
        },
        Spec: snapshotv1alpha1.VirtualMachineSnapshotSpec{
            Source: corev1.TypedLocalObjectReference{
                APIGroup: &apiGroup,
                Kind:     "VirtualMachine",
                Name:     vmName,
            },
        },
    }
    return c.Create(ctx, snapshot)
}
```

#### 方案二：使用存储后端快照
```go
// pkg/storage/snapshot.go
func CreateStorageSnapshot(ctx context.Context, c client.Client, pvcName, snapshotName, namespace string) error {
    // 使用 VolumeSnapshot API（CSI）
    snapshot := &snapshotv1.VolumeSnapshot{
        ObjectMeta: metav1.ObjectMeta{
            Name:      snapshotName,
            Namespace:  namespace,
        },
        Spec: snapshotv1.VolumeSnapshotSpec{
            Source: snapshotv1.VolumeSnapshotSource{
                PersistentVolumeClaimName: &pvcName,
            },
        },
    }
    return c.Create(ctx, snapshot)
}
```

## 4. API 设计

### 4.1 WukongSpec 扩展

```go
// api/v1alpha1/wukong_types.go

type WukongSpec struct {
    // ... 现有字段 ...
    
    // SnapshotPolicy 快照策略（可选）
    // +optional
    SnapshotPolicy *SnapshotPolicySpec `json:"snapshotPolicy,omitempty"`
}

type SnapshotPolicySpec struct {
    // Enabled 是否启用自动快照
    Enabled bool `json:"enabled"`
    
    // Schedule Cron 表达式，定义快照频率
    // +optional
    Schedule string `json:"schedule,omitempty"`
    
    // Retention 保留策略
    // +optional
    Retention *RetentionPolicy `json:"retention,omitempty"`
}

type RetentionPolicy struct {
    // MaxCount 最大保留数量
    // +optional
    MaxCount *int `json:"maxCount,omitempty"`
    
    // MaxAge 最大保留时间（如 "7d", "30d"）
    // +optional
    MaxAge string `json:"maxAge,omitempty"`
}
```

### 4.2 快照操作 API

```go
// api/v1alpha1/wukong_types.go

// WukongSnapshot 快照操作资源
type WukongSnapshot struct {
    metav1.TypeMeta   `json:",inline"`
    metav1.ObjectMeta `json:"metadata,omitempty"`
    
    Spec   WukongSnapshotSpec   `json:"spec,omitempty"`
    Status WukongSnapshotStatus `json:"status,omitempty"`
}

type WukongSnapshotSpec struct {
    // WukongName 要创建快照的 Wukong 名称
    WukongName string `json:"wukongName"`
    
    // Operation 操作类型: create, restore, delete
    Operation string `json:"operation"`
    
    // SnapshotName 快照名称（用于 restore/delete）
    // +optional
    SnapshotName string `json:"snapshotName,omitempty"`
}

type WukongSnapshotStatus struct {
    Phase     string `json:"phase"`     // Pending, Creating, Ready, Failed
    Message   string `json:"message,omitempty"`
    CreatedAt metav1.Time `json:"createdAt,omitempty"`
}
```

### 4.3 Status 扩展

```go
// api/v1alpha1/wukong_types.go

type WukongStatus struct {
    // ... 现有字段 ...
    
    // Snapshots 快照列表
    // +optional
    Snapshots []SnapshotInfo `json:"snapshots,omitempty"`
}

type SnapshotInfo struct {
    Name      string      `json:"name"`
    Phase     string      `json:"phase"`
    CreatedAt metav1.Time `json:"createdAt"`
    Size      string      `json:"size,omitempty"`
}
```

## 5. 实现步骤

### 5.1 第一阶段：基础快照
1. 支持创建快照
2. 支持恢复快照
3. 支持删除快照
4. 快照列表查询

### 5.2 第二阶段：自动快照
1. 实现定时快照（Cron）
2. 实现保留策略
3. 快照清理

### 5.3 第三阶段：高级特性
1. 支持在线快照
2. 支持增量快照
3. 基于快照创建 VM

## 6. 使用示例

### 6.1 手动创建快照
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: WukongSnapshot
metadata:
  name: vm-snapshot-1
spec:
  wukongName: my-vm
  operation: create
```

### 6.2 恢复快照
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: WukongSnapshot
metadata:
  name: restore-snapshot
spec:
  wukongName: my-vm
  operation: restore
  snapshotName: vm-snapshot-1
```

### 6.3 自动快照策略
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  cpu: 2
  memory: 4Gi
  snapshotPolicy:
    enabled: true
    schedule: "0 2 * * *"  # 每天凌晨 2 点
    retention:
      maxCount: 7           # 保留最近 7 个快照
      maxAge: "30d"         # 或保留 30 天
```

### 6.4 基于快照创建 VM
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: vm-from-snapshot
spec:
  cpu: 2
  memory: 4Gi
  cloneSource:
    type: snapshot
    snapshotName: vm-snapshot-1
    namespace: default
  disks:
  - name: system
    size: 20Gi
```

## 7. Controller 实现

```go
// internal/controller/wukong_snapshot_controller.go

func (r *WukongSnapshotReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
    snapshot := &vmv1alpha1.WukongSnapshot{}
    if err := r.Get(ctx, req.NamespacedName, snapshot); err != nil {
        return ctrl.Result{}, client.IgnoreNotFound(err)
    }
    
    switch snapshot.Spec.Operation {
    case "create":
        return r.createSnapshot(ctx, snapshot)
    case "restore":
        return r.restoreSnapshot(ctx, snapshot)
    case "delete":
        return r.deleteSnapshot(ctx, snapshot)
    default:
        return ctrl.Result{}, fmt.Errorf("unknown operation: %s", snapshot.Spec.Operation)
    }
}

func (r *WukongSnapshotReconciler) createSnapshot(ctx context.Context, snapshot *vmv1alpha1.WukongSnapshot) error {
    // 1. 获取 Wukong
    // 2. 获取对应的 VirtualMachine
    // 3. 创建 VirtualMachineSnapshot
    // 4. 监控快照进度
    // 5. 更新状态
}
```

## 8. 注意事项

### 8.1 存储后端支持
- 需要存储后端支持快照（Longhorn、Ceph 等）
- 检查 VolumeSnapshotClass 配置
- 验证存储驱动支持

### 8.2 性能影响
- 在线快照可能影响 VM 性能
- 大磁盘快照耗时较长
- 考虑在低峰期创建快照

### 8.3 存储空间
- 快照占用存储空间
- 实现保留策略避免空间耗尽
- 定期清理旧快照

## 9. 面试要点

### 9.1 在线快照和离线快照的区别？

**答案**:
- **在线快照**: VM 运行中创建，需要存储后端支持，对业务影响小
- **离线快照**: 停止 VM 后创建，所有存储都支持，数据一致性更好

### 9.2 如何实现快照的保留策略？

**答案**:
- 使用 CronJob 定期清理
- 根据创建时间和数量删除旧快照
- 实现快照生命周期管理
- 支持手动保留重要快照

### 9.3 快照恢复时需要注意什么？

**答案**:
- 恢复会覆盖当前数据，需要确认
- 建议在恢复前创建当前状态快照
- 恢复后需要重启 VM
- 检查存储空间是否足够

