# Values 配置说明

## 1. 默认 Values.yaml 结构

```yaml
# 全局配置
global:
  namespace: novasphere-system

# 镜像配置
image:
  repository: controller
  tag: latest
  pullPolicy: IfNotPresent

# 命名空间
namespace:
  create: true
  name: novasphere-system

# Manager 配置
manager:
  replicas: 1
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi
  livenessProbe:
    initialDelaySeconds: 15
    periodSeconds: 20
  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 10
  terminationGracePeriodSeconds: 10

# Webhook 配置
webhook:
  enabled: true
  # cert-manager 管理证书
  certManager:
    enabled: false
  # 自签名证书（默认）
  selfSigned:
    enabled: true

# Metrics 配置
metrics:
  enabled: true
  service:
    type: ClusterIP
    port: 8443

# CRD 配置
crd:
  install: true

# RBAC 配置
rbac:
  create: true
  # Wukong 管理角色
  wukongRoles:
    enabled: true
    admin: true
    editor: true
    viewer: true

# 节点选择器
nodeSelector: {}

# 容忍度
tolerations: []

# 亲和性
affinity: {}

# 安全上下文
securityContext:
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault
```

## 2. 配置项详解

### 2.1 镜像配置
```yaml
image:
  repository: myregistry/novasphere  # 镜像仓库
  tag: v1.0.0                        # 镜像标签
  pullPolicy: IfNotPresent           # 拉取策略
```

**使用示例**:
```bash
helm install novasphere ./charts/novasphere \
  --set image.repository=myregistry/novasphere \
  --set image.tag=v1.0.0
```

### 2.2 Manager 配置
```yaml
manager:
  replicas: 1                        # 副本数（通常为 1，使用 leader election）
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi
```

### 2.3 Webhook 配置
```yaml
webhook:
  enabled: true                      # 是否启用 Webhook
  certManager:
    enabled: false                    # 使用 cert-manager 管理证书
  selfSigned:
    enabled: true                     # 使用自签名证书（默认）
```

**开发环境禁用 Webhook**:
```yaml
webhook:
  enabled: false
```

### 2.4 Metrics 配置
```yaml
metrics:
  enabled: true                       # 是否启用 Metrics
  service:
    type: ClusterIP                  # Service 类型
    port: 8443                        # 端口
```

### 2.5 RBAC 配置
```yaml
rbac:
  create: true                       # 是否创建 RBAC 资源
  wukongRoles:
    enabled: true                     # 是否创建 Wukong 管理角色
    admin: true                       # Admin 角色
    editor: true                      # Editor 角色
    viewer: true                      # Viewer 角色
```

## 3. 环境特定 Values

### 3.1 开发环境 (values-dev.yaml)
```yaml
# 继承默认配置
image:
  repository: controller
  tag: latest

# 开发环境特定配置
webhook:
  enabled: false                     # 禁用 Webhook

manager:
  resources:
    limits:
      cpu: 200m
      memory: 64Mi
    requests:
      cpu: 10m
      memory: 32Mi

metrics:
  enabled: false                     # 可选：禁用 Metrics
```

### 3.2 生产环境 (values-prod.yaml)
```yaml
# 生产环境配置
image:
  repository: myregistry/novasphere
  tag: v1.0.0
  pullPolicy: Always

webhook:
  enabled: true
  certManager:
    enabled: true                     # 使用 cert-manager

manager:
  replicas: 2                        # 高可用（虽然使用 leader election，但可以多副本）
  resources:
    limits:
      cpu: 1000m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

metrics:
  enabled: true

# 节点选择器（示例）
nodeSelector:
  node-type: compute

# 容忍度（示例）
tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "novasphere"
    effect: "NoSchedule"
```

## 4. 使用示例

### 4.1 开发环境部署
```bash
helm install novasphere ./charts/novasphere \
  -f charts/novasphere/values-dev.yaml \
  --namespace novasphere-system \
  --create-namespace
```

### 4.2 生产环境部署
```bash
helm install novasphere ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml \
  --namespace novasphere-system \
  --create-namespace \
  --set image.repository=myregistry/novasphere \
  --set image.tag=v1.0.0
```

### 4.3 自定义配置
```bash
helm install novasphere ./charts/novasphere \
  --namespace novasphere-system \
  --create-namespace \
  --set image.repository=myregistry/novasphere \
  --set image.tag=v1.0.0 \
  --set webhook.enabled=false \
  --set manager.resources.limits.cpu=1000m
```

### 4.4 升级部署
```bash
helm upgrade novasphere ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml \
  --set image.tag=v1.1.0
```

### 4.5 回滚
```bash
helm rollback novasphere
# 或回滚到指定版本
helm rollback novasphere 1
```

## 5. 配置验证

### 5.1 模板渲染测试
```bash
# 渲染模板（不部署）
helm template novasphere ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml

# 验证 Values
helm lint ./charts/novasphere \
  -f charts/novasphere/values-prod.yaml
```

### 5.2 干运行
```bash
helm install novasphere ./charts/novasphere \
  --dry-run --debug \
  -f charts/novasphere/values-prod.yaml
```

## 6. 配置最佳实践

### 6.1 敏感信息
- 使用 Kubernetes Secrets
- 通过 `--set-file` 或外部 Values 文件传递
- 避免在 Values 文件中硬编码

### 6.2 环境隔离
- 为每个环境创建独立的 Values 文件
- 使用命名空间隔离
- 生产环境使用 `pullPolicy: Always`

### 6.3 资源限制
- 根据实际负载调整资源限制
- 开发环境可以降低资源要求
- 生产环境预留足够资源

### 6.4 高可用
- Manager 使用 leader election，单副本即可
- 如需高可用，可配置多副本
- 考虑节点分布

