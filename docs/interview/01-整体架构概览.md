# 整体架构概览

## 1. 项目定位

VM Operator 是一个基于 Kubernetes Operator 模式的虚拟机管理平台，通过自定义 CRD（Custom Resource Definition）提供统一的虚拟机创建、配置和管理接口。

### 核心价值
- **简化操作**: 通过声明式 API 管理虚拟机，无需直接操作 KubeVirt
- **统一抽象**: 将网络、存储、计算资源统一抽象为一个 CRD
- **自动化**: 自动处理资源创建、状态同步、生命周期管理

## 2. 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                   用户/API 层                            │
│              kubectl apply -f wukong.yaml                │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              Kubernetes API Server                      │
│              Wukong CRD (vm.novasphere.dev)             │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            WukongReconciler (Controller)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Network    │  │   Storage    │  │  KubeVirt    │ │
│  │   Manager    │  │   Manager    │  │   Manager    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└────┬──────────────┬──────────────┬──────────────────────┘
     │              │              │
     ▼              ▼              ▼
┌─────────┐  ┌──────────┐  ┌─────────────┐
│ Multus  │  │ Longhorn │  │  KubeVirt   │
│   CNI   │  │ Storage  │  │   Virtual   │
│         │  │          │  │  Machine    │
└─────────┘  └──────────┘  └─────────────┘
```

## 3. 技术栈

### 3.1 核心组件

| 组件 | 版本 | 作用 |
|------|------|------|
| **k3s** | >= 1.24 | 轻量级 Kubernetes 发行版 |
| **KubeVirt** | >= 0.58 | 在 Kubernetes 上运行虚拟机的 Operator |
| **CDI** | >= 1.57 | 容器化数据导入工具，用于从镜像创建磁盘 |
| **Multus CNI** | >= 3.9 | 多网络接口支持 |
| **NMState Operator** | >= 0.73 | 节点网络配置管理 |
| **Longhorn** | >= 1.8.1 | 分布式块存储系统 |

### 3.2 项目依赖

- **Kubebuilder**: Operator 框架
- **Controller Runtime**: Controller 运行时库
- **Go**: 1.19+

## 4. 核心概念

### 4.1 Wukong CRD

`Wukong` 是项目的核心 CRD，代表一个虚拟机配置：

```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: web-server-01
spec:
  cpu: 4
  memory: 8Gi
  networks:
    - name: mgmt
      type: bridge
      vlanId: 100
      ipConfig:
        mode: static
        address: 192.168.100.10/24
  disks:
    - name: system
      size: 80Gi
      storageClassName: longhorn
      boot: true
```

### 4.2 状态管理

Wukong 使用 `Phase` 和 `Conditions` 管理状态：

- **Phase**: `Pending` → `Creating` → `Running` / `Stopped` / `Error`
- **Conditions**: 
  - `Ready`: VM 是否就绪
  - `NetworksConfigured`: 网络是否配置完成
  - `VolumesBound`: 存储卷是否绑定

### 4.3 资源关系

```
Wukong (Owner)
├── NetworkAttachmentDefinition (Multus)
├── PersistentVolumeClaim / DataVolume (Storage)
└── VirtualMachine (KubeVirt)
    └── VirtualMachineInstance (Running VM)
```

## 5. 工作流程

### 5.1 创建流程

```
1. 用户创建 Wukong CRD
   ↓
2. Controller 监听到事件，开始 Reconcile
   ↓
3. 验证 Spec，添加 Finalizer
   ↓
4. 处理网络配置 (Multus)
   ├── 创建 NetworkAttachmentDefinition
   └── 更新网络状态
   ↓
5. 处理存储配置 (Longhorn/CDI)
   ├── 创建 PVC 或 DataVolume
   └── 等待卷绑定
   ↓
6. 创建 KubeVirt VirtualMachine
   ├── 构建 VM Spec
   ├── 配置 Cloud-Init
   └── 设置网络和存储
   ↓
7. 同步状态
   ├── 从 VMI 获取运行状态
   ├── 更新 Wukong Status
   └── 更新 Conditions
```

### 5.2 删除流程

```
1. 用户删除 Wukong CRD
   ↓
2. Controller 检测到 DeletionTimestamp
   ↓
3. 执行清理逻辑
   ├── 删除 VirtualMachine (通过 OwnerReference)
   ├── 删除 PVC/DataVolume (通过 OwnerReference)
   └── 清理 NetworkAttachmentDefinition
   ↓
4. 移除 Finalizer
   ↓
5. 资源完全删除
```

## 6. 项目结构

```
vmoperator/
├── api/v1alpha1/          # CRD 定义
│   └── wukong_types.go    # Wukong CRD 结构
├── internal/controller/   # Controller 实现
│   └── wukong_controller.go
├── pkg/                   # 功能模块
│   ├── kubevirt/         # KubeVirt 集成
│   ├── network/          # 网络管理 (Multus)
│   └── storage/          # 存储管理 (Longhorn/CDI)
├── config/                # 部署配置
│   ├── crd/              # CRD 定义文件
│   ├── rbac/             # RBAC 配置
│   └── manager/          # Manager 部署
└── docs/                  # 文档
```

## 7. 设计原则

1. **声明式管理**: 用户只需声明期望状态，Controller 负责实现
2. **模块化设计**: 网络、存储、计算资源分离，便于维护和扩展
3. **状态驱动**: 通过 Reconcile 循环持续同步状态
4. **错误恢复**: 支持重试和错误恢复机制
5. **资源清理**: 使用 Finalizer 确保资源正确清理

## 8. 关键特性

### 8.1 多网络支持
- 支持多个网络接口（管理网、业务网等）
- 支持 VLAN、桥接、SR-IOV 等多种网络类型
- 支持静态 IP 和 DHCP

### 8.2 灵活存储
- 支持多种 StorageClass（Longhorn、Ceph 等）
- 支持从容器镜像创建磁盘（DataVolume）
- 支持磁盘扩展

### 8.3 自动化配置
- Cloud-Init 自动配置用户、SSH 密钥、网络
- 支持自定义用户数据

### 8.4 高可用
- 支持节点选择器、容忍度
- 支持反亲和性策略
- 支持重启策略

## 9. 适用场景

- **私有云平台**: 在 Kubernetes 集群上提供虚拟机服务
- **混合云管理**: 统一管理容器和虚拟机工作负载
- **开发测试环境**: 快速创建和销毁虚拟机
- **边缘计算**: 在边缘节点运行虚拟机

## 10. 技术亮点

1. **Operator 模式**: 遵循 Kubernetes Operator 最佳实践
2. **多技术栈集成**: 整合 KubeVirt、Multus、Longhorn 等多个项目
3. **状态管理**: 完善的状态同步和条件判断机制
4. **错误处理**: 优雅的错误处理和重试机制
5. **可扩展性**: 模块化设计，易于扩展新功能

