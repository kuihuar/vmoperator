# 依赖关系与部署顺序

## 1. 技术栈依赖关系图

```
k3s (Kubernetes 基础)
    │
    ├── KubeVirt (虚拟机管理)
    │   │
    │   └── CDI (数据导入)
    │       │
    │       └── Novasphere Operator
    │
    ├── Multus CNI (多网络)
    │   │
    │   └── Novasphere Operator
    │
    ├── NMState Operator (网络配置)
    │   │
    │   └── Novasphere Operator
    │
    ├── Longhorn (存储)
    │   │
    │   └── Novasphere Operator
    │
    └── cert-manager (证书管理，可选)
        │
        └── Novasphere Operator (Webhook)
```

## 2. 部署顺序

### 2.1 阶段 1: 基础平台
```bash
# 1. k3s (通过脚本安装)
./docs/installation/install-k3s-only.sh

# 验证
kubectl get nodes
```

### 2.2 阶段 2: 存储和网络
```bash
# 2. Longhorn (存储)
helm install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace \
  --version 1.8.1 \
  --set persistence.defaultDataPath=/data/longhorn

# 3. Multus CNI (多网络)
helm install multus ./charts/multus \
  --namespace kube-system

# 4. NMState Operator (网络配置)
helm install nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --create-namespace \
  --version 0.73.0
```

### 2.3 阶段 3: 虚拟化平台
```bash
# 5. KubeVirt (虚拟机管理)
helm install kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --create-namespace \
  --version 1.0.0

# 6. CDI (数据导入)
helm install cdi kubevirt/cdi \
  --namespace cdi-system \
  --create-namespace \
  --version 1.57.0 \
  --set config.dataVolume.defaultStorageClass=longhorn
```

### 2.4 阶段 4: 应用层（可选）
```bash
# 7. cert-manager (证书管理，可选)
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.13.0 \
  --set installCRDs=true
```

### 2.5 阶段 5: 业务应用
```bash
# 8. Novasphere Operator
helm install novasphere ./charts/novasphere \
  --namespace novasphere-system \
  --create-namespace \
  --set image.repository=myregistry/novasphere \
  --set image.tag=v1.0.0
```

## 3. 依赖检查清单

### 3.1 KubeVirt 依赖
- [ ] Kubernetes 集群运行正常
- [ ] 节点资源充足（CPU、内存）
- [ ] 存储类可用（Longhorn）

### 3.2 CDI 依赖
- [ ] KubeVirt 已安装
- [ ] 存储类配置正确
- [ ] 网络连通性正常（用于镜像下载）

### 3.3 Multus 依赖
- [ ] k3s CNI 配置正确
- [ ] 节点网络接口可用
- [ ] CNI 配置目录可写

### 3.4 NMState 依赖
- [ ] 节点具有网络配置权限
- [ ] 节点选择器配置正确

### 3.5 Longhorn 依赖
- [ ] 节点有足够存储空间
- [ ] 数据路径配置正确
- [ ] 节点标签配置（如需要）

### 3.6 cert-manager 依赖
- [ ] 集群 DNS 正常
- [ ] 网络连通性（用于 ACME）

## 4. 验证脚本

### 4.1 检查所有依赖
```bash
#!/bin/bash
# scripts/check-dependencies.sh

echo "检查技术栈依赖..."

# 检查 k3s
echo "1. 检查 k3s..."
kubectl get nodes || { echo "❌ k3s 未就绪"; exit 1; }
echo "✅ k3s 就绪"

# 检查 Longhorn
echo "2. 检查 Longhorn..."
kubectl get pods -n longhorn-system | grep -q Running || { echo "❌ Longhorn 未就绪"; exit 1; }
kubectl get storageclass longhorn || { echo "❌ Longhorn StorageClass 不存在"; exit 1; }
echo "✅ Longhorn 就绪"

# 检查 Multus
echo "3. 检查 Multus..."
kubectl get daemonset -n kube-system | grep -q multus || { echo "❌ Multus 未就绪"; exit 1; }
echo "✅ Multus 就绪"

# 检查 NMState
echo "4. 检查 NMState..."
kubectl get pods -n nmstate-system | grep -q Running || { echo "❌ NMState 未就绪"; exit 1; }
echo "✅ NMState 就绪"

# 检查 KubeVirt
echo "5. 检查 KubeVirt..."
kubectl get pods -n kubevirt-system | grep -q Running || { echo "❌ KubeVirt 未就绪"; exit 1; }
kubectl get crd virtualmachines.kubevirt.io || { echo "❌ KubeVirt CRD 不存在"; exit 1; }
echo "✅ KubeVirt 就绪"

# 检查 CDI
echo "6. 检查 CDI..."
kubectl get pods -n cdi-system | grep -q Running || { echo "❌ CDI 未就绪"; exit 1; }
kubectl get crd datavolumes.cdi.kubevirt.io || { echo "❌ CDI CRD 不存在"; exit 1; }
echo "✅ CDI 就绪"

# 检查 cert-manager (可选)
if kubectl get namespace cert-manager &>/dev/null; then
  echo "7. 检查 cert-manager..."
  kubectl get pods -n cert-manager | grep -q Running || { echo "⚠️  cert-manager 未就绪（可选）"; }
  echo "✅ cert-manager 就绪"
fi

echo "✅ 所有依赖检查完成"
```

## 5. 统一部署脚本

### 5.1 自动化部署
```bash
#!/bin/bash
# scripts/deploy-stack.sh

set -e

echo "开始部署技术栈..."

# 阶段 2: 存储和网络
echo "部署 Longhorn..."
helm upgrade --install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace \
  --version 1.8.1 \
  --wait

echo "部署 Multus..."
helm upgrade --install multus ./charts/multus \
  --namespace kube-system \
  --wait

echo "部署 NMState..."
helm upgrade --install nmstate nmstate/nmstate-operator \
  --namespace nmstate-system \
  --create-namespace \
  --version 0.73.0 \
  --wait

# 阶段 3: 虚拟化平台
echo "部署 KubeVirt..."
helm upgrade --install kubevirt kubevirt/kubevirt \
  --namespace kubevirt-system \
  --create-namespace \
  --version 1.0.0 \
  --wait

echo "部署 CDI..."
helm upgrade --install cdi kubevirt/cdi \
  --namespace cdi-system \
  --create-namespace \
  --version 1.57.0 \
  --set config.dataVolume.defaultStorageClass=longhorn \
  --wait

# 阶段 4: 应用层（可选）
if [ "$ENABLE_CERT_MANAGER" = "true" ]; then
  echo "部署 cert-manager..."
  helm upgrade --install cert-manager jetstack/cert-manager \
    --namespace cert-manager \
    --create-namespace \
    --version v1.13.0 \
    --set installCRDs=true \
    --wait
fi

echo "✅ 技术栈部署完成"
```

## 6. 回滚策略

### 6.1 按阶段回滚
```bash
# 回滚 Novasphere Operator
helm rollback novasphere

# 回滚 CDI
helm rollback cdi

# 回滚 KubeVirt
helm rollback kubevirt
```

### 6.2 完整回滚
```bash
# 回滚所有组件到指定版本
helm rollback longhorn 1
helm rollback kubevirt 1
helm rollback cdi 1
```

## 7. 版本兼容性

### 7.1 推荐版本组合
| 组件 | 版本 | 备注 |
|------|------|------|
| k3s | latest | 1.24+ |
| KubeVirt | 1.0.0 | 稳定版 |
| CDI | 1.57.0 | 与 KubeVirt 1.0 兼容 |
| Multus | 4.0.0 | 最新稳定版 |
| NMState | 0.73.0 | 最新稳定版 |
| Longhorn | 1.8.1 | 项目使用版本 |
| cert-manager | 1.13.0 | 最新稳定版 |

### 7.2 测试矩阵
- KubeVirt 1.0.0 + CDI 1.57.0 ✅
- KubeVirt 1.0.0 + CDI 1.58.0 ✅
- Multus 4.0.0 + k3s 1.24+ ✅
- Longhorn 1.8.1 + k3s 1.24+ ✅

