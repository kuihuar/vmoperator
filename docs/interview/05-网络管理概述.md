# 网络管理概述

## 1. 网络架构

VM Operator 使用 **Multus CNI** 实现多网络接口支持，允许虚拟机同时连接多个网络。

### 1.1 网络组件

```
Wukong Spec
    ↓
NetworkConfig (用户定义)
    ↓
NetworkAttachmentDefinition (Multus)
    ↓
KubeVirt VM (网络接口)
    ↓
VirtualMachineInstance (运行中的 VM)
```

### 1.2 支持的网络类型

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| `bridge` | Linux 桥接 | 最常用，支持 VLAN |
| `macvlan` | MACVLAN | 直接访问物理网络 |
| `sriov` | SR-IOV | 高性能网络 |
| `ovs` | Open vSwitch | OVS 环境 |

## 2. 网络配置流程

### 2.1 配置步骤

```
1. 用户定义 NetworkConfig
   ↓
2. Controller 调用 network.ReconcileNetworks()
   ↓
3. 检查/创建 NetworkAttachmentDefinition
   ↓
4. 返回 NetworkStatus
   ↓
5. 在 KubeVirt VM 中配置网络接口
```

### 2.2 关键代码位置

- **网络协调**: `pkg/network/multus.go` - `ReconcileNetworks()`
- **CNI 配置构建**: `pkg/network/multus.go` - `buildCNIConfig()`
- **VM 网络配置**: `pkg/kubevirt/vm.go` - `buildNetworks()`, `buildInterfaces()`

## 3. NetworkAttachmentDefinition (NAD)

### 3.1 NAD 的作用

- **定义网络接口**: 指定网络类型、VLAN、IP 配置等
- **Multus 使用**: Multus CNI 根据 NAD 创建网络接口
- **自动创建**: 如果用户未指定 `nadName`，Controller 会自动创建

### 3.2 NAD 命名规则

```go
// 如果用户指定了 nadName，直接使用
nadName := netCfg.NADName

// 如果未指定，自动生成
if nadName == "" {
    nadName = fmt.Sprintf("%s-%s-nad", vmp.Name, netCfg.Name)
}
```

## 4. 网络状态同步

### 4.1 NetworkStatus

```go
type NetworkStatus struct {
    Name      string `json:"name"`       // 网络名称
    Interface string `json:"interface,omitempty"`  // VM 中的接口名
    IPAddress string `json:"ipAddress,omitempty"`  // IP 地址
    MACAddress string `json:"macAddress,omitempty"` // MAC 地址
    NADName   string `json:"nadName,omitempty"`    // 使用的 NAD 名称
}
```

### 4.2 状态更新时机

- **创建时**: 记录 NAD 名称
- **运行后**: 从 VMI 获取实际的 IP、MAC 地址（待实现）

## 5. IP 配置方式

### 5.1 Static 模式

```yaml
ipConfig:
  mode: static
  address: 192.168.100.10/24
  gateway: 192.168.100.1
  dnsServers:
    - 8.8.8.8
```

### 5.2 DHCP 模式

```yaml
ipConfig:
  mode: dhcp
```

## 6. 多网络示例

```yaml
spec:
  networks:
    - name: mgmt
      type: bridge
      vlanId: 100
      ipConfig:
        mode: static
        address: 192.168.100.10/24
    - name: data
      type: bridge
      ipConfig:
        mode: dhcp
```

## 7. 面试要点

### 7.1 为什么需要 Multus？

**答案**:
- Kubernetes 默认每个 Pod 只有一个网络接口
- 虚拟机需要多个网络接口（管理网、业务网等）
- Multus 允许 Pod/VM 连接多个网络

### 7.2 NAD 的创建时机？

**答案**:
- 如果用户指定了 `nadName`，直接使用现有的 NAD
- 如果未指定，Controller 自动创建 NAD
- NAD 名称格式: `{wukong-name}-{network-name}-nad`

### 7.3 网络配置的顺序？

**答案**:
1. 先创建 NetworkAttachmentDefinition
2. 再创建 KubeVirt VirtualMachine
3. VM 启动时，Multus 根据 NAD 创建网络接口

