# 删除功能

## 1. 功能概述

### 1.1 删除功能
删除 VM 及其相关资源，包括磁盘、网络配置等。

**使用场景**:
- 清理不需要的 VM
- 资源回收
- 环境重置
- 测试后清理

### 1.2 删除类型

#### 普通删除
- 删除 Wukong CR
- 通过 Finalizer 清理资源
- 保留数据（可选）

#### 强制删除
- 立即删除，忽略 Finalizer
- 可能遗留资源
- 需要手动清理

## 2. 当前实现状态

### 2.1 已实现
- ✅ **Finalizer 机制**: 通过 Finalizer 确保资源清理
- ✅ **资源清理**: 删除 VirtualMachine、PVC、DataVolume 等

### 2.2 待完善
- ⚠️ **删除选项**: 是否保留数据盘
- ⚠️ **删除确认**: 防止误删除
- ⚠️ **删除进度**: 显示删除进度
- ⚠️ **级联删除**: 删除相关资源

## 3. 技术实现

### 3.1 Finalizer 机制

```go
// internal/controller/wukong_controller.go

const (
    finalizerName = "wukong.novasphere.dev/finalizer"
)

func (r *WukongReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
    vmp := &vmv1alpha1.Wukong{}
    if err := r.Get(ctx, req.NamespacedName, vmp); err != nil {
        return ctrl.Result{}, client.IgnoreNotFound(err)
    }
    
    // 检查是否正在删除
    if !vmp.ObjectMeta.DeletionTimestamp.IsZero() {
        // 执行清理逻辑
        return r.finalize(ctx, vmp)
    }
    
    // 添加 Finalizer
    if !controllerutil.ContainsFinalizer(vmp, finalizerName) {
        controllerutil.AddFinalizer(vmp, finalizerName)
        if err := r.Update(ctx, vmp); err != nil {
            return ctrl.Result{}, err
        }
    }
    
    // 正常 Reconcile 逻辑
    // ...
}

func (r *WukongReconciler) finalize(ctx context.Context, vmp *vmv1alpha1.Wukong) (ctrl.Result, error) {
    logger := log.FromContext(ctx)
    
    // 1. 删除 VirtualMachine
    vmName := fmt.Sprintf("%s-vm", vmp.Name)
    if err := r.deleteVirtualMachine(ctx, vmName, vmp.Namespace); err != nil {
        return ctrl.Result{}, err
    }
    
    // 2. 删除 PVC/DataVolume（根据配置决定是否保留）
    if !vmp.Spec.PreserveDisksOnDelete {
        if err := r.deleteDisks(ctx, vmp); err != nil {
            return ctrl.Result{}, err
        }
    }
    
    // 3. 清理网络资源（如果需要）
    if err := r.cleanupNetworks(ctx, vmp); err != nil {
        return ctrl.Result{}, err
    }
    
    // 4. 移除 Finalizer
    controllerutil.RemoveFinalizer(vmp, finalizerName)
    if err := r.Update(ctx, vmp); err != nil {
        return ctrl.Result{}, err
    }
    
    logger.Info("Wukong finalized", "name", vmp.Name)
    return ctrl.Result{}, nil
}
```

### 3.2 删除选项

```go
// api/v1alpha1/wukong_types.go

type WukongSpec struct {
    // ... 现有字段 ...
    
    // DeleteOptions 删除选项（可选）
    // +optional
    DeleteOptions *DeleteOptionsSpec `json:"deleteOptions,omitempty"`
}

type DeleteOptionsSpec struct {
    // PreserveDisks 是否保留磁盘
    // +optional
    PreserveDisks bool `json:"preserveDisks,omitempty"`
    
    // PreserveDisksList 保留的磁盘列表（如果 PreserveDisks 为 false）
    // +optional
    PreserveDisksList []string `json:"preserveDisksList,omitempty"`
    
    // GracePeriodSeconds 优雅删除等待时间（秒）
    // +optional
    GracePeriodSeconds *int64 `json:"gracePeriodSeconds,omitempty"`
    
    // Force 是否强制删除（忽略 Finalizer）
    // +optional
    Force bool `json:"force,omitempty"`
}
```

### 3.3 删除实现

```go
// internal/controller/wukong_controller.go

func (r *WukongReconciler) deleteVirtualMachine(ctx context.Context, vmName, namespace string) error {
    vm := &kubevirtv1.VirtualMachine{}
    key := client.ObjectKey{Name: vmName, Namespace: namespace}
    if err := r.Get(ctx, key, vm); err != nil {
        if errors.IsNotFound(err) {
            return nil
        }
        return err
    }
    
    // 先停止 VM（如果正在运行）
    if vm.Spec.Running != nil && *vm.Spec.Running {
        running := false
        vm.Spec.Running = &running
        if err := r.Update(ctx, vm); err != nil {
            return fmt.Errorf("failed to stop VM: %w", err)
        }
        
        // 等待 VM 停止
        if err := r.waitForVMStopped(ctx, vmName, namespace, 60*time.Second); err != nil {
            return fmt.Errorf("timeout waiting for VM to stop: %w", err)
        }
    }
    
    // 删除 VirtualMachine
    if err := r.Delete(ctx, vm); err != nil {
        if !errors.IsNotFound(err) {
            return err
        }
    }
    
    return nil
}

func (r *WukongReconciler) deleteDisks(ctx context.Context, vmp *vmv1alpha1.Wukong) error {
    logger := log.FromContext(ctx)
    
    preserveList := make(map[string]bool)
    if vmp.Spec.DeleteOptions != nil {
        if vmp.Spec.DeleteOptions.PreserveDisks {
            // 保留所有磁盘
            return nil
        }
        for _, diskName := range vmp.Spec.DeleteOptions.PreserveDisksList {
            preserveList[diskName] = true
        }
    }
    
    // 删除每个磁盘的 PVC/DataVolume
    for _, vol := range vmp.Status.Volumes {
        if preserveList[vol.Name] {
            logger.Info("Preserving disk", "disk", vol.Name, "pvc", vol.PVCName)
            continue
        }
        
        // 删除 DataVolume（如果存在）
        dv := &cdiv1beta1.DataVolume{}
        key := client.ObjectKey{Name: vol.PVCName, Namespace: vmp.Namespace}
        if err := r.Get(ctx, key, dv); err == nil {
            if err := r.Delete(ctx, dv); err != nil && !errors.IsNotFound(err) {
                logger.Error(err, "failed to delete DataVolume", "dv", vol.PVCName)
            }
        }
        
        // 删除 PVC
        pvc := &corev1.PersistentVolumeClaim{}
        if err := r.Get(ctx, key, pvc); err == nil {
            if err := r.Delete(ctx, pvc); err != nil && !errors.IsNotFound(err) {
                logger.Error(err, "failed to delete PVC", "pvc", vol.PVCName)
            }
        }
    }
    
    return nil
}
```

## 4. API 设计

### 4.1 普通删除
```yaml
# 直接删除，清理所有资源
kubectl delete wukong my-vm
```

### 4.2 保留磁盘删除
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  deleteOptions:
    preserveDisks: true  # 保留所有磁盘
```

### 4.3 选择性保留磁盘
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  deleteOptions:
    preserveDisks: false
    preserveDisksList:
    - data  # 只保留 data 磁盘
```

### 4.4 强制删除
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  deleteOptions:
    force: true  # 强制删除，忽略 Finalizer
```

## 5. 删除流程

```
用户删除 Wukong CR
    ↓
Kubernetes 设置 DeletionTimestamp
    ↓
Controller 检测到删除标记
    ↓
执行清理逻辑：
  1. 停止 VM（如果正在运行）
  2. 删除 VirtualMachine
  3. 删除 PVC/DataVolume（根据配置）
  4. 清理网络资源
    ↓
移除 Finalizer
    ↓
资源完全删除
```

## 6. 注意事项

### 6.1 数据保护
- 默认删除所有磁盘
- 提供选项保留重要数据
- 删除前确认数据备份

### 6.2 删除顺序
- 先停止 VM
- 再删除 VirtualMachine
- 最后删除存储资源
- 避免资源依赖问题

### 6.3 删除超时
- 设置合理的超时时间
- 处理删除卡住的情况
- 提供强制删除选项

### 6.4 级联删除
- 通过 OwnerReference 自动删除
- 处理 Finalizer 阻塞的情况
- 清理孤立资源

## 7. 面试要点

### 7.1 Finalizer 的作用？

**答案**:
- 确保资源在删除前完成清理
- 防止资源泄漏
- 支持优雅删除流程
- 处理依赖关系

### 7.2 如何防止误删除？

**答案**:
- 使用删除确认机制
- 提供删除保护注解
- 实现删除前检查
- 记录删除操作日志

### 7.3 删除失败如何处理？

**答案**:
- 检查资源依赖关系
- 清理 Finalizer 阻塞
- 提供强制删除选项
- 记录错误日志并告警

