# Multus Helm 管理规划

## 1. 概述

Multus CNI 是 Kubernetes 的多网络接口插件，允许 Pod 连接多个网络。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://github.com/k8snetworkplumbingwg/multus-cni`
- **Chart Name**: `multus`
- **安装方式**: 通常通过 DaemonSet 部署

### 2.2 安装方式
```bash
# 方式 1: 使用官方脚本
kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml

# 方式 2: 使用 Helm（如果有官方 Chart）
helm repo add multus https://k8snetworkplumbingwg.github.io/multus-cni
helm install multus multus/multus
```

## 3. 自定义 Helm Chart

由于 Multus 通常通过 DaemonSet 部署，可以创建自定义 Chart：

### 3.1 Chart 结构
```
charts/multus/
├── Chart.yaml
├── values.yaml
└── templates/
    ├── daemonset.yaml
    ├── configmap.yaml
    └── rbac.yaml
```

### 3.2 Values 配置
```yaml
# values-multus.yaml
# Multus 镜像配置
image:
  repository: ghcr.io/k8snetworkplumbingwg/multus-cni
  tag: v4.0.0
  pullPolicy: IfNotPresent

# CNI 配置
cni:
  # CNI 配置目录
  configDir: "/etc/cni/net.d"
  
  # CNI 二进制目录
  binDir: "/opt/cni/bin"
  
  # Multus 配置文件
  configFile: "00-multus.conf"

# 网络配置
network:
  # 默认网络
  defaultNetwork: "bridge"
  
  # 命名空间
  namespace: "kube-system"

# 资源限制
resources:
  limits:
    cpu: 100m
    memory: 50Mi
  requests:
    cpu: 10m
    memory: 10Mi

# 节点选择器
nodeSelector: {}

# 容忍度
tolerations:
  - effect: NoSchedule
    operator: Exists
```

### 3.3 DaemonSet 模板
```yaml
# templates/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-multus-ds
  namespace: {{ .Values.network.namespace }}
spec:
  selector:
    matchLabels:
      app: multus
  template:
    metadata:
      labels:
        app: multus
    spec:
      hostNetwork: true
      tolerations:
        {{- toYaml .Values.tolerations | nindent 8 }}
      containers:
      - name: kube-multus
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        volumeMounts:
        - name: cni
          mountPath: /host/etc/cni/net.d
        - name: cnibin
          mountPath: /host/opt/cni/bin
      volumes:
      - name: cni
        hostPath:
          path: {{ .Values.cni.configDir }}
      - name: cnibin
        hostPath:
          path: {{ .Values.cni.binDir }}
```

## 4. 部署命令

### 4.1 使用自定义 Chart
```bash
helm install multus ./charts/multus \
  --namespace kube-system \
  -f values-multus.yaml
```

### 4.2 验证安装
```bash
# 检查 DaemonSet
kubectl get daemonset -n kube-system | grep multus

# 检查 Pod
kubectl get pods -n kube-system | grep multus

# 检查 CNI 配置
kubectl get configmap -n kube-system | grep multus
```

## 5. k3s 特殊配置

k3s 使用内置 CNI，需要特殊配置：

```yaml
# values-multus-k3s.yaml
cni:
  # k3s CNI 配置目录
  configDir: "/var/lib/rancher/k3s/agent/etc/cni/net.d"
  binDir: "/var/lib/rancher/k3s/data/current/bin"

# 禁用 k3s 默认 CNI（可选）
k3s:
  disableFlannel: false  # 保持 Flannel 作为默认网络
```

## 6. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加：

```yaml
dependencies:
  - name: multus
    version: "4.0.0"
    repository: "file://../multus"
    condition: multus.enabled
```

在 `values.yaml` 中配置：

```yaml
multus:
  enabled: true
  image:
    tag: "v4.0.0"
  cni:
    configDir: "/var/lib/rancher/k3s/agent/etc/cni/net.d"
```

## 7. 注意事项

- Multus 是 DaemonSet，需要在所有节点运行
- k3s 需要特殊配置路径
- 确保 CNI 配置目录可写
- 与 k3s 默认 CNI（Flannel）兼容

