# 静态IP绑定

## 1. 功能概述

### 1.1 静态IP绑定
为 VM 的网络接口绑定固定的 IP 地址，而不是使用 DHCP 动态分配。

**使用场景**:
- 需要固定 IP 地址的服务
- 防火墙规则配置
- 服务发现和注册
- 网络策略配置

### 1.2 实现方式
- **Cloud-Init**: 通过 Cloud-Init 配置网络
- **NMState**: 通过 NMState Operator 配置网络
- **手动配置**: 在 VM 内手动配置（不推荐）

## 2. 当前实现状态

### 2.1 已实现
- ✅ **IPConfig支持**: 通过 `IPConfig` 支持静态 IP 配置
- ✅ **基本配置**: 支持 IP 地址、网关、DNS 配置

### 2.2 待完善
- ⚠️ **IP冲突检测**: 检测 IP 地址是否已被使用
- ⚠️ **IP保留机制**: 确保 IP 地址不被其他 VM 使用
- ⚠️ **配置验证**: 验证 IP 配置有效性
- ⚠️ **状态同步**: 同步实际分配的 IP 地址

## 3. 技术实现

### 3.1 当前实现

```go
// api/v1alpha1/wukong_types.go

type IPConfigSpec struct {
    Mode        string    `json:"mode"`  // static or dhcp
    Address     *string   `json:"address,omitempty"`  // "192.168.1.100/24"
    Gateway     *string   `json:"gateway,omitempty"`
    DNSServers  []string  `json:"dnsServers,omitempty"`
}
```

### 3.2 Cloud-Init 配置

```go
// pkg/kubevirt/cloudinit.go

func buildNetworkConfig(ipConfig *vmv1alpha1.IPConfigSpec, interfaceName string) string {
    if ipConfig.Mode != "static" {
        return ""  // DHCP 不需要额外配置
    }
    
    config := fmt.Sprintf(`
network:
  version: 2
  ethernets:
    %s:
      addresses:
      - %s
`, interfaceName, *ipConfig.Address)
    
    if ipConfig.Gateway != nil {
        config += fmt.Sprintf("      gateway4: %s\n", *ipConfig.Gateway)
    }
    
    if len(ipConfig.DNSServers) > 0 {
        config += "      nameservers:\n"
        config += "        addresses:\n"
        for _, dns := range ipConfig.DNSServers {
            config += fmt.Sprintf("        - %s\n", dns)
        }
    }
    
    return config
}
```

### 3.3 IP 冲突检测

```go
// pkg/network/ip_validation.go

func ValidateIPAddress(ctx context.Context, c client.Client, ipAddress, namespace string) error {
    // 1. 解析 IP 地址
    ip, ipNet, err := net.ParseCIDR(ipAddress)
    if err != nil {
        return fmt.Errorf("invalid IP address format: %w", err)
    }
    
    // 2. 检查是否在其他 VM 中使用
    wukongs := &vmv1alpha1.WukongList{}
    if err := c.List(ctx, wukongs, client.InNamespace(namespace)); err != nil {
        return err
    }
    
    for _, wukong := range wukongs.Items {
        for _, netStatus := range wukong.Status.Networks {
            if netStatus.IPAddress == ip.String() {
                return fmt.Errorf("IP address %s is already used by VM %s", ipAddress, wukong.Name)
            }
        }
    }
    
    // 3. 检查是否在 Kubernetes Service 中使用（可选）
    // 可以通过查询 Service 的 ClusterIP 检查
    
    return nil
}
```

## 4. API 设计扩展

### 4.1 IP 保留机制

```go
// api/v1alpha1/wukong_types.go

type IPConfigSpec struct {
    // ... 现有字段 ...
    
    // Reserved 是否保留 IP 地址（防止被其他 VM 使用）
    // +optional
    Reserved bool `json:"reserved,omitempty"`
    
    // IPPool IP 地址池（可选，用于自动分配）
    // +optional
    IPPool string `json:"ipPool,omitempty"`
}
```

### 4.2 Status 扩展

```go
// api/v1alpha1/wukong_types.go

type NetworkStatus struct {
    // ... 现有字段 ...
    
    // IPAddress 实际分配的 IP 地址
    // +optional
    IPAddress string `json:"ipAddress,omitempty"`
    
    // IPAllocated 是否已分配 IP
    // +optional
    IPAllocated bool `json:"ipAllocated,omitempty"`
    
    // IPAllocatedTime IP 分配时间
    // +optional
    IPAllocatedTime metav1.Time `json:"ipAllocatedTime,omitempty"`
}
```

## 5. Controller 实现

### 5.1 IP 绑定处理

```go
// internal/controller/wukong_controller.go

func (r *WukongReconciler) reconcileIPBinding(ctx context.Context, vmp *vmv1alpha1.Wukong) error {
    logger := log.FromContext(ctx)
    
    for i, net := range vmp.Spec.Networks {
        if net.IPConfig == nil || net.IPConfig.Mode != "static" {
            continue
        }
        
        // 1. 验证 IP 地址格式
        if net.IPConfig.Address == nil {
            return fmt.Errorf("network[%d] %s: static IP requires address", i, net.Name)
        }
        
        // 2. 检查 IP 冲突
        if err := network.ValidateIPAddress(ctx, r.Client, *net.IPConfig.Address, vmp.Namespace); err != nil {
            logger.Error(err, "IP address validation failed", "network", net.Name, "ip", *net.IPConfig.Address)
            return err
        }
        
        // 3. 更新网络状态
        for j := range vmp.Status.Networks {
            if vmp.Status.Networks[j].Name == net.Name {
                vmp.Status.Networks[j].IPAddress = extractIP(*net.IPConfig.Address)
                vmp.Status.Networks[j].IPAllocated = true
                vmp.Status.Networks[j].IPAllocatedTime = metav1.Now()
                break
            }
        }
    }
    
    return r.Status().Update(ctx, vmp)
}

func extractIP(cidr string) string {
    ip, _, _ := net.ParseCIDR(cidr)
    return ip.String()
}
```

## 6. 使用示例

### 6.1 基本静态IP配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: static-ip-vm
spec:
  cpu: 2
  memory: 4Gi
  networks:
  - name: eth0
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.100/24"
      gateway: "192.168.1.1"
      dnsServers:
      - "8.8.8.8"
      - "8.8.4.4"
```

### 6.2 多网卡静态IP配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: multi-static-ip-vm
spec:
  networks:
  - name: eth0
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.100/24"
      gateway: "192.168.1.1"
  - name: eth1
    type: macvlan
    ipConfig:
      mode: static
      address: "10.0.1.100/24"
      gateway: "10.0.1.1"
```

### 6.3 带IP保留的配置
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: reserved-ip-vm
spec:
  networks:
  - name: eth0
    type: bridge
    ipConfig:
      mode: static
      address: "192.168.1.100/24"
      gateway: "192.168.1.1"
      reserved: true  # 保留 IP，防止被其他 VM 使用
```

## 7. 注意事项

### 7.1 IP 冲突
- 需要检测 IP 地址是否已被使用
- 提供 IP 地址池管理
- 支持 IP 地址保留机制
- 记录 IP 分配历史

### 7.2 配置验证
- 验证 IP 地址格式
- 验证子网掩码
- 验证网关可达性
- 验证 DNS 服务器

### 7.3 状态同步
- 同步实际分配的 IP 地址
- 监控 IP 地址变化
- 处理 IP 地址冲突
- 提供 IP 地址查询接口

## 8. 面试要点

### 8.1 如何实现静态IP绑定？

**答案**:
- 通过 Cloud-Init 配置网络接口
- 通过 NMState 配置网络（更灵活）
- 在 VM 启动时应用配置
- 验证 IP 配置是否生效

### 8.2 如何防止IP地址冲突？

**答案**:
- 检查其他 VM 是否使用相同 IP
- 使用 IP 地址池管理
- 实现 IP 地址保留机制
- 提供 IP 地址查询接口

### 8.3 静态IP和DHCP的区别？

**答案**:
- **静态IP**: 固定 IP 地址，需要手动配置，适合需要固定 IP 的服务
- **DHCP**: 动态分配 IP，自动配置，适合不需要固定 IP 的场景

