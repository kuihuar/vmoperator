# 统一部署方案

## 1. 概述

通过主 Helm Chart 统一管理所有技术栈依赖，实现一键部署。

## 2. 主 Chart 结构

```
charts/novasphere-stack/
├── Chart.yaml              # 包含所有依赖
├── values.yaml             # 默认配置
├── values-dev.yaml         # 开发环境
├── values-prod.yaml        # 生产环境
└── templates/
    └── _helpers.tpl        # 辅助函数
```

## 3. Chart.yaml 配置

```yaml
apiVersion: v2
name: novasphere-stack
description: Complete Novasphere stack with all dependencies
type: application
version: 0.1.0
appVersion: "1.0.0"

dependencies:
  # Longhorn 存储
  - name: longhorn
    version: "1.8.1"
    repository: "https://charts.longhorn.io"
    condition: longhorn.enabled
  
  # KubeVirt 虚拟化
  - name: kubevirt
    version: "1.0.0"
    repository: "https://kubevirt.io/charts"
    condition: kubevirt.enabled
  
  # CDI 数据导入
  - name: cdi
    version: "1.57.0"
    repository: "https://kubevirt.io/charts"
    condition: cdi.enabled
  
  # Multus CNI（自定义 Chart）
  - name: multus
    version: "4.0.0"
    repository: "file://../multus"
    condition: multus.enabled
  
  # NMState Operator
  - name: nmstate-operator
    version: "0.73.0"
    repository: "https://nmstate.github.io/nmstate-operator"
    condition: nmstate.enabled
  
  # cert-manager（可选）
  - name: cert-manager
    version: "v1.13.0"
    repository: "https://charts.jetstack.io"
    condition: certManager.enabled
  
  # Novasphere Operator
  - name: novasphere
    version: "0.1.0"
    repository: "file://../novasphere"
    condition: novasphere.enabled
```

## 4. Values 配置

### 4.1 默认 Values
```yaml
# values.yaml
# 全局配置
global:
  namespace: novasphere-system

# Longhorn 配置
longhorn:
  enabled: true
  persistence:
    defaultDataPath: "/var/lib/longhorn"
  defaultSettings:
    disableRevisionCounter: "false"
    defaultReplicaCount: "3"

# KubeVirt 配置
kubevirt:
  enabled: true
  operator:
    replicas: 2
  featureGates:
    LiveMigration: true
    HotplugVolumes: true
    Snapshot: true
    Clone: true

# CDI 配置
cdi:
  enabled: true
  controller:
    replicas: 2
  config:
    dataVolume:
      defaultStorageClass: "longhorn"
      scratchStorageClass: "longhorn"

# Multus 配置
multus:
  enabled: true
  image:
    tag: "v4.0.0"
  cni:
    configDir: "/var/lib/rancher/k3s/agent/etc/cni/net.d"

# NMState 配置
nmstate:
  enabled: true
  operator:
    replicas: 2
  config:
    nodeSelector:
      node-type: compute

# cert-manager 配置
certManager:
  enabled: false  # 默认禁用
  installCRDs: true
  controller:
    replicas: 2

# Novasphere Operator 配置
novasphere:
  enabled: true
  image:
    repository: controller
    tag: latest
  webhook:
    enabled: true
    certManager:
      enabled: false  # 使用自签名证书
```

### 4.2 开发环境 Values
```yaml
# values-dev.yaml
longhorn:
  enabled: true
  persistence:
    defaultDataPath: "/var/lib/longhorn"

kubevirt:
  enabled: true
  featureGates:
    LiveMigration: false  # 开发环境禁用

cdi:
  enabled: true

multus:
  enabled: true

nmstate:
  enabled: true

certManager:
  enabled: false

novasphere:
  enabled: true
  webhook:
    enabled: false  # 开发环境禁用 Webhook
```

### 4.3 生产环境 Values
```yaml
# values-prod.yaml
longhorn:
  enabled: true
  persistence:
    defaultDataPath: "/data/longhorn"
  defaultSettings:
    defaultReplicaCount: "3"
    staleReplicaTimeout: "2880"

kubevirt:
  enabled: true
  operator:
    replicas: 2
  featureGates:
    LiveMigration: true
    HotplugVolumes: true
    Snapshot: true
    Clone: true

cdi:
  enabled: true
  controller:
    replicas: 2
  config:
    dataVolume:
      defaultStorageClass: "longhorn"

multus:
  enabled: true

nmstate:
  enabled: true
  operator:
    replicas: 2

certManager:
  enabled: true  # 生产环境启用
  controller:
    replicas: 2

novasphere:
  enabled: true
  image:
    repository: myregistry/novasphere
    tag: v1.0.0
  webhook:
    enabled: true
    certManager:
      enabled: true
```

## 5. 部署命令

### 5.1 开发环境
```bash
# 更新依赖
helm dependency update ./charts/novasphere-stack

# 部署
helm install novasphere-stack ./charts/novasphere-stack \
  -f ./charts/novasphere-stack/values-dev.yaml \
  --namespace novasphere-system \
  --create-namespace
```

### 5.2 生产环境
```bash
# 更新依赖
helm dependency update ./charts/novasphere-stack

# 部署
helm install novasphere-stack ./charts/novasphere-stack \
  -f ./charts/novasphere-stack/values-prod.yaml \
  --namespace novasphere-system \
  --create-namespace \
  --set novasphere.image.repository=myregistry/novasphere \
  --set novasphere.image.tag=v1.0.0
```

## 6. 部署流程

### 6.1 自动依赖解析
Helm 会自动按照依赖关系部署：
1. Longhorn（无依赖）
2. Multus（无依赖）
3. NMState（无依赖）
4. cert-manager（无依赖，可选）
5. KubeVirt（依赖存储）
6. CDI（依赖 KubeVirt）
7. Novasphere（依赖所有）

### 6.2 部署脚本
```bash
#!/bin/bash
# scripts/deploy-stack.sh

set -e

ENV=${1:-dev}
CHART_PATH="./charts/novasphere-stack"

echo "部署 Novasphere Stack (${ENV} 环境)..."

# 更新依赖
echo "更新 Helm 依赖..."
helm dependency update ${CHART_PATH}

# 选择 Values 文件
VALUES_FILE="${CHART_PATH}/values-${ENV}.yaml"
if [ ! -f "${VALUES_FILE}" ]; then
  VALUES_FILE="${CHART_PATH}/values.yaml"
fi

# 部署
echo "部署 Stack..."
helm upgrade --install novasphere-stack ${CHART_PATH} \
  -f ${VALUES_FILE} \
  --namespace novasphere-system \
  --create-namespace \
  --wait \
  --timeout 30m

echo "✅ 部署完成"
```

## 7. 升级策略

### 7.1 整体升级
```bash
# 升级所有组件
helm upgrade novasphere-stack ./charts/novasphere-stack \
  -f values-prod.yaml
```

### 7.2 部分升级
```bash
# 仅升级 Novasphere Operator
helm upgrade novasphere-stack ./charts/novasphere-stack \
  -f values-prod.yaml \
  --set novasphere.image.tag=v1.1.0 \
  --reuse-values
```

## 8. 验证部署

### 8.1 检查所有组件
```bash
#!/bin/bash
# scripts/verify-stack.sh

echo "验证 Novasphere Stack..."

# 检查 Longhorn
kubectl get pods -n longhorn-system | grep -q Running || echo "❌ Longhorn"

# 检查 KubeVirt
kubectl get pods -n kubevirt-system | grep -q Running || echo "❌ KubeVirt"

# 检查 CDI
kubectl get pods -n cdi-system | grep -q Running || echo "❌ CDI"

# 检查 Multus
kubectl get daemonset -n kube-system | grep -q multus || echo "❌ Multus"

# 检查 NMState
kubectl get pods -n nmstate-system | grep -q Running || echo "❌ NMState"

# 检查 Novasphere
kubectl get pods -n novasphere-system | grep -q Running || echo "❌ Novasphere"

echo "✅ 验证完成"
```

## 9. 卸载

### 9.1 完整卸载
```bash
# 卸载整个 Stack（注意：会删除所有数据）
helm uninstall novasphere-stack --namespace novasphere-system
```

### 9.2 部分卸载
```bash
# 禁用某个组件
helm upgrade novasphere-stack ./charts/novasphere-stack \
  -f values-prod.yaml \
  --set novasphere.enabled=false
```

## 10. 优势

### 10.1 统一管理
- ✅ 版本一致性
- ✅ 配置统一
- ✅ 依赖清晰

### 10.2 简化部署
- ✅ 一键部署
- ✅ 自动化依赖解析
- ✅ 环境隔离

### 10.3 易于维护
- ✅ 集中配置
- ✅ 统一升级
- ✅ 简化回滚

## 11. 注意事项

- 首次部署需要较长时间（下载镜像）
- 确保节点资源充足
- 生产环境建议分阶段部署
- 重要数据需要备份

