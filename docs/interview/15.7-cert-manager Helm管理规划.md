# cert-manager Helm 管理规划

## 1. 概述

cert-manager 用于自动管理 Kubernetes 中的 TLS 证书，可用于 Webhook 证书管理。

## 2. 官方 Helm Chart

### 2.1 Chart 信息
- **Repository**: `https://charts.jetstack.io`
- **Chart Name**: `cert-manager`
- **最新版本**: 1.13.0+

### 2.2 安装方式
```bash
# 添加仓库
helm repo add jetstack https://charts.jetstack.io
helm repo update

# 安装 cert-manager
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.13.0 \
  --set installCRDs=true
```

## 3. Values 配置

### 3.1 基础配置
```yaml
# values-cert-manager.yaml
# Controller 配置
controller:
  image:
    repository: quay.io/jetstack/cert-manager-controller
    tag: v1.13.0
  
  replicas: 1
  
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Webhook 配置
webhook:
  image:
    repository: quay.io/jetstack/cert-manager-webhook
    tag: v1.13.0
  
  replicas: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

# CA Injector 配置
cainjector:
  image:
    repository: quay.io/jetstack/cert-manager-cainjector
    tag: v1.13.0
  
  replicas: 1
  
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

# 功能配置
featureGates: ""

# 启动参数
extraArgs: []

# 节点选择器
nodeSelector: {}

# 容忍度
tolerations: []
```

### 3.2 生产环境配置
```yaml
# values-cert-manager-prod.yaml
controller:
  replicas: 2
  resources:
    limits:
      cpu: 2000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 256Mi

webhook:
  replicas: 2
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

cainjector:
  replicas: 2
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

# 高可用配置
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - cert-manager
        topologyKey: kubernetes.io/hostname
```

## 4. 部署命令

### 4.1 开发环境
```bash
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.13.0 \
  --set installCRDs=true
```

### 4.2 生产环境
```bash
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.13.0 \
  --set installCRDs=true \
  -f values-cert-manager-prod.yaml
```

## 5. 验证安装

```bash
# 检查 Pod 状态
kubectl get pods -n cert-manager

# 检查 CRD
kubectl get crd | grep cert-manager.io

# 检查版本
kubectl get deployment cert-manager -n cert-manager -o jsonpath='{.spec.template.spec.containers[0].image}'
```

## 6. 配置 Issuer/ClusterIssuer

### 6.1 自签名 Issuer
```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}
```

### 6.2 Let's Encrypt Issuer
```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: traefik
```

## 7. 为 Webhook 配置证书

在 Novasphere Chart 中配置：

```yaml
# values.yaml
webhook:
  enabled: true
  certManager:
    enabled: true
    issuer:
      name: selfsigned-issuer
      kind: ClusterIssuer
```

## 8. 升级

```bash
# 升级 cert-manager
helm upgrade cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --version v1.14.0 \
  -f values-cert-manager-prod.yaml
```

## 9. 卸载

```bash
# 卸载 cert-manager
helm uninstall cert-manager --namespace cert-manager
```

## 10. 集成到主 Chart

在主 Chart 的 `Chart.yaml` 中添加依赖：

```yaml
dependencies:
  - name: cert-manager
    version: "v1.13.0"
    repository: "https://charts.jetstack.io"
    condition: certManager.enabled
```

在 `values.yaml` 中配置：

```yaml
certManager:
  enabled: true
  installCRDs: true
  controller:
    replicas: 2
```

## 11. 依赖关系

- **依赖**: 无（独立组件）
- **被依赖**: Novasphere Operator（Webhook 证书）

**部署顺序**:
1. cert-manager（如果使用）
2. Novasphere Operator

