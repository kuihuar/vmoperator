# 网关流式数据代理详解

## 1. 概述

API Gateway（Kong 和 Traefik）**完全支持流式数据代理**，包括 SSE、WebSocket 和流式 HTTP 响应。

## 2. Kong 流式数据支持

### 2.1 SSE 支持

**Kong 原生支持 SSE**，无需特殊配置：

```yaml
# config/gateway/kong/kong-config.yaml
services:
- name: novasphere-api
  url: http://novasphere-api.novasphere-system.svc.cluster.local:8080
  routes:
  - name: novasphere-api-route
    paths:
    - /api/v1
    strip_path: false  # 重要：保留路径
```

**关键配置**：
- ✅ `strip_path: false` - 保留完整路径
- ✅ 自动处理 `Transfer-Encoding: chunked`
- ✅ 自动处理 `Content-Type: text/event-stream`
- ✅ 无需特殊插件

### 2.2 WebSocket 支持

**Kong 支持 WebSocket**，需要配置协议：

```yaml
services:
- name: novasphere-api
  url: http://novasphere-api:8080
  routes:
  - name: novasphere-ws-route
    paths:
    - /ws
    protocols:
    - http
    - https
```

**WebSocket 插件**（可选，用于高级功能）：

```yaml
plugins:
- name: websocket
  service: novasphere-api
  config:
    # WebSocket 特定配置
```

### 2.3 流式 HTTP 响应

**Kong 自动支持流式 HTTP**：

```yaml
services:
- name: novasphere-api
  url: http://novasphere-api:8080
  connect_timeout: 60000    # 连接超时（毫秒）
  write_timeout: 60000      # 写入超时（毫秒）
  read_timeout: 60000       # 读取超时（毫秒）
```

### 2.4 禁用缓冲（重要）

确保 Kong 不缓冲响应：

```yaml
# 在 Route 上配置
routes:
- name: novasphere-stream-route
  paths:
  - /api/v1/stream
  # Kong 默认不缓冲，但可以显式配置
  plugins:
  - name: response-transformer
    config:
      remove:
        headers:
        - "X-Accel-Buffering"  # 移除 Nginx 缓冲头
```

## 3. Traefik 流式数据支持

### 3.1 SSE 支持

**Traefik 原生支持 SSE**，无需特殊配置：

```yaml
# config/gateway/traefik/ingressroute.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-api
spec:
  entryPoints:
  - web
  - websecure
  routes:
  - match: Host(`api.novasphere.io`) && PathPrefix(`/api/v1`)
    kind: Rule
    services:
    - name: novasphere-api
      port: 8080
    # SSE 自动支持，无需额外配置
```

### 3.2 WebSocket 支持

**Traefik 支持 WebSocket**，需要配置：

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-ws
  annotations:
    traefik.ingress.kubernetes.io/websocket-services: novasphere-api
spec:
  entryPoints:
  - websecure
  routes:
  - match: Host(`api.novasphere.io`) && PathPrefix(`/ws`)
    kind: Rule
    services:
    - name: novasphere-api
      port: 8080
```

**或使用中间件**：

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: websocket-headers
spec:
  headers:
    customRequestHeaders:
      Connection: "Upgrade"
      Upgrade: "websocket"
```

### 3.3 流式 HTTP 响应

**Traefik 自动支持流式 HTTP**：

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-api
spec:
  routes:
  - match: Host(`api.novasphere.io`)
    services:
    - name: novasphere-api
      port: 8080
      responseForwarding:
        flushInterval: 100ms  # 刷新间隔，实现流式传输
```

### 3.4 禁用缓冲

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-api
  annotations:
    traefik.ingress.kubernetes.io/buffering: "false"  # 禁用缓冲
spec:
  # ...
```

## 4. 配置对比

### 4.1 SSE 配置

| 网关 | 是否需要特殊配置 | 说明 |
|------|----------------|------|
| **Kong** | ❌ 不需要 | 自动支持，确保 `strip_path: false` |
| **Traefik** | ❌ 不需要 | 自动支持，无需额外配置 |

### 4.2 WebSocket 配置

| 网关 | 配置方式 | 说明 |
|------|---------|------|
| **Kong** | 配置 `protocols: [http, https]` | 支持协议升级 |
| **Traefik** | 使用注解或中间件 | `websocket-services` 注解 |

### 4.3 流式 HTTP 配置

| 网关 | 配置方式 | 说明 |
|------|---------|------|
| **Kong** | 配置超时时间 | `read_timeout`, `write_timeout` |
| **Traefik** | 配置 `flushInterval` | 响应转发刷新间隔 |

## 5. 完整配置示例

### 5.1 Kong 完整配置

```yaml
# config/gateway/kong/kong-config.yaml
_format_version: "3.0"

services:
- name: novasphere-api
  url: http://novasphere-api.novasphere-system.svc.cluster.local:8080
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
  routes:
  # RESTful API
  - name: novasphere-api-route
    paths:
    - /api/v1
    strip_path: false
    protocols:
    - http
    - https
  # WebSocket
  - name: novasphere-ws-route
    paths:
    - /ws
    strip_path: false
    protocols:
    - http
    - https

plugins:
- name: cors
  service: novasphere-api
  config:
    origins:
    - "*"
    methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
    headers:
    - Authorization
    - Content-Type
    credentials: true
```

### 5.2 Traefik 完整配置

```yaml
# config/gateway/traefik/ingressroute.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-api
  namespace: novasphere-system
spec:
  entryPoints:
  - web
  - websecure
  routes:
  # RESTful API
  - match: Host(`api.novasphere.io`) && PathPrefix(`/api/v1`)
    kind: Rule
    services:
    - name: novasphere-api
      port: 8080
      responseForwarding:
        flushInterval: 100ms
    middlewares:
    - name: cors
    - name: rate-limit
  # WebSocket
  - match: Host(`api.novasphere.io`) && PathPrefix(`/ws`)
    kind: Rule
    services:
    - name: novasphere-api
      port: 8080
  tls:
    certResolver: letsencrypt
---
# WebSocket 注解方式
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: novasphere-ws
  namespace: novasphere-system
  annotations:
    traefik.ingress.kubernetes.io/websocket-services: novasphere-api
spec:
  entryPoints:
  - websecure
  routes:
  - match: Host(`api.novasphere.io`) && PathPrefix(`/ws`)
    kind: Rule
    services:
    - name: novasphere-api
      port: 8080
```

## 6. 测试验证

### 6.1 测试 SSE

```bash
# 通过 Kong 测试
curl -N -H "Host: api.novasphere.io" \
  -H "Authorization: Bearer $TOKEN" \
  http://kong-proxy:8000/api/v1/wukongs/test/stream

# 通过 Traefik 测试
curl -N -H "Host: api.novasphere.io" \
  -H "Authorization: Bearer $TOKEN" \
  http://traefik/api/v1/wukongs/test/stream
```

### 6.2 测试 WebSocket

```bash
# 使用 wscat 测试（通过 Kong）
wscat -c ws://api.novasphere.io/ws/wukong/test \
  -H "Authorization: Bearer $TOKEN"

# 使用 wscat 测试（通过 Traefik）
wscat -c wss://api.novasphere.io/ws/wukong/test \
  -H "Authorization: Bearer $TOKEN"
```

### 6.3 验证流式传输

```bash
# 检查响应头
curl -I -H "Host: api.novasphere.io" \
  http://kong-proxy:8000/api/v1/wukongs/test/stream

# 应该看到：
# Transfer-Encoding: chunked
# Content-Type: text/event-stream
# Connection: keep-alive
```

## 7. 常见问题

### 7.1 数据被缓冲

**问题**：流式数据被网关缓冲，无法实时传输。

**解决**：
- **Kong**：确保 `strip_path: false`，检查超时配置
- **Traefik**：设置 `buffering: false`，配置 `flushInterval`

### 7.2 WebSocket 连接失败

**问题**：WebSocket 连接无法建立。

**解决**：
- **Kong**：确保配置 `protocols: [http, https]`
- **Traefik**：使用 `websocket-services` 注解

### 7.3 超时断开

**问题**：长时间流式连接被断开。

**解决**：
- **Kong**：增加 `read_timeout` 和 `write_timeout`
- **Traefik**：配置合适的超时时间

## 8. 性能优化

### 8.1 Kong 优化

```yaml
services:
- name: novasphere-api
  url: http://novasphere-api:8080
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
  retries: 0  # 流式数据不重试
```

### 8.2 Traefik 优化

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
spec:
  routes:
  - services:
    - name: novasphere-api
      port: 8080
      responseForwarding:
        flushInterval: 50ms  # 更短的刷新间隔，更快响应
```

## 9. 总结

### 9.1 支持情况

- ✅ **Kong**：完全支持 SSE、WebSocket、流式 HTTP
- ✅ **Traefik**：完全支持 SSE、WebSocket、流式 HTTP
- ✅ **无需特殊插件**：SSE 和流式 HTTP 自动支持
- ✅ **WebSocket**：需要简单配置

### 9.2 关键配置

- **Kong**：`strip_path: false`，配置超时时间
- **Traefik**：`flushInterval`，`buffering: false`
- **WebSocket**：协议配置或注解

### 9.3 最佳实践

- ✅ 禁用响应缓冲
- ✅ 配置合适的超时时间
- ✅ 测试流式数据传输
- ✅ 监控连接状态

