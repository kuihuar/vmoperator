# Cloud-Init 配置详解

## 1. Cloud-Init 概述

Cloud-Init 是虚拟机初始化工具，用于在首次启动时自动配置系统。

### 1.1 功能

- **用户创建**: 自动创建用户并设置密码
- **SSH 密钥配置**: 配置 SSH 公钥
- **网络配置**: 配置静态 IP、网关、DNS
- **软件安装**: 安装软件包（可选）

### 1.2 在项目中的使用

VM Operator 通过 `buildCloudInitData` 函数生成 Cloud-Init 用户数据，并作为 `cloudInitNoCloud` volume 挂载到 VM。

## 2. buildCloudInitData 函数

### 2.1 函数签名

```go
func buildCloudInitData(ctx context.Context, c client.Client, vmp *vmv1alpha1.Wukong) string
```

### 2.2 触发条件

```go
if vmp.Spec.OSImage != "" || vmp.Spec.SSHKeySecret != "" || vmp.Spec.CloudInitUser != nil {
    cloudInitData := buildCloudInitData(ctx, c, vmp)
    // 添加到 VM volumes
}
```

**说明**: 只要配置了其中任意一项，就会生成 Cloud-Init 数据

## 3. 用户配置

### 3.1 用户创建

```go
if vmp.Spec.CloudInitUser != nil {
    user := vmp.Spec.CloudInitUser
    cloudInit += "users:\n"
    cloudInit += fmt.Sprintf("  - name: %s\n", user.Name)
}
```

### 3.2 密码配置

```go
// 优先使用密码哈希
if user.PasswordHash != "" {
    cloudInit += fmt.Sprintf("    passwd: %s\n", user.PasswordHash)
} else if user.Password != "" {
    // 明文密码（不推荐，可能不工作）
    cloudInit += fmt.Sprintf("    passwd: %s\n", user.Password)
}
```

**重要提示**:
- Cloud-Init 的 `passwd` 字段需要密码哈希格式（如 `$6$...`）
- 明文密码可能不会工作
- 推荐使用 `passwordHash`

**生成密码哈希**:
```bash
# 方法 1: openssl
openssl passwd -1 mypassword

# 方法 2: Python
python3 -c "import crypt; print(crypt.crypt('mypassword', crypt.mksalt(crypt.METHOD_SHA512)))"
```

### 3.3 Sudo 配置

```go
if user.Sudo != "" {
    cloudInit += fmt.Sprintf("    sudo: %s\n", user.Sudo)
} else {
    cloudInit += "    sudo: ALL=(ALL) NOPASSWD:ALL\n"  // 默认值
}
```

### 3.4 Shell 配置

```go
if user.Shell != "" {
    cloudInit += fmt.Sprintf("    shell: %s\n", user.Shell)
} else {
    cloudInit += "    shell: /bin/bash\n"  // 默认值
}
```

### 3.5 用户组配置

```go
if len(user.Groups) > 0 {
    cloudInit += "    groups:\n"
    for _, group := range user.Groups {
        cloudInit += fmt.Sprintf("      - %s\n", group)
    }
} else {
    // 默认 groups
    cloudInit += "    groups: sudo, adm, dialout, cdrom, floppy, audio, dip, video, plugdev, netdev\n"
}
```

## 4. SSH 密钥配置

### 4.1 从 Secret 读取

```go
if vmp.Spec.SSHKeySecret != "" {
    secret := &corev1.Secret{}
    key := client.ObjectKey{Namespace: vmp.Namespace, Name: vmp.Spec.SSHKeySecret}
    if err := c.Get(ctx, key, secret); err == nil {
        // 查找 SSH 公钥
    }
}
```

### 4.2 查找密钥字段

```go
// 尝试常见的密钥字段名
for _, keyName := range []string{"ssh-publickey", "id_rsa.pub", "authorized_keys", "publickey"} {
    if val, ok := secret.Data[keyName]; ok {
        sshKey = val
        break
    }
}

// 如果没找到，使用第一个非空值
if len(sshKey) == 0 {
    for _, val := range secret.Data {
        if len(val) > 0 {
            sshKey = val
            break
        }
    }
}
```

### 4.3 添加到 Cloud-Init

```go
if len(sshKey) > 0 {
    cloudInit += "\nssh_authorized_keys:\n"
    keys := strings.Split(string(sshKey), "\n")
    for _, key := range keys {
        key = strings.TrimSpace(key)
        if key != "" && !strings.HasPrefix(key, "#") {
            cloudInit += fmt.Sprintf("  - %s\n", key)
        }
    }
}
```

## 5. 网络配置

### 5.1 静态 IP 配置

```go
for _, net := range vmp.Spec.Networks {
    if net.IPConfig != nil && net.IPConfig.Mode == "static" && net.IPConfig.Address != nil {
        if !hasNetworkConfig {
            cloudInit += "\nnetwork:\n"
            cloudInit += "  version: 2\n"
            cloudInit += "  ethernets:\n"
            hasNetworkConfig = true
        }
        cloudInit += fmt.Sprintf("    %s:\n", net.Name)
        cloudInit += "      addresses:\n"
        cloudInit += fmt.Sprintf("        - %s\n", *net.IPConfig.Address)
    }
}
```

### 5.2 网关配置

```go
if net.IPConfig.Gateway != nil {
    cloudInit += fmt.Sprintf("      gateway4: %s\n", *net.IPConfig.Gateway)
}
```

### 5.3 DNS 配置

```go
if len(net.IPConfig.DNSServers) > 0 {
    cloudInit += "      nameservers:\n"
    cloudInit += "        addresses:\n"
    for _, dns := range net.IPConfig.DNSServers {
        cloudInit += fmt.Sprintf("          - %s\n", dns)
    }
}
```

## 6. Cloud-Init 数据格式

### 6.1 完整示例

```yaml
#cloud-config
users:
  - name: admin
    passwd: $6$...
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: sudo, adm
    lock_passwd: false

ssh_pwauth: true
disable_root: false

ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ...

network:
  version: 2
  ethernets:
    mgmt:
      addresses:
        - 192.168.100.10/24
      gateway4: 192.168.100.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```

## 7. Volume 挂载

### 7.1 cloudInitNoCloud Volume

```go
cloudInitVolume := kubevirtv1.Volume{
    Name: "cloudinitdisk",
    VolumeSource: kubevirtv1.VolumeSource{
        CloudInitNoCloud: &kubevirtv1.CloudInitNoCloudSource{
            UserData: cloudInitData,
        },
    },
}
template.Spec.Volumes = append(template.Spec.Volumes, cloudInitVolume)
```

**说明**: Cloud-Init 数据作为 `cloudinitdisk` volume 挂载到 VM

## 8. 使用示例

### 8.1 完整配置

```yaml
spec:
  cloudInitUser:
    name: admin
    passwordHash: "$6$..."
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    shell: /bin/bash
    groups:
      - sudo
      - docker
  sshKeySecret: my-ssh-keys
  networks:
    - name: mgmt
      type: bridge
      ipConfig:
        mode: static
        address: 192.168.100.10/24
        gateway: 192.168.100.1
        dnsServers:
          - 8.8.8.8
```

## 9. 面试要点

### 9.1 Cloud-Init 的工作原理？

**答案**:
- Cloud-Init 在 VM 首次启动时运行
- 读取挂载的 `cloudinitdisk` volume
- 解析 YAML 格式的用户数据
- 执行配置操作（创建用户、配置网络等）

### 9.2 为什么推荐使用 passwordHash？

**答案**:
- Cloud-Init 的 `passwd` 字段需要密码哈希格式
- 明文密码可能不会工作
- 使用哈希更安全

### 9.3 SSH 密钥的查找逻辑？

**答案**:
1. 尝试常见的密钥字段名（ssh-publickey, id_rsa.pub 等）
2. 如果没找到，使用 Secret 中第一个非空值
3. 支持多行密钥（按行分割）

### 9.4 网络配置的格式？

**答案**:
- 使用 Cloud-Init 的 `network` 配置（version 2）
- 支持静态 IP、网关、DNS
- 配置格式为 YAML

