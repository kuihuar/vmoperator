# 基础运维功能总览

## 1. 功能概述

基础运维功能是 VM 生命周期管理的核心功能，包括启动、关机、重启、挂起、恢复、删除等操作。

## 2. 功能列表

| 功能 | 优先级 | 复杂度 | 业务价值 | 当前状态 |
|------|--------|--------|----------|----------|
| **启动** | 高 | 低 | 高 | 部分实现 |
| **关机** | 高 | 低 | 高 | 待实现 |
| **重启** | 高 | 中 | 高 | 待实现 |
| **挂起** | 中 | 中 | 中 | 待实现 |
| **恢复** | 中 | 中 | 中 | 待实现 |
| **删除** | 高 | 低 | 高 | 部分实现 |

## 3. 当前实现状态

### 3.1 已实现
- ✅ **创建时自动启动**: 通过 `StartStrategy.AutoStart` 控制
- ✅ **删除**: 通过 Finalizer 实现资源清理
- ✅ **RunStrategy**: 支持 `Always`, `RerunOnFailure`, `Manual`

### 3.2 待实现
- ❌ **手动启动**: 通过 API 启动已停止的 VM
- ❌ **关机**: 优雅关闭 VM
- ❌ **强制关机**: 强制停止 VM
- ❌ **重启**: 重启运行中的 VM
- ❌ **挂起**: 暂停 VM 运行状态
- ❌ **恢复**: 从挂起状态恢复
- ❌ **状态查询**: 查询 VM 运行状态

## 4. 技术实现方式

### 4.1 KubeVirt 原生支持

KubeVirt 提供以下方式控制 VM 生命周期：

#### VirtualMachine API
```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachine
spec:
  running: true  # 控制是否运行
```

#### VirtualMachineInstance API
```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
# 直接操作 VMI 实例
```

#### Subresource API
```bash
# 启动
kubectl virt start <vm-name>

# 停止
kubectl virt stop <vm-name>

# 重启
kubectl virt restart <vm-name>
```

### 4.2 实现方案

#### 方案一：通过 VirtualMachine running 字段
- 修改 `VirtualMachine.spec.running` 字段
- KubeVirt Controller 自动处理
- 适合启动/停止操作

#### 方案二：通过 VirtualMachineInstance 操作
- 直接操作 VMI 资源
- 适合挂起/恢复操作
- 需要处理 VMI 生命周期

#### 方案三：通过 Subresource API
- 使用 KubeVirt 的 subresource endpoints
- 需要实现 HTTP 客户端
- 适合所有操作

## 5. API 设计

### 5.1 WukongSpec 扩展

```go
// api/v1alpha1/wukong_types.go

type WukongSpec struct {
    // ... 现有字段 ...
    
    // LifecycleAction 生命周期操作（可选）
    // +optional
    LifecycleAction *LifecycleActionSpec `json:"lifecycleAction,omitempty"`
}

type LifecycleActionSpec struct {
    // Action 操作类型: start, stop, restart, suspend, resume
    Action string `json:"action"`
    
    // Force 是否强制操作（用于 stop/restart）
    // +optional
    Force bool `json:"force,omitempty"`
    
    // GracePeriodSeconds 优雅关闭等待时间（秒）
    // +optional
    GracePeriodSeconds *int64 `json:"gracePeriodSeconds,omitempty"`
}
```

### 5.2 Status 扩展

```go
// api/v1alpha1/wukong_types.go

type WukongStatus struct {
    // ... 现有字段 ...
    
    // LifecycleState 生命周期状态
    // +optional
    LifecycleState *LifecycleState `json:"lifecycleState,omitempty"`
}

type LifecycleState struct {
    // State 当前状态: Starting, Running, Stopping, Stopped, Restarting, Suspended
    State string `json:"state"`
    
    // LastAction 最后执行的操作
    // +optional
    LastAction string `json:"lastAction,omitempty"`
    
    // LastActionTime 最后操作时间
    // +optional
    LastActionTime metav1.Time `json:"lastActionTime,omitempty"`
    
    // Message 状态消息
    // +optional
    Message string `json:"message,omitempty"`
}
```

## 6. 功能分类

### 6.1 启动/停止类
- **启动**: 启动已停止的 VM
- **关机**: 优雅关闭 VM
- **强制关机**: 强制停止 VM

### 6.2 状态管理类
- **重启**: 重启运行中的 VM
- **挂起**: 暂停 VM（保存状态到内存）
- **恢复**: 从挂起状态恢复

### 6.3 生命周期类
- **删除**: 删除 VM 及相关资源
- **状态查询**: 查询 VM 当前状态

## 7. 实现优先级

### 第一阶段（核心功能）
1. **启动功能** - 手动启动已停止的 VM
2. **关机功能** - 优雅关闭 VM
3. **状态查询** - 查询 VM 运行状态

### 第二阶段（增强功能）
4. **重启功能** - 重启运行中的 VM
5. **强制关机** - 强制停止 VM

### 第三阶段（高级特性）
6. **挂起功能** - 暂停 VM
7. **恢复功能** - 从挂起恢复

## 8. 文档结构

- **[13.7.1-启动与关机.md](./13.7.1-启动与关机.md)** - 启动和关机功能详解
- **[13.7.2-重启功能.md](./13.7.2-重启功能.md)** - 重启功能详解
- **[13.7.3-挂起与恢复.md](./13.7.3-挂起与恢复.md)** - 挂起和恢复功能详解
- **[13.7.4-删除功能.md](./13.7.4-删除功能.md)** - 删除功能详解

## 9. 使用示例

### 9.1 启动 VM
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  lifecycleAction:
    action: start
```

### 9.2 关机 VM
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  lifecycleAction:
    action: stop
    gracePeriodSeconds: 30
```

### 9.3 重启 VM
```yaml
apiVersion: vm.novasphere.dev/v1alpha1
kind: Wukong
metadata:
  name: my-vm
spec:
  lifecycleAction:
    action: restart
    force: false
```

## 10. 面试要点

### 10.1 为什么需要这些基础运维功能？

**答案**:
- **日常管理**: 运维人员需要启动、停止、重启 VM
- **资源优化**: 根据需求动态调整 VM 状态
- **故障处理**: 重启可以解决部分问题
- **成本控制**: 停止不用的 VM 节省资源

### 10.2 优雅关闭和强制关闭的区别？

**答案**:
- **优雅关闭**: 发送关机信号，等待应用正常退出，数据安全
- **强制关闭**: 直接停止，可能导致数据丢失，但速度快

### 10.3 如何实现优雅关闭？

**答案**:
- 使用 ACPI 关机信号
- 设置 GracePeriodSeconds 等待时间
- 监控 VM 状态直到完全停止
- 超时后强制关闭

